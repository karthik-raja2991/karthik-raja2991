Option Explicit
Public Const PSFCONNECTIONSTR = "QTP Connection to PSF"
Public Const PSFCONNECTIONSTRFNREG = "QTP Connection to PSF"
Public Const PSFCONNECTIONSTRFNQA = "QTP Connection to PSFQA"
Public Const PSFCONNECTIONSTRFNTST = "QTP Connection to PSFTST"
Public Const PSFCONNECTIONSTRFNRVTST = "QTP Connection to PSFNRVTST"
Public Const sODBCCONNECTION="QTP Connection to AS400"
Public const dbName_FNREG = "FNREG"
Public const dbName_FNQA = "FNQA"
Public const dbName_FNTST = "FNTST"
Public const dbName_FNRVTST = "FNRVTST"
Public const dbPWDVM  = "Quality2"

''' <summary>PSF_Database library contains functions defined for various PSFin queries.</summary>
'''<para>Library created by Venu Arigela</para> 
''' Do NOT MODIFY without permission
'Change log
'#############################################################################################################


'**************************************************************************************************************
''' <summary> 
''' dbFetchVendor is helper component to retreive the employee records from PS_VENDOR_PAY file
''' </summary>
''' <author>Jolly</author>
''' <datecreated>21-Oct-2014</datecreated>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>NA</endstate>
''' <returns type="Number">0 if no records found, else record count</returns>
'Change Control: 
'Date of Change 	Author 		Description of change

'________________________________________________

Public Function dbFetchVendor()
	Dim sSQL
	Dim arrRecordValues()
	'Assigning SQL
	  sSQL = "SELECT A.VENDOR_ID FROM PS_VENDOR_PAY A WHERE A.EFF_STATUS = 'A' AND A.PYMNT_METHOD = 'CHK' AND A.PYMNT_GROUP_CD IN ('03','04') AND A.PYMNT_HOLD = 'N' AND A.VENDOR_ID NOT LIKE 'REB%' AND A.VENDOR_ID NOT LIKE 'BID%' AND A.EFFDT = (SELECT MAX(VP.EFFDT) FROM PS_VENDOR_PAY VP WHERE A.VENDOR_ID = VP.VENDOR_ID) ORDER BY A.VENDOR_ID"

	'Retrieveing records
	dbFetchVendor = dbGetResultArrayIncNULL(sSQL, PSFCONNECTIONSTR, arrRecordValues, "")
End Function


'**************************************************************************************************************
''' <summary> 
''' dbFetchVendor is helper component to retreive the employee records from PS_PAYMENT_TBL file
''' </summary>
''' <author>Jolly</author>
''' <datecreated>21-Oct-2014</datecreated>
''' <param name="sVendor" type="string">Vendor id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>NA</endstate>
''' <returns type="Number">0 if no records found, else record count</returns>
'Change Control: 
'Date of Change 	Author 		Description of change

'________________________________________________
Public Function dbFetchPaymentDetails(sVendor)
	Dim sSQL
	Dim arrRecordValues()
	'Assigning SQL
	  sSQL = "SELECT BANK_CD, PYMNT_ID_REF, PYMNT_METHOD, BANK_ACCT_KEY FROM PS_PAYMENT_TBL WHERE REMIT_VENDOR = '"& sVendor &"' AND PYMNT_DT = CONVERT (date, GETDATE()))"

	'Retrieveing records
	dbFetchPaymentDetails = dbGetResultArrayIncNULL(sSQL, PSFCONNECTIONSTR, arrRecordValues, "")
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchMatchInvoice is helper component to retreive the invoice records
''' </summary>
''' <author>Jolly</author>
''' <datecreated>21-Oct-2015</datecreated>
''' <param name="sVendor" type="string">Vendor id </param>
''' <param name="sStartfromdate" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>NA</endstate>
''' <returns type="Number">0 if no records found, else record count</returns>
'Change Control: 
'Date of Change 	Author 		Description of change

'________________________________________________
Public Function dbFetchMatchInvoice(sVendor , sStartfromdate)
	Dim sSQL
	Dim arrRecordValues()
	'Assigning SQL
	  sSQL = "SELECT A.INVOICE_ID FROM PS_VOUCHER A WHERE ( A.BUSINESS_UNIT = '00010'  AND A.VENDOR_ID = '" & sVendor & "' AND A.MATCH_STATUS_VCHR = 'M' AND A.POST_STATUS_AP = 'P' AND A.INVOICE_DT > '"& sStartfromdate &"' ) "
	 WriteToReport micDone, "Fetch Match Invoice", "SQL:" & sSQL , false
	'Retrieveing records
	dbFetchMatchInvoice = dbGetResultValue("INVOICE_ID", sSQL, PSFCONNECTIONSTR)
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchVendor is helper component to retreive the employee records from PS_VENDOR_PAY file
''' </summary>
''' <author>Jolly</author>
''' <datecreated>21-Oct-2014</datecreated>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>NA</endstate>
''' <returns type="Number">0 if no records found, else record count</returns>
'Change Control: 
'Date of Change 	Author 		Description of change

'________________________________________________
Public Function dbFetchOpenPeriodFrom(sProduct , sBusinessUnit, sLedgerGRoup)
	Dim sSQL
	Dim arrRecordValues()
	'Assigning SQL
	 ' sSQL = "SELECT A.VENDOR_ID FROM PS_VENDOR_PAY A WHERE A.EFF_STATUS = 'A' AND A.PYMNT_METHOD = 'CHK' AND A.PYMNT_GROUP_CD IN ('03','04') AND A.PYMNT_HOLD = 'N' AND A.VENDOR_ID NOT LIKE 'REB%' AND A.VENDOR_ID NOT LIKE 'BID%' AND A.EFFDT = (SELECT MAX(VP.EFFDT) FROM PS_VENDOR_PAY VP WHERE A.VENDOR_ID = VP.VENDOR_ID) ORDER BY A.VENDOR_ID"
	 sSQL = "select OPEN_PERIOD_FROM from PS_FIN_OPEN_PERIOD WHERE PSFT_PRODUCT = '" &sProduct & "' and BUSINESS_UNIT = '" & sBusinessUnit &"' and LEDGER_GROUP = '"& sLedgerGRoup &"'"
	'Retrieveing records
	dbFetchOpenPeriodFrom = dbGetResultValue("OPEN_PERIOD_FROM", sSQL, PSFCONNECTIONSTR)
	'dbGetResultArrayIncNULL(sSQL, PSFCONNECTIONSTR, arrRecordValues, "")
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchCustomerInfo is helper component to retreive the employee records from PS_PAYMENT_TBL file
''' </summary>
''' <author>Venu Arigela</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <param name="unit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
''' <returns type="Number">0 if no records found, else record count</returns>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchCustomerInfo(unit)
	Dim sSQL
	Dim arrRecordValues()

	'    sSQL = "SELECT DISTINCT A.BUSINESS_UNIT, A.CUST_ID, B.SUPPORT_TEAM_CD, A.BAL_AMT,A.SALES_PERSON from PS_ITEM A, PS_CUST_TEAM B WHERE A.BUSINESS_UNIT ='" & unit & "' AND A.CUST_ID = B.CUST_ID AND A.BAL_AMT <> 0 " & _
	'     "AND A.CUST_ID IN (SELECT CUST_ID FROM PS_CUST_CONTACT) " & _
	'    "ORDER BY A.BUSINESS_UNIT, A.CUST_ID, A.BAL_AMT" 
	'' As per rini new query 06/17
	sSQL = "SELECT A.BUSINESS_UNIT, A.CUST_ID, B.SUPPORT_TEAM_CD, A.BAL_AMT, C.NAME1 AS CONTACT_NAME " & _
    	"from PS_ITEM A, PS_CUST_TEAM B, PS_CUST_CONTACT C, PS_CUSTOMER D " & _
       	"WHERE A.BUSINESS_UNIT = '" & unit & "' AND A.CUST_ID = B.CUST_ID AND A.CUST_ID = C.CUST_ID AND A.CUST_ID = D.CUST_ID AND A.BAL_AMT <> 0 AND D.CUST_STATUS = 'A' " & _
       	"AND C.EFF_STATUS = 'A' " & _
       	"ORDER BY " & _ 
       	"A.BUSINESS_UNIT, A.CUST_ID, A.BAL_AMT "
    WriteToReport micPass, "SQL query for Customer", "Query used for customer info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbFetchCustomerInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer_Info_" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then
 		dbFetchCustomerInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer_Info_" & unit)
 	ElseIf strComp (GlobalDictionary("Environment"),"FNRVTST") = 0 Then
	    dbFetchCustomerInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues, "Customer_Info_" & unit)
  	Else
	    dbFetchCustomerInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer_Info_" & unit)   	  
	End If
End Function

Public Function getDBEnv()
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchCreditHoldDisabled is helper component to retreive the employee records from PS_PAYMENT_TBL file
''' </summary>
''' <author>Venu Arigela</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
''' <returns type="Number">0 if no records found, else record count</returns>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchCreditHoldDisabled()	
	Dim sSQL
	Dim arrRecordValues()

	sSQL = "SELECT * FROM PS_CUST_CREDIT WHERE AGING_CATEGORY <> '"&""&"' OR AGING_ID <> '"&""&"' "
	dbFetchCreditHoldDisabled = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues,"Credit_Hold")
End Function
'**************************************************************************************************************

'**************************************************************************************************************

'**************************************************************************************************************
''' <summary> 
''' dbFetchInvoiceProperties is helper component to retreive the sigle column records from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <param name="businessUnit" type="string">Business unit id </param>
''' <param name="invoiceID" type="string">Invoice id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchInvoiceProperties(businessUnit, invoiceID)
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "SELECT B.IDENTIFIER,B.QTY,B.IDENTIFIER_TBL,B.SHIP_TO_CUST_ID AS SHIP_TO,B.SHIP_TO_ADDR_NUM AS SHIP_TO_LOC " & _
	"FROM PS_BI_HDR A " & _
	"JOIN PS_BI_LINE B ON A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.INVOICE = B.INVOICE " & _
	"WHERE A.BUSINESS_UNIT = '" & businessUnit & "' AND A.INVOICE = '" & invoiceID & "' " & _
	"ORDER BY A.INVOICE"
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbFetchInvoiceProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer_Info_" & businessUnit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then
		dbFetchInvoiceProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer_Info_" & businessUnit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNRVTST") = 0 Then
		dbFetchInvoiceProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues, "Customer_Info_" & businessUnit)
	Else
		dbFetchInvoiceProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer_Info_" & businessUnit)   	  
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetFirstRecord is helper component to retreive the customer info record from PS_ITEM table
''' </summary>
''' <author>Venu Arigela</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <param name="strSQL" type="string">query string</param>
''' <param name="sConnectionString" type="string">connection string</param>
''' <param name="arrRecordValues" type="arrRecordValues">array for results</param>
''' <param name="sheetName" type="sResultReportFlag">sheet name to create in DT</param>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
''' <returns type="Number">0 if no records found, else record count</returns>
'Change Control: 
'Date of Change 	Author Venu arigela		Description of change
Public Function dbGetFirstRecord(strSQL, sConnectionString, arrRecordValues, sheetName)
	Dim dBRecSet, objConnection, connectionString, databaseName
	Dim intLoop, iArrayNo, nRecordCount, sOneRecord, nReportValue
	Dim sTemp, i, j, fields

	If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
		connectionString = PSFCONNECTIONSTRFNQA
	    databaseName = dbName_FNQA
	ElseIf StrComp(GlobalDictionary("Environment"), "FNTST") = 0 Then
      	connectionString = PSFCONNECTIONSTRFNTST
	    databaseName = dbName_FNTST
	ElseIf StrComp(GlobalDictionary("Environment"), "FNRVTST") = 0 Then
      	connectionString = PSFCONNECTIONSTRFNRVTST
	    databaseName = dbName_FNRVTST
    Else
 		connectionString = PSFCONNECTIONSTRFNREG
	    databaseName = dbName_FNREG     
	End If

  	'Set the Database connection object 
	Set objConnection= dbOpenConnection(connectionString, databaseName, dbPWDVM)

	'Verify for object exist or not
	If IsObject(objConnection) Then

		'Execute the SQL and get the recordset object
		On Error Resume Next
		objConnection.CommandTimeout = 90
		Set dBRecSet = objConnection.Execute(strSQL)
		DataTable.AddSheet(sheetName)
		DataTable.GetSheet(sheetName).SetCurrentRow(0)
		fields = 0
        If IsObject(dBRecSet) Then
			If dBRecSet.EOF = False Then
			    For i = 0 To dBRecSet.fields.count-1
			    	DataTable.GetSheet(sheetName).AddParameter dBRecSet.fields(i).Name, ""
			    Next

			    DataTable.SetCurrentRow(1)
			    For j = 0 To dBRecSet.fields.count-1
					ReDim Preserve arrRecordValues(j)
			        DataTable.Value("" & dBRecSet.fields(j).Name, sheetName) = "" & dBRecSet.fields(j).Value
			        arrRecordValues(j) = "" & dBRecSet.fields(j).Value
			    Next
			Else
				WriteToReport micDone, "DB records", "Returned zero records", False
		    End If
		Else
		   WriteToReport nReportValue, "Verifying the Record from Database", "No Record Exist for SQL: [" & strSQL & "]"
		End If
	Else
		WriteToReport micFail, "DB connection", "Data base connection is failed", False
	End If  

	dbGetFirstRecord = arrRecordValues

	'Clean up opened objects
 	dBRecSet.Close
	objConnection.Close
End Function

Public Function dbGetSingleFieldValue(strSQL,sConnectionString, arrRecordValues,sheetName )
	Dim dBRecSet, objConnection, connectionString, databaseName
	Dim intLoop, iArrayNo, nRecordCount, sOneRecord, nReportValue
	Dim sTemp, i, j, fields, firstFieldValue

	If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
		connectionString = PSFCONNECTIONSTRFNQA
		databaseName     = dbName_FNQA
	ElseIf StrComp(GlobalDictionary("Environment"), "FNTST") = 0 Then
		connectionString = PSFCONNECTIONSTRFNTST
		databaseName     = dbName_FNTST
	ElseIf StrComp(GlobalDictionary("Environment"), "FNRVTST") = 0 Then
		connectionString = PSFCONNECTIONSTRFNRVTST
		databaseName     = dbName_FNRVTST
	Else
		connectionString = PSFCONNECTIONSTRFNREG
		databaseName     = dbName_FNREG     
	End If

  	'Set the Database connection object 
	Set objConnection= dbOpenConnection(connectionString, databaseName, dbPWDVM)

	'Verify for object exist or not
	If IsObject(objConnection) Then

		'Execute the SQL and get the recordset object
		On Error Resume Next
		Set dBRecSet = objConnection.Execute(strSQL)
		DataTable.AddSheet(sheetName)
		DataTable.GetSheet(sheetName).SetCurrentRow(0)
		fields = 0
        If IsObject(dBRecSet) Then
			If dBRecSet.EOF = False Then
			    For i = 0 To dBRecSet.fields.count-1
			    	DataTable.GetSheet(sheetName).AddParameter dBRecSet.fields(i).Name, ""
			    Next
			    DataTable.SetCurrentRow(1)
			    For j = 0 To dBRecSet.fields.count-1
			    
			        'ReDim Preserve arrRecordValues(j)
			        DataTable.Value("" & dBRecSet.fields(j).Name,sheetName) = "" & dBRecSet.fields(j).Value
			        firstFieldValue = "" & dBRecSet.fields(j).Value
			    Next
			Else
				WriteToReport micDone, "DB records", "Returned zero records", False
		    End If
		Else
			WriteToReport nReportValue, "Verifying the Record from Database", "No Record Exist for SQL: [" & strSQL & "]"
	  	End If
	Else
		WriteToReport micFail, "DB connection", "Data base connection is failed", False
	End If  

	dbGetSingleFieldValue = firstFieldValue

	'Clean up opened objects
 	dBRecSet.Close
	objConnection.Close
End Function

'**************************************************************************************************************
''' <summary> 
''' dbOpenConnection is to connect to DataBase
''' </summary>
''' <author>Venu Arigela</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <param name="sConnectionString" type="string">connection string</param>
''' <param name="dbName" type="DB Name">Name of DB trying to connect</param>
''' <param name="dbPwd" type="string">Password</param>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
''' <returns type="string"> state of DB connection . 1 for success </returns>
'Change Control: 
'Date of Change 	Author Venu arigela		Description of change
Public Function dbOpenConnection(sConnectionString, dbName, dbPwd)
	Const adStateOpen = 1
	Dim objConnection

	Set objConnection = CreateObject("ADODB.Connection")

	'Changing the timeout property for SQL statement execution. Highest we've seen is 1 minute 15 seconds, so using 90 as the upper end for now
	objConnection.ConnectionTimeout = 90
	
	'Open connection and ensure its opened correctly or report error
	'objConnection.Open  sConnectionString
	If dbName <> "" and dbPwd <> "" Then
		objConnection.Open sConnectionString, dbName, dbPwd
	Else
		objConnection.Open sConnectionString
	End If

	If Not objConnection.State = adStateOpen Then 
		WriteToResults 1, "Error on opening database connection", "Verify details of connection string " & sConnectionString
		Set objConnection = Nothing 
	End If

   	Set dbOpenConnection = objConnection
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetAllRecords is helper component to retreive the sigle column records from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetAllRecords(strSQL,sConnectionString, arrRecordValues,sheetName,dbcolumnname )
	Dim dBRecSet, objConnection, connectionString, databaseName	
	Dim intLoop, iArrayNo, nRecordCount, sOneRecord, nReportValue
	Dim sTemp, i, j, fields, nColumns, n, nRow

	If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
		connectionString = PSFCONNECTIONSTRFNQA
		databaseName     = dbName_FNQA
 	ElseIf StrComp(GlobalDictionary("Environment"), "FNTST") = 0 Then
		connectionString = PSFCONNECTIONSTRFNTST
		databaseName     = dbName_FNTST
	ElseIf StrComp(GlobalDictionary("Environment"), "FNRVTST") = 0 Then
		connectionString = PSFCONNECTIONSTRFNRVTST
		databaseName     = dbName_FNRVTST
	Else
		connectionString = PSFCONNECTIONSTRFNREG
		databaseName     = dbName_FNREG     
	End If

	'Set the Database connection object 
	Set objConnection= dbOpenConnection(connectionString,databaseName,dbPWDVM)


	'Verify for object exist or not
	If IsObject(objConnection) Then

		'Execute the SQL and get the recordset object
		On Error Resume Next
		Set dBRecSet = objConnection.Execute(strSQL)
		Datatable.AddSheet (sheetName)
		Datatable.AddSheet (sheetName).SetCurrentRow(0)
		fields = 0
        If IsObject(dBRecSet) Then
			If dBRecSet.EOF = False Then
			    For i = 0 To dBRecSet.fields.count-1
			    	DataTable.GetSheet(sheetName).AddParameter dBRecSet.fields(i).Name, ""
			    Next

				j=1
				Do While dBRecSet.EOF <> True
					ReDim Preserve arrRecordValues(j)
					DataTable.SetCurrentRow(j)
					DataTable.Value("" & dbcolumnname, sheetName) = dBRecSet.Fields("" & dbcolumnname).Value
					arrRecordValues(j) = "" & dBRecSet.Fields("" & dbcolumnname).Value
					dBRecSet.MoveNext
					j = j + 1
				Loop
			Else
				WriteToReport micFail, "DB records", "Returned zero records", False
		    End If
		Else
		   	WriteToReport nReportValue, "Verifying the Record from Database", "No Record Exist for SQL: [" & strSQL & "]"
		End If
	Else
		WriteToReport micFail, "DB connection", "Data base connection is failed", False
	End If  

	dbGetAllRecords = arrRecordValues

	'Clean up opened objects
 	dBRecSet.Close
	objConnection.Close
End Function

'**************************************************************************************************************
''' <summary> 
''' dbVerifyInvoiceValues is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbVerifyInvoiceValues()
	Err.Clear
	On Error Resume Next
	Dim sSQL, unit
	Dim arrRecordValues()

	unit = GlobalDictionary("BusinessUnit")
	sSQL = "SELECT A.INVOICE_FORM_ID " & _
		"FROM PS_BI_IVC_FORM A " & _
		"WHERE A.STATUS_BI  = 'A'"
	WriteToReport micDone, "SQL query for Invoice Values", "Query used for Invoice Values is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    dbVerifyInvoiceValues = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Invoice_Data_" & unit, "INVOICE_FORM_ID")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then    
	    dbVerifyInvoiceValues = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Invoice_Data_" & unit, "INVOICE_FORM_ID")
	ElseIf strComp (GlobalDictionary("Environment"), "FNRVTST") = 0 Then    
	    dbVerifyInvoiceValues = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues, "Invoice_Data_" & unit, "INVOICE_FORM_ID")
	Else
	    dbVerifyInvoiceValues = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Invoice_Data_" & unit, "INVOICE_FORM_ID")
	End If

 	On Error GoTo 0
End Function

'**************************************************************************************************************
''' <summary> 
''' dbVerifyInvoiceValues is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchCustomerIdItemInfo(unit)
	Dim sSQL
	Dim arrRecordValues()

'           sSQL = "SELECT BUSINESS_UNIT, CUST_ID, ITEM, BAL_AMT from PS_ITEM " & _
'           "WHERE BAL_AMT < 0 " & _
'           "AND BUSINESS_UNIT ='" & unit & "'"
''' changed as per rini 06/09/2016
	sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM " & _ 
			"FROM PS_ITEM Q , PS_BI_HDR R " & _
			"WHERE Q.BAL_AMT < 0 " & _ 
			"AND Q.CUST_ID = R.BILL_TO_CUST_ID " & _ 
			"AND R.INVOICE LIKE 'ZR%' " & _
			"AND Q.BUSINESS_UNIT = '" & unit & "' " & _
			"AND Q.ENTRY_TYPE = 'CR' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _
			"AND Q.ITEM NOT IN ( " & _
			"(SELECT  B.ITEM " & _
			  "FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D " & _ 
			  "WHERE ( A.WS_BU = B.WS_BU " & _ 
			     "AND A.WS_ID = B.WS_ID " & _ 
			     "AND C.SETCNTRLVALUE = B.BUSINESS_UNIT " & _ 
			     "AND C.RECNAME = 'CUSTOMER' " & _
			     "AND D.SETID = C.SETID " & _ 
			     "AND D.CUST_ID = B.CUST_ID " & _
			     "AND B.ITEM_SELECTED = 'Y' " & _
			     "AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _ 
			     "AND B.ITEM = Q.ITEM) " & _
			"UNION " & _
			"SELECT  F.ITEM " & _
			  "FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H " & _ 
			  "WHERE ( E.TRN_BU = F.TRN_BU " & _
			     "AND E.TRN_ID = F.TRN_ID " & _
			     "AND F.ITEM_SELECTED = 'Y' " & _
			     "AND G.SETCNTRLVALUE = F.BUSINESS_UNIT " & _ 
			     "AND G.RECNAME = 'CUSTOMER' " & _
			     "AND H.SETID = G.SETID " & _
			     "AND H.CUST_ID = F.CUST_ID " & _ 
			     "AND F.ITEM = Q.ITEM " & _
			     "AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT) " & _ 
			"UNION " & _
			"SELECT J.ITEM " & _ 
			  "FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L " & _ 
			  "WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU " & _
			     "AND I.DEPOSIT_ID = J.DEPOSIT_ID " & _ 
			     "AND J.ITEM_SELECTED = 'Y' " & _
			     "AND K.SETCNTRLVALUE = J.BUSINESS_UNIT " & _ 
			     "AND K.RECNAME = 'CUSTOMER' " & _ 
			     "AND L.SETID = K.SETID " & _
			     "AND L.CUST_ID = J.CUST_ID " & _
			     "AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _ 
			     "AND J.ITEM = Q.ITEM) " & _ 
			"UNION " & _ 
			"SELECT N.ITEM " & _
			  "FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P " & _ 
			  "WHERE ( M.GROUP_BU = N.GROUP_BU " & _
			     "AND M.GROUP_ID = N.GROUP_ID " & _
			     "AND O.SETCNTRLVALUE = N.BUSINESS_UNIT " & _ 
			     "AND O.RECNAME = 'CUSTOMER' " & _ 
			     "AND P.SETID = O.SETID " & _ 
			     "AND P.CUST_ID = N.CUST_ID " & _ 
			     "AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _ 
			     "AND N.ITEM = Q.ITEM " & _ 
			     "AND N.POST_DT IS NULL))) " & _
                 "ORDER BY BUSINESS_UNIT "

    WriteToReport micDone, "SQL query for Customer and Item", "Query used for Customer and Item info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchCustomerIdItemInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "CustomerItem_Info_" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
    	dbFetchCustomerIdItemInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "CustomerItem_Info_" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNRVTST") = 0 Then 
    	dbFetchCustomerIdItemInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues, "CustomerItem_Info_" & unit)
    Else
        dbFetchCustomerIdItemInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "CustomerItem_Info_" & unit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbVerifyInvoiceValues is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchCustomerIdItemInfoACHPaymentMetod(unit)
	Dim sSQL
	Dim arrRecordValues()

	sSQL =  "SELECT B.SETID, B.VENDOR_ID, B.PYMNT_METHOD, A.CUST_ID, C.BUSINESS_UNIT, C.ITEM, C.BAL_AMT " & _
			"FROM PS_VENDOR A, PS_VENDOR_PAY B, PS_ITEM C " & _
			"WHERE ( A.SETID = B.SETID " & _
			"AND A.VENDOR_ID = B.VENDOR_ID " & _
			"AND A.CUST_ID = C.CUST_ID " & _
			"AND C.BAL_AMT < 0 " & _
			"AND B.EFFDT =  " & _
			"(SELECT MAX(B_ED.EFFDT) FROM PS_VENDOR_PAY B_ED " & _
			"WHERE B.SETID = B_ED.SETID " & _
			"AND B.VENDOR_ID = B_ED.VENDOR_ID " & _
			"AND B.VNDR_LOC = B_ED.VNDR_LOC " & _
			"AND B_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) " & _
			"AND A.CUST_ID <> '' " & _
			"AND B.PYMNT_METHOD = 'ACH') " & _
			"AND C.BUSINESS_UNIT = '" & unit & "'"

	WriteToReport micDone, "SQL query for Customer and Item (ACH Payment Method)", "Query used for Customer and Item (ACH Payment Method) info is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbFetchCustomerIdItemInfoACHPaymentMetod = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "CustomerItem_Info_" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
		dbFetchCustomerIdItemInfoACHPaymentMetod = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "CustomerItem_Info_" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNRVTST") = 0 Then 
		dbFetchCustomerIdItemInfoACHPaymentMetod = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues, "CustomerItem_Info_" & unit)
	Else
		dbFetchCustomerIdItemInfoACHPaymentMetod = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "CustomerItem_Info_" & unit)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbVerifyInvoiceValues is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchARspecialist(customer)
	Dim sSQL, unit
	Dim arrRecordValues()
	unit = GlobalDictionary("BusinessUnit")
	sSQL = "SELECT DISTINCT A.CUST_ID, " & _
            "G.AR_SPECIALIST, G.COLLECTOR " & _
           "FROM PS_CUSTOMER A " & _
            "LEFT OUTER JOIN  PS_CUST_ADDRESS B ON  A.SETID = B.SETID AND A.CUST_ID = B.CUST_ID AND B.ADDRESS_SEQ_NUM = A.ADDRESS_SEQ_NUM " & _
            "LEFT OUTER JOIN  PS_CUST_CREDIT D ON  A.SETID = D.SETID AND A.CUST_ID = D.CUST_ID " & _
            "LEFT OUTER JOIN  PS_CUST_EXEMPT_DTL F ON  A.SETID = F.SETID AND A.CUST_ID = F.CUST_ID " & _
            "LEFT OUTER JOIN PS_CUST_OPTION  G ON A.SETID = G.SETID AND A.CUST_ID = G.CUST_ID " & _
            "LEFT JOIN PS_CUST_TEAM H ON A.SETID = H.SETID AND A.CUST_ID = H.CUST_ID " & _
   			"WHERE A.CUST_ID = '" & customer & "' "

    WriteToReport micDone, "SQL query for ARSpecialist and Collector", "Query used for ARSpecialist and Collector info is " & sSQL, False
    If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
    	dbFetchARspecialist = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ARSpecialist_Info_" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
    	dbFetchARspecialist = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ARSpecialist_Info_" & unit)
    Else
        dbFetchARspecialist = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ARSpecialist_Info_" & unit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbVerifyInvoiceValues is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchTaxExemption(customer)
	Dim sSQL, unit
	Dim arrRecordValues()
	unit = GlobalDictionary("BusinessUnit")
	sSQL = "SELECT A.SETID, B.CUST_FIELD_C6, A.CUST_ID, B.NAME1, B.CUST_STATUS, A.TAX_EXEMPT_CERT,(CONVERT(CHAR(10),A.EFFDT,121)),A.EFF_STATUS, A.TAX_EXEMPT_FLAG, A.EXEMPT_CATEGORY,(CONVERT(CHAR(10),A.ISSUED_DT,121)), (CONVERT(CHAR(10),A.EXPIRATION_DT,121)) FROM PS_CUST_EXEMPT_DTL A, PS_CUSTOMER B WHERE(A.EFFDT=(SELECT MAX(A_ED.EFFDT) FROM PS_CUST_EXEMPT_DTL A_ED WHERE A.SETID = A_ED.SETID AND A.CUST_ID = '" & customer & "' AND A.TAX_EXEMPT_CERT = A_ED.TAX_EXEMPT_CERT AND A_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121),1,10)) AND A.SETID = B.SETID AND A.CUST_ID = B.CUST_ID AND B.CUST_STATUS = 'A') "

    WriteToReport micDone, "SQL query for Tax Exemption Certificate", "Query used for Tax Exemption Certificate is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchTaxExemption = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "TaxExemptionCertificate_Info_" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
        dbFetchTaxExemption = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "TaxExemptionCertificate_Info_" & unit)
    Else
        dbFetchTaxExemption = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "TaxExemptionCertificate_Info_" & unit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbVerifyInvoiceValues is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchUserId(user)
	Dim sSQL, unit
	Dim arrRecordValues()
	'if there is a single quote in the name, replace it with two single quotes
	If InStr(1,user, "'")>0 Then
		user = Replace(user, "'", "''")		
	End If

	unit = GlobalDictionary("BusinessUnit")
	sSQL = "SELECT OPRDEFNDESC, OPRID FROM PSOPRDEFN WHERE OPRDEFNDESC LIKE '" & user & "' "
    WriteToReport micDone, "SQL query for User ID", "Query used for User ID is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchUserId = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "UserID_Info_" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       dbFetchUserId = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "UserID_Info_" & unit)    
    Else
        dbFetchUserId = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "UserID_Info_" & unit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbVerifyInvoiceValues is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchCustomerDetails(unit)
	Dim sSQL
	Dim arrRecordValues()

	sSQL = "SELECT DISTINCT A.CUST_ID, A.NAME1, A.VENDOR_SETID, A.VENDOR_ID, A.CURRENCY_CD, " & _
		"A.CUST_FIELD_C1_A  as VERBAL_PO, A.CUST_FIELD_C1_B as RMS_Suppression, A.CUST_FIELD_C1_C as Tax_Exempt,A.CUST_FIELD_C6 as Home_Business_Unit, " & _
		"B.ADDRESS_SEQ_NUM AS LOCATION, B.ADDRESS1, B.ADDRESS2, B.ADDRESS3, B.CITY, B.COUNTY, B.STATE, B.POSTAL, B.GEO_CODE, B.COUNTRY_CODE, " & _
		"D.CR_LIMIT, F.TAX_EXEMPT_FLAG, F.EXEMPT_CATEGORY, F.DESCR, G.AR_SPECIALIST,G.COLLECTOR, G.CR_ANALYST, H.SUPPORT_TEAM_CD " & _
		"FROM PS_CUSTOMER A " & _
		"LEFT OUTER JOIN  PS_CUST_ADDRESS B ON  A.SETID = B.SETID AND A.CUST_ID = B.CUST_ID AND B.ADDRESS_SEQ_NUM = A.ADDRESS_SEQ_NUM " & _
		"LEFT OUTER JOIN  PS_CUST_CREDIT D ON  A.SETID = D.SETID AND A.CUST_ID = D.CUST_ID " & _
		"LEFT OUTER JOIN  PS_CUST_EXEMPT_DTL F ON  A.SETID = F.SETID AND A.CUST_ID = F.CUST_ID " & _
		"LEFT OUTER JOIN PS_CUST_OPTION  G ON A.SETID = G.SETID AND A.CUST_ID = G.CUST_ID " & _
		"LEFT JOIN PS_CUST_TEAM H ON A.SETID = H.SETID AND A.CUST_ID = H.CUST_ID " & _
		"WHERE A.CUST_FIELD_C6 = '" & unit & "' AND D.CR_LIMIT>0 "

    WriteToReport micDone, "SQL query for Customer Details", "Query used for Customer Details info is " & sSQL, False
    If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchCustomerDetails = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "CustomerDetails_Info_" & unit)
    ElseIf strComp(GlobalDictionary("Environment"), "FNTST") = 0 Then 
        dbFetchCustomerDetails = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "CustomerDetails_Info_" & unit)    
    Else
        dbFetchCustomerDetails = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "CustomerDetails_Info_" & unit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbVerifyInvoiceValues is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchCorrespondenceOptionsPage(customer)
	Err.Clear
	On Error Resume Next
	Dim sSQL, unit
	Dim arrRecordValues()

	unit = GlobalDictionary("BusinessUnit")
	sSQL = "SELECT A.SETID, A.CUST_ID, (CONVERT(CHAR(10),A.EFFDT,121)), A.EFF_STATUS, A.BANK_CD, " & _
		"A.BANK_ACCT_KEY, A.CRSPD_ADDR, A.ADDRESS_SEQ_NUM, A.CNTCT_SEQ_NUM, A.ONE_DOCUMENT_PER, A.DUN_ID, " & _
		"A.DUN_GROUP, A.DUN_HOLD, (CONVERT(CHAR(10),A.DUN_HOLD_DT,121)), A.ST_ID, A.ST_GROUP, " & _
		"A.ST_HOLD, (CONVERT(CHAR(10),A.ST_HOLD_DT,121)), A.CRSPD_CNTCT, A.LANGUAGE_CD, A.OC_GROUP, A.OC_ADMIN_ID, A.OC_ADMIN_HOLD, " & _
		"(CONVERT(CHAR(10),A.OC_ADMIN_HOLD_DT,121)), A.OC_FIN_ID, A.OC_FIN_HOLD, (CONVERT(CHAR(10),A.OC_FIN_HOLD_DT,121)), A.OC_PNLTY_ID, A.OC_PNLTY_HOLD, " & _
		"(CONVERT(CHAR(10),A.OC_PNLTY_HOLD_DT,121)), A.ASSESS_OC_FLAG, A.VIEW_STMT_IMAG_CWB, A.LAST_MAINT_OPRID, (CONVERT(CHAR(10),A.DATE_LAST_MAINT,121)) " & _
		"FROM PS_CUST_CRSPD A   WHERE ( A.EFFDT = (SELECT MAX(A_ED.EFFDT) FROM PS_CUST_CRSPD A_ED " & _
		"WHERE A.SETID = A_ED.SETID AND A.CUST_ID = A_ED.CUST_ID " & _
		"AND A_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) " & _
		"AND A.CUST_ID = '" & customer & "') "
    WriteToReport micDone, "SQL query for CorrespondePage", "Query used for Correspondence Page info is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbFetchCorrespondenceOptionsPage = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "CorrespondencePage_Info_" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then
		dbFetchCorrespondenceOptionsPage = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "CorrespondencePage_Info_" & unit)
	Else
		dbFetchCorrespondenceOptionsPage = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "CorrespondencePage_Info_" & unit)
	End If

	On Error goto 0	
End Function

'**************************************************************************************************************
''' <summary> 
''' dbVerifyInvoiceValues is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>21-Nov-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchContactPage(customer)
	Dim sSQL, unit
	Dim arrRecordValues()

	unit = GlobalDictionary("BusinessUnit")
	sSQL = "SELECT A.SETID, A.CUST_ID, A.CNTCT_SEQ_NUM, (CONVERT(CHAR(10),A.EFFDT,121)), A.EFF_STATUS, A.NAME1, A.TITLE, A.ADDRESS_SEQ_NUM, A.LANGUAGE_CD, A.EMAILID, A.COMM_METHOD, A.SALUTATION_CD, A.SALUTATION, A.LAST_MAINT_OPRID, (CONVERT(CHAR(10),A.DATE_LAST_MAINT,121)), A.AUTHORIZATION_ID " & _ 
		"FROM PS_CUST_CONTACT A " & _
		"WHERE ( A.EFFDT = " & _
		"(SELECT MAX(A_ED.EFFDT) FROM PS_CUST_CONTACT A_ED " & _
		"WHERE A.SETID = A_ED.SETID " & _
		"AND A.CUST_ID = A_ED.CUST_ID " &_
		"AND A_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) " & _
		"AND A.CUST_ID = '" & customer & "') "

    WriteToReport micDone, "SQL query for Contacts Page", "Query used for Contacts Page info is " & sSQL, False
    If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchContactPage = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ContactsPage_Info_" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
        dbFetchContactPage = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ContactsPage_Info_" & unit)    
    Else
        dbFetchContactPage = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ContactsPage_Info_" & unit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchNewCustProperties is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="custID" type="string">Customer id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchNewCustProperties(custID)
    Dim sSQL
    Dim arrRecordValues()

	sSQL = "SELECT DISTINCT A.CUST_ID, A.NAME1, A.CURRENCY_CD,A.CUST_FIELD_C1_A, A.CUST_FIELD_C1_B, A.CUST_FIELD_C1_C,A.CUST_FIELD_C6,B.ADDRESS_SEQ_NUM AS LOCATION, B.ADDRESS1, B.ADDRESS2, B.ADDRESS3, B.CITY, B.COUNTY, B.STATE, B.POSTAL, B.GEO_CODE, B.COUNTRY_CODE, D.CR_LIMIT, F.TAX_EXEMPT_FLAG, F.EXEMPT_CATEGORY, F.DESCR, G.AR_SPECIALIST,G.COLLECTOR,H.SUPPORT_TEAM_CD " & _
		"FROM PS_CUSTOMER A " & _ 
		"LEFT OUTER JOIN  PS_CUST_ADDRESS B ON  A.SETID = B.SETID AND A.CUST_ID = B.CUST_ID AND B.ADDRESS_SEQ_NUM = A.ADDRESS_SEQ_NUM " & _ 
		"LEFT OUTER JOIN  PS_CUST_CREDIT D ON  A.SETID = D.SETID AND A.CUST_ID = D.CUST_ID " & _
		"LEFT OUTER JOIN  PS_CUST_EXEMPT_DTL F ON  A.SETID = F.SETID AND A.CUST_ID = F.CUST_ID " & _
		"LEFT OUTER JOIN PS_CUST_OPTION  G ON A.SETID = G.SETID AND A.CUST_ID = G.CUST_ID " & _
		"LEFT JOIN PS_CUST_TEAM H ON A.SETID = H.SETID AND A.CUST_ID = H.CUST_ID " & _
		"WHERE A.CUST_ID = '" & custID & "' "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbFetchNewCustProperties = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "custinfo_data", "CUST_ID")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
		dbFetchNewCustProperties = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "custinfo_data", "CUST_ID")
	Else
		dbFetchNewCustProperties = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "custinfo_data", "CUST_ID")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetch1to3Properties is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetch1to3Properties(bunit)
    Dim sSQL
    Dim arrRecordValues()	

	'' updated query as per rini
	sSQL = "SELECT DISTINCT B.BUSINESS_UNIT, A.CUST_ID, A.CORPORATE_CUST_ID FROM PS_CUSTOMER A, PS_ITEM B, PS_CUST_OPTION C " & _
       "WHERE A.CUST_ID = B.CUST_ID AND B.BUSINESS_UNIT = '" & bunit & "' " & _ 
       "AND A.CUST_ID = C.CUST_ID " & _
       "AND C.CR_ANALYST <> '' " & _
       "ORDER BY BUSINESS_UNIT "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetch1to3Properties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Billing_Data" & bunit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
        dbFetch1to3Properties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Billing_Data" & bunit)
    Else
        dbFetch1to3Properties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Billing_Data" & bunit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetch1to3PropertiesNonGEo is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetch1to3PropertiesNonGeo(bunit)
    Dim sSQL
    Dim arrRecordValues()	

	'' updated query as per rini
	sSQL = "SELECT DISTINCT B.BUSINESS_UNIT, A.CUST_ID, A.CORPORATE_CUST_ID, D.GEO_CODE " &_
	   "FROM PS_CUSTOMER A, PS_ITEM B, PS_CUST_OPTION C, PS_CUST_ADDRESS D  " & _
       "WHERE A.CUST_ID = B.CUST_ID AND A.CUST_ID = D.CUST_ID AND B.BUSINESS_UNIT = '" & bunit& "' " & _ 
       "AND A.CUST_ID = C.CUST_ID " & _
       "AND C.CR_ANALYST <> '' " & _
       "AND D.GEO_CODE <> ''  " & _
       "ORDER BY BUSINESS_UNIT "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetch1to3PropertiesNonGeo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Billing_Data" & bunit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
        dbFetch1to3PropertiesNonGeo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Billing_Data" & bunit)
    Else
        dbFetch1to3PropertiesNonGeo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Billing_Data" & bunit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetch1to3Propertiesnotlinked is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetch1to3Propertiesnotlinked(bunit)
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT DISTINCT B.BUSINESS_UNIT, A.CUST_ID, A.CORPORATE_CUST_ID FROM PS_CUSTOMER A, PS_ITEM B " & _
		"WHERE A.CUST_ID = B.CUST_ID " & _
		"AND BUSINESS_UNIT = '" & bunit & "' " & _
		"AND A.CORPORATE_CUST_ID <> '' " & _
		"AND A.CUST_ID <> A.CORPORATE_CUST_ID "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetch1to3Propertiesnotlinked = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetch1to3Propertiesnotlinked = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Billing_Data" & bunit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
        dbFetch1to3Propertiesnotlinked = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Billing_Data" & bunit)    
    Else
        dbFetch1to3Propertiesnotlinked = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Billing_Data" & bunit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchbankID is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchbankID(custID)
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "SELECT A.SETID, A.BANK_CD, A.BANK_ACCT_KEY " & _
		"FROM PS_CUST_CRSPD A " & _
		"WHERE ( A.EFFDT = " & _
		"(SELECT MAX(A_ED.EFFDT) FROM PS_CUST_CRSPD A_ED " & _
		"WHERE A.SETID = A_ED.SETID " & _
		"AND A.CUST_ID = A_ED.CUST_ID " & _
		"AND A_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) " & _
		"AND A.CUST_ID = '" & custID & "') "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchbankID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchbankID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Billing_Data" & custID)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
        dbFetchbankID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Billing_Data" & custID)    
    Else
       dbFetchbankID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Billing_Data" & custID)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' verbalpovalue is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="custID" type="string">Customer id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function verbalpovalue(custID)
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "SELECT DISTINCT A.CUST_FIELD_C1_A  as VERBAL_PO " & _
		"FROM PS_CUSTOMER A " & _   
		"WHERE A.CUST_ID = '" & custID & "' "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	
	'verbalpovalue = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    verbalpovalue = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Billing_Data" & custID)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    verbalpovalue = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Billing_Data" & custID)
	Else
	    verbalpovalue = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Billing_Data" & custID)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' rmsnotsuppressed is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function rmsnotsuppressed
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT A.CUST_ID, A.NAME1, A.CUST_STATUS,  B.COLLECTOR, B.AR_SPECIALIST " & _
	"FROM PS_CUSTOMER A, PS_CUST_OPTION B " & _
	"WHERE CUST_STATUS = 'A' " & _
	"AND A.CUST_ID = B.CUST_ID " & _
	"AND COLLECTOR = 'RMS' "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	
	'rmsnotsuppressed = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    rmsnotsuppressed = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Billing_Data")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    rmsnotsuppressed = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Billing_Data")
	Else
	    rmsnotsuppressed = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Billing_Data")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' us27code is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="custid" type="string">customer id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function us27code(custID)
    Dim sSQL
    Dim arrRecordValues()

	sSQL = "SELECT DISTINCT B.BUSINESS_UNIT, A.CUST_ID, A.SIC_CD_QUAL, A.SIC_CODE FROM PS_CUST_SIC_CODES A, PS_ITEM B " & _
		"WHERE A.CUST_ID = '" & custID & "' " & _
		"AND A.CUST_ID = B.CUST_ID "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'us27code = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    us27code = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Billing_Data" & custID)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    us27code = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Billing_Data" & custID)
	Else
	    us27code = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Billing_Data" & custID)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' negbal is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="buin" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function negbal(buin)
    Dim sSQL
    Dim arrRecordValues()	

	'sSQL = "select BUSINESS_UNIT, CUST_ID, ITEM, BAL_AMT from PS_ITEM " & _
	'"WHERE BAL_AMT < 0 " & _
	'"AND BUSINESS_UNIT IN ('" & buin & "') AND CUST_ID <> '10092568'"
	'' as per Rini updated the query 06/09
	sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM " & _ 
			"FROM PS_ITEM Q , PS_BI_HDR R " & _
			"WHERE Q.BAL_AMT < 0 " & _ 
			"AND Q.CUST_ID = R.BILL_TO_CUST_ID " & _ 
			"AND R.INVOICE LIKE 'ZR%' " & _
			"AND Q.BUSINESS_UNIT = '" & buin & "' " & _
			"AND Q.ENTRY_TYPE = 'CR' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _
			"AND Q.ITEM NOT IN ( " & _
			"(SELECT  B.ITEM " & _
			  "FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D " & _ 
			  "WHERE ( A.WS_BU = B.WS_BU " & _ 
			     "AND A.WS_ID = B.WS_ID " & _ 
			     "AND C.SETCNTRLVALUE = B.BUSINESS_UNIT " & _ 
			     "AND C.RECNAME = 'CUSTOMER' " & _
			     "AND D.SETID = C.SETID " & _ 
			     "AND D.CUST_ID = B.CUST_ID " & _
			     "AND B.ITEM_SELECTED = 'Y' " & _
			     "AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _ 
			     "AND B.ITEM = Q.ITEM) " & _
			"UNION " & _
			"SELECT  F.ITEM " & _
			  "FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H " & _ 
			  "WHERE ( E.TRN_BU = F.TRN_BU " & _
			     "AND E.TRN_ID = F.TRN_ID " & _
			     "AND F.ITEM_SELECTED = 'Y' " & _
			     "AND G.SETCNTRLVALUE = F.BUSINESS_UNIT " & _ 
			     "AND G.RECNAME = 'CUSTOMER' " & _
			     "AND H.SETID = G.SETID " & _
			     "AND H.CUST_ID = F.CUST_ID " & _ 
			     "AND F.ITEM = Q.ITEM " & _
			     "AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT) " & _ 
			"UNION " & _
			"SELECT J.ITEM " & _ 
			  "FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L " & _ 
			  "WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU " & _
			     "AND I.DEPOSIT_ID = J.DEPOSIT_ID " & _ 
			     "AND J.ITEM_SELECTED = 'Y' " & _
			     "AND K.SETCNTRLVALUE = J.BUSINESS_UNIT " & _ 
			     "AND K.RECNAME = 'CUSTOMER' " & _ 
			     "AND L.SETID = K.SETID " & _
			     "AND L.CUST_ID = J.CUST_ID " & _
			     "AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _ 
			     "AND J.ITEM = Q.ITEM) " & _ 
			"UNION " & _ 
			"SELECT N.ITEM " & _
			  "FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P " & _ 
			  "WHERE ( M.GROUP_BU = N.GROUP_BU " & _
			     "AND M.GROUP_ID = N.GROUP_ID " & _
			     "AND O.SETCNTRLVALUE = N.BUSINESS_UNIT " & _ 
			     "AND O.RECNAME = 'CUSTOMER' " & _ 
			     "AND P.SETID = O.SETID " & _ 
			     "AND P.CUST_ID = N.CUST_ID " & _ 
			     "AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _ 
			     "AND N.ITEM = Q.ITEM " & _ 
			     "AND N.POST_DT IS NULL))) " & _
			                "ORDER BY BUSINESS_UNIT "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	
	'negbal = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    negbal = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Billing_Data" & buin)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    negbal = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Billing_Data" & buin)
	Else
	    negbal = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Billing_Data" & buin)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbDateConversion helps to convert the Data Format which we retain from the Database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Dec-2015</datecreated>
''' <param name="unit" type="string">date from DB </param>
''' <param name="arrRecordValues" type="array">Date with change in format</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbDateConversion(datefromDB)
	Dim nReportValue,month1

	If isDate(datefromDB) Then
		If Len(month("" & datefromDB & ""))=1 Then
			month1 ="0" & month(datefromDB)
		Else
			month1 = month(datefromDB)
		End If

    	dbDateConversion = "" & month1 & "/" & day("" & datefromDB & "") & "/" & Year("" & datefromDB & "")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbDateConversion helps to convert the Data Format which we retain from the Database to make sure Month and Day are two numbers
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>12Feb2019</datecreated>
''' <param name="unit" type="string">date from DB </param>
''' <param name="arrRecordValues" type="array">Date with change in format</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbDateConversion2(datefromDB)
	Dim nReportValue,month1, Day1

	If isDate(datefromDB) Then
		If Len(month("" & datefromDB & ""))=1 Then
			month1 ="0" & month(datefromDB)
		Else
			month1 = month(datefromDB)
		End If
		If Len(Day("" & datefromDB & ""))=1 Then
			Day1 ="0" & day(datefromDB)
		Else
			Day1 = day(datefromDB)
		End If
    	dbDateConversion2 = "" & month1 & "/" &  Day1  & "/" & Year("" & datefromDB & "")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbSupplier helps to get the Supplier Information from DB
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbSupplier(srtBusinessValue)
	Dim strSQL, sConnectionString, sheetName, supplier_id, arrRecordValues

	strSQL ="SELECT DISTINCT A.SETID,A.VENDOR_ID, E.PYMNT_METHOD,A.CUST_ID,A.VENDOR_NAME_SHORT,A.NAME1,A.NAME2,A.VENDOR_STATUS,A.VENDOR_CLASS,A.SUPPAUDIT_FLG,A.VAT_SW,A.HRMS_CLASS,A.DEFAULT_LOC,A.VENDOR_PERSISTENCE,B.ADDRESS_SEQ_NUM,(CONVERT(CHAR(10),B.EFFDT,121)),B.EFF_STATUS,B.EMAILID,B.COUNTRY,B.ADDRESS1,B.ADDRESS2,B.ADDRESS3,B.CITY,B.COUNTY,B.POSTAL,B.GEO_CODE,C.CNTCT_SEQ_NUM,C.CONTACT_NAME,C.CONTACT_TYPE,C.CONTACT_TITLE,D.VNDR_LOC FROM PS_VENDOR A,PS_VENDOR_ADDR B,PS_VENDOR_CNTCT C,PS_VENDOR_LOC D, PS_VENDOR_PAY E WHERE ( A.SETID = B.SETID AND A.VENDOR_ID = B.VENDOR_ID AND B.EFFDT = (SELECT MAX(B_ED.EFFDT) FROM PS_VENDOR_ADDR B_ED WHERE B.SETID = B_ED.SETID AND B.VENDOR_ID = B_ED.VENDOR_ID AND E.PYMNT_METHOD = 'CHK' AND B.ADDRESS_SEQ_NUM = B_ED.ADDRESS_SEQ_NUM and  C.CONTACT_NAME <> ' ' AND A.CUST_ID = ' ' AND B_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) AND A.SETID = C.SETID AND A.VENDOR_ID = C.VENDOR_ID AND C.EFFDT =(SELECT MAX(C_ED.EFFDT) FROM PS_VENDOR_CNTCT C_ED WHERE C.SETID = C_ED.SETID AND C.VENDOR_ID = C_ED.VENDOR_ID AND C.CNTCT_SEQ_NUM = C_ED.CNTCT_SEQ_NUM AND C_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) AND A.SETID = D.SETID AND A.VENDOR_ID = D.VENDOR_ID AND D.EFFDT =(SELECT MAX(D_ED.EFFDT) FROM PS_VENDOR_LOC D_ED WHERE D.SETID = D_ED.SETID AND D.VENDOR_ID = D_ED.VENDOR_ID AND D.VNDR_LOC = D_ED.VNDR_LOC AND D_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) AND A.VENDOR_STATUS = 'A') AND A.SETID = 'SHARE' "      
	
	'dbSupplier = dbGetFirstRecord(strSQL,sConnectionString, arrRecordValues, "Supplier Details" )
	Call  WriteToReport (micPass, "Query for Validating Supplier Information", "" & strSQL & "", False)
	GlobalDictionary("DBsheetname") = "Supplier Details" & srtBusinessValue
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbSupplier = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Supplier Details" & srtBusinessValue)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
		dbSupplier = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Supplier Details" & srtBusinessValue)
	Else
		dbSupplier = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Supplier Details" & srtBusinessValue)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetcustomerSuplier helps to get the Customer Information to tie to the Supplier from DB
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetcustomerSuplier(srtBusinessValue)
	Dim strSQL, sConnectionString, sheetName, supplier_id, arrRecordValues

	strSQL = "SELECT CUST_ID,CUST_FIELD_C6 AS HOME_BUSINESS_UNIT FROM PS_CUSTOMER WHERE VENDOR_ID = '' AND CUST_FIELD_C6 = '" & srtBusinessValue & "'"

	'dbSupplier = dbGetFirstRecord(strSQL,sConnectionString, arrRecordValues, "Supplier Details" )
	Call WriteToReport (micPass, "Query for Customer ID", strSQL, False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbgetcustomerSuplier = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer ID" & srtBusinessValue)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    dbgetcustomerSuplier = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer ID" & srtBusinessValue)
	Else
	    dbgetcustomerSuplier = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer ID" & srtBusinessValue)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetcustomerConvo helps to get the Customer conversation Information from DB
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: changed to 3 in query as per rini
'Date of Change 	Author 		Description of change
' venu
'**************************************************************************************************************
Public Function dbgetcustomerConvo(srtBusinessValue)
	Dim strSQL, sConnectionString, sheetName, supplier_id, arrRecordValues

'strSQL = "SELECT A.SETID, A.BUSINESS_UNIT, A.CUST_ID, B.PROMISE_AMT as REFERENCE_AMOUNT, A.CONVER_DTTM, B.CONVER_SUBJECT, B.CONVER_SUB_TOPIC, (CONVERT(CHAR(10),B.REVIEW_NEXT_DT,121)) AS NEXT_REVIEW_DATE, B.PROMISE_TO_PAY, (CONVERT(CHAR(10),B.PROMISE_DT,121)) AS PROMISE_DATE, A.CONTACT_ID, A.DESCRLONG, B.FOLLOW_UP_ACTION, B.FOLLOW_UP_OPRID, B.PAY_PROMISE_AMT, B.CURRENCY_CD, A.CONVER_SEQ_NUM, A.LAST_UPDATE_DTTM, B.OPRID, B.OPRID_LAST_UPDT, B.SUP_REVIEW, B.PROMISE_ACTION, B.LETTER_CD, B.REVIEW_OPRID, B.KEYWORD1, B.KEYWORD2, B.KEYWORD3  FROM PS_CUST_CONVER A, PS_CUST_CONVER_HDR B, PS_CUST_CONVER_DTL C WHERE (  A.SETID = B.SETID  AND A.BUSINESS_UNIT='srtBusinessValue& "'    AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.CUST_ID = B.CUST_ID  AND A.CONVER_DTTM_INIT = B.CONVER_DTTM_INIT  AND A.CONVER_DT = B.CONVER_DT  AND B.SETID = C.SETID   AND B.BUSINESS_UNIT = C.BUSINESS_UNIT  AND B.CUST_ID = C.CUST_ID   AND B.CONVER_DTTM_INIT = C.CONVER_DTTM_INIT  AND B.CONVER_DT = C.CONVER_DT)   ORDER BY 3 DESC"
 '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
 strSQL = "SELECT DISTINCT A.SETID, A.BUSINESS_UNIT, A.CUST_ID, B.CONVER_STATUS,  C.CONVR_QUAL_FIELD AS ITEM_ID, B.PROMISE_AMT as REFERENCE_AMOUNT, A.CONVER_DTTM, B.CONVER_SUBJECT, " & _
            "B.CONVER_SUB_TOPIC, (CONVERT(CHAR(10),B.REVIEW_NEXT_DT,121)) AS NEXT_REVIEW_DATE, B.PROMISE_TO_PAY, " & _ 
            "(CONVERT(CHAR(10),B.PROMISE_DT,121)) AS PROMISE_DATE, A.CONTACT_ID, A.DESCRLONG, B.FOLLOW_UP_ACTION, B.FOLLOW_UP_OPRID, " & _ 
            "B.PAY_PROMISE_AMT, B.CURRENCY_CD, A.CONVER_SEQ_NUM, A.LAST_UPDATE_DTTM, B.OPRID, B.OPRID_LAST_UPDT, B.SUP_REVIEW, B.PROMISE_ACTION, " & _
			"B.LETTER_CD, B.REVIEW_OPRID, B.KEYWORD1, B.KEYWORD2, B.KEYWORD3 " & _ 
			"FROM PS_CUST_CONVER A, PS_CUST_CONVER_HDR B, PS_CUST_CONVER_DTL C , PS_ITEM D " & _
			"WHERE ( A.SETID = B.SETID AND A.BUSINESS_UNIT='" & srtBusinessValue & "' AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.CUST_ID = B.CUST_ID " & _
			"AND A.CONVER_DTTM_INIT = B.CONVER_DTTM_INIT AND A.CONVER_DT = B.CONVER_DT AND B.SETID = C.SETID AND B.BUSINESS_UNIT = C.BUSINESS_UNIT AND B.CUST_ID = C.CUST_ID " & _
			"AND B.CONVER_DTTM_INIT = C.CONVER_DTTM_INIT AND B.CONVER_DT = C.CONVER_DT) " & _
			"AND B.PROMISE_AMT <> 0 " & _ 
			"AND A.BUSINESS_UNIT = D.BUSINESS_UNIT " & _
			"AND A.CUST_ID = D.CUST_ID " & _
			"AND C.CONVR_QUAL_FIELD = D.ITEM " & _
			"AND D.ITEM_STATUS = 'O' " & _
			"AND A.CUST_ID <> '0324142' " & _
			"AND B.CONVER_SUBJECT <>'' " & _
			"GROUP BY A.SETID, A.BUSINESS_UNIT, A.CUST_ID, B.CONVER_STATUS,  C.CONVR_QUAL_FIELD, B.PROMISE_AMT, A.CONVER_DTTM, B.CONVER_SUBJECT, " & _
			"B.CONVER_SUB_TOPIC, (CONVERT(CHAR(10),B.REVIEW_NEXT_DT,121)), B.PROMISE_TO_PAY, " & _
			"(CONVERT(CHAR(10),B.PROMISE_DT,121)), A.CONTACT_ID, A.DESCRLONG, B.FOLLOW_UP_ACTION, B.FOLLOW_UP_OPRID, " & _ 
			"B.PAY_PROMISE_AMT, B.CURRENCY_CD, A.CONVER_SEQ_NUM, A.LAST_UPDATE_DTTM, B.OPRID, B.OPRID_LAST_UPDT, B.SUP_REVIEW, B.PROMISE_ACTION, " & _
			"B.LETTER_CD, B.REVIEW_OPRID, B.KEYWORD1, B.KEYWORD2, B.KEYWORD3 " & _ 
			"HAVING A.LAST_UPDATE_DTTM IN (SELECT MAX(A.LAST_UPDATE_DTTM) FROM PS_CUST_CONVER A1 WHERE A.SETID = A1.SETID AND A.BUSINESS_UNIT = A1.BUSINESS_UNIT AND A.CUST_ID = A1.CUST_ID) " & _
			"order by 1,2,3, 4, 5 "
 
	 ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	 Call  WriteToReport (micPass, "Query for Customer ID", "" & strSQL & "", False)
	 GlobalDictionary("DBsheetname") = "Customer Conversation Information_" & srtBusinessValue
	 If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    dbgetcustomerConvo = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer Conversation Information_" & srtBusinessValue)
	 ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    dbgetcustomerConvo = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer Conversation Information_" & srtBusinessValue) 
	 Else
	    dbgetcustomerConvo = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer Conversation Information_" & srtBusinessValue)
	 End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetrmssupressinclusion helps to get the Customer conversation Information from DB
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetrmssupressinclusion(srtBusinessValue)
	Dim strSQL, sConnectionString, sheetName, supplier_id, arrRecordValues

	strSQL = "SELECT A.CUST_FIELD_C6 as Home_Business_Unit, A.CUST_ID, A.NAME1, A.CUST_STATUS, A.CUST_FIELD_C6 as Home_Business_Unit,  B.COLLECTOR, B.AR_SPECIALIST, C.BUSINESS_UNIT FROM PS_CUSTOMER A, PS_CUST_OPTION B, PS_ITEM C WHERE CUST_STATUS = 'A' AND A.CUST_ID = B.CUST_ID AND A.CUST_ID = C.CUST_ID AND C.BAL_AMT <> '0' AND A.CUST_FIELD_C6 = '" & srtBusinessValue& "' ORDER BY A.CUST_FIELD_C6, A.CUST_ID"
	Call  WriteToReport (micPass, "Query for Customer ID", "" & strSQL & "", False)
	GlobalDictionary("DBsheetname") = "Customer Information_" & srtBusinessValue
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbgetrmssupressinclusion = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer Information_" & srtBusinessValue)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
		dbgetrmssupressinclusion = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer Information_" & srtBusinessValue) 
	Else
		dbgetrmssupressinclusion = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer Information_" & srtBusinessValue)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetJournalId helps to get the Journal ID 
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Dec-2015</datecreated>
''' <param name="ProcessInstance" type="string">Process Instance </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetJournalId(ProcessInstance)
	Dim strSQL, sConnectionString, sheetName, supplier_id, arrRecordValues

	strSQL = "Select distinct JOURNAL_ID FROM PS_JRNL_LN WHERE PROCESS_INSTANCE ='" & ProcessInstance & "' "
	Call  WriteToReport (micPass, "Query for Journal ID", "" & strSQL & "", False)
	GlobalDictionary("DBsheetname") = "JournalID_" & ProcessInstance
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    GlobalDictionary("JournalID") = dbGetSingleFieldValue(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "JournalID_" & ProcessInstance)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    GlobalDictionary("JournalID") = dbGetSingleFieldValue(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "JournalID_" & ProcessInstance)
	Else
	     GlobalDictionary("JournalID") = dbGetSingleFieldValue(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "JournalID_" & ProcessInstance)    
	End If

	dbGetJournalId = GlobalDictionary("JournalID")
End Function

'**************************************************************************************************************
''' <summary> 
''' vattaxBusiness is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function vattaxBusiness()
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "SELECT * FROM PS_CDW_BI_VAT_ACDP "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'vattaxBusiness = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "BUSINESS_UNIT")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    vattaxBusiness = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data", "BUSINESS_UNIT")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    vattaxBusiness = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data", "BUSINESS_UNIT")
	Else
	    vattaxBusiness = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data", "BUSINESS_UNIT")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' vattaxState is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function vattaxState()
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "SELECT * FROM PS_CDW_BI_VAT_ACDP "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'vattaxState = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "CC_STATE")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    vattaxState = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data", "CC_STATE")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    vattaxState = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data", "CC_STATE")
	Else
	    vattaxState = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data", "CC_STATE")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' vattaxAuth is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function vattaxAuth()
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "SELECT * FROM PS_CDW_BI_VAT_ACDP "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'vattaxAuth = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "TAX_AUTHORITY_CD")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    vattaxAuth = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data", "TAX_AUTHORITY_CD")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    vattaxAuth = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data", "TAX_AUTHORITY_CD")
	Else
	    vattaxAuth = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data", "TAX_AUTHORITY_CD")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' vattaxAcctFrom is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function vattaxAcctFrom()
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT * FROM PS_CDW_BI_VAT_ACDP "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	'vattaxAcctFrom = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "ACCOUNT_FROM")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    vattaxAcctFrom = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data", "ACCOUNT_FROM")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    vattaxAcctFrom = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data", "ACCOUNT_FROM")
	Else
	    vattaxAcctFrom = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data", "ACCOUNT_FROM")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' vattaxDeptFrom is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function vattaxDeptFrom()
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT * FROM PS_CDW_BI_VAT_ACDP "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'vattaxDeptFrom = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "DEPTID_FROM")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    vattaxDeptFrom = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data", "DEPTID_FROM")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    vattaxDeptFrom = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data", "DEPTID_FROM")
	Else
	    vattaxDeptFrom = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data", "DEPTID_FROM")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' vattaxTargetauth is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function vattaxTargetauth()
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT * FROM PS_CDW_BI_VAT_ACDP "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'vattaxTargetauth = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "TAX_SCHEDULE_BASIS")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    vattaxTargetauth = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data", "TAX_SCHEDULE_BASIS")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    vattaxTargetauth = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data", "TAX_SCHEDULE_BASIS")
	Else
	    vattaxTargetauth = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data", "TAX_SCHEDULE_BASIS")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' vattaxAcctTO is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function vattaxAcctTO()
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT * FROM PS_CDW_BI_VAT_ACDP "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'vattaxAcctTO = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "ACCOUNT_TO")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    vattaxAcctTO = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data", "ACCOUNT_TO")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    vattaxAcctTO = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data", "ACCOUNT_TO")
	Else
	    vattaxAcctTO = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data", "ACCOUNT_TO")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' vattaxDeptTO is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function vattaxDeptTO()
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT * FROM PS_CDW_BI_VAT_ACDP "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'vattaxDeptTO = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "DEPTID_TO")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    vattaxDeptTO = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data", "DEPTID_TO")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    vattaxDeptTO = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data", "DEPTID_TO")
	Else
	    vattaxDeptTO = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data", "DEPTID_TO")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' vatinvoiceid is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function vatinvoiceid(buin)
	Dim sSQL
	Dim arrRecordValues()	

	sSQL = "SELECT * FROM PS_BI_HDR WHERE BUSINESS_UNIT = ('" & buin & "') " & _
	"AND BILL_STATUS = 'INV'"
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'vatinvoiceid = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    vatinvoiceid = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data" & buin)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    vatinvoiceid = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data" & buin)
	Else
	    vatinvoiceid = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data" & buin)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' emailinvoiceid is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function emailinvoiceid(buin)
	Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT TOP 5 INVOICE FROM PS_BI_HDR WHERE BUSINESS_UNIT = ('" & buin & "') " & _
	"AND BILL_STATUS = 'INV' AND INVOICE_AMOUNT > 500"
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'emailinvoiceid = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "INVOICE")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    emailinvoiceid = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data", "INVOICE")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    emailinvoiceid = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data", "INVOICE")
	Else
	    emailinvoiceid = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data", "INVOICE")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' invicesingline is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function invicesingline(buin)
	Dim sSQL
    Dim arrRecordValues()

	sSQL = "SELECT BUSINESS_UNIT, INVOICE, LATEST_LINE_SEQ, UNIT_AMT, COUNT(*) AS COUNT_OF_LINES FROM PS_BI_LINE WHERE( UNIT_AMT > 0 AND BUSINESS_UNIT = ('" & buin & "') AND INVOICE LIKE 'ZR%' AND LATEST_LINE_SEQ = '1') GROUP BY BUSINESS_UNIT, INVOICE,LATEST_LINE_SEQ, UNIT_AMT HAVING COUNT(*) = 1"
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'invicesingline = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data", "INVOICE")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    invicesingline = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data" & buin)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    invicesingline = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data" & buin)
	Else
	    invicesingline = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data" & buin)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' lineinfovalidate is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="invoice" type="string">invoice id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function lineinfovalidate(invoice)
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "SELECT A.BUSINESS_UNIT, A.INVOICE, A.BILL_TO_CUST_ID, A.BILL_STATUS, B.NAME1, C.DESCR, C.LINE_SEQ_NUM, C.IDENTIFIER, C.INVOICE_LINE, C.QTY, C.UNIT_OF_MEASURE, C.UNIT_AMT, C.GROSS_EXTENDED_BSE, C.NET_EXTENDED_BSE, C.TAX_AMT " & _
	"FROM PS_BI_HDR A, PS_CUSTOMER B, PS_BI_LINE C " & _
	"WHERE ( A.BUSINESS_UNIT = C.BUSINESS_UNIT " & _
	"AND A.BILL_TO_CUST_ID = B.CUST_ID " & _
	"AND A.INVOICE = C.INVOICE " & _
	"AND A.INVOICE = '" & invoice & "') "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'lineinfovalidate = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    lineinfovalidate = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data" & invoice)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    lineinfovalidate = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data" & invoice)
	Else
	    lineinfovalidate = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data" & invoice)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' invicesinglinegreater is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function invicesinglinegreater(buin)
	Dim sSQL
	Dim arrRecordValues()	

	sSQL = "SELECT BUSINESS_UNIT, INVOICE, LATEST_LINE_SEQ, UNIT_AMT, COUNT(*) AS COUNT_OF_LINES FROM PS_BI_LINE WHERE( UNIT_AMT < 0 AND BUSINESS_UNIT = ('" & buin & "') AND INVOICE LIKE 'ZR%' AND LATEST_LINE_SEQ = '1') GROUP BY BUSINESS_UNIT, INVOICE,LATEST_LINE_SEQ, UNIT_AMT HAVING COUNT(*) = 1"
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'invicesinglinegreater = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_data", "INVOICE")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    invicesinglinegreater = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "bank_data" & buin)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    invicesinglinegreater = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "bank_data" & buin)
	Else
	    invicesinglinegreater = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "bank_data" & buin)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' lineinfotaxsumz is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function lineinfotaxsumz(buin)
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "select DISTINCT TOP 10 A.BUSINESS_UNIT, A.INVOICE, A.INVOICE_AMOUNT AS TOT_AMT,A.TOT_SU_TAX as TAX_AMT, COUNT(*) AS NUMBER_OF_LINES from PS_BI_HDR A, PS_BI_LINE B " & _
	"WHERE A.TOT_SU_TAX <>'0' AND A.BUSINESS_UNIT = '" & buin & "' " & _
	"AND A.BUSINESS_UNIT = B.BUSINESS_UNIT " & _
	"AND A.INVOICE = B.INVOICE " & _
	"GROUP BY A.BUSINESS_UNIT, A.INVOICE, A.INVOICE_AMOUNT, A.TOT_SU_TAX " & _
	"HAVING COUNT(*) > 1 "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'lineinfotaxsumz = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_data", "INVOICE")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    lineinfotaxsumz = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_data", "INVOICE")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    lineinfotaxsumz = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_data", "INVOICE")
	Else
	    lineinfotaxsumz = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_data", "INVOICE")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' invoicereprintverfy is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function invoicereprintverfy(buin)
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT TOP 20 BUSINESS_UNIT, BILL_TO_CUST_ID, INVOICE, BILL_STATUS FROM PS_BI_HDR WHERE " & _
	"BUSINESS_UNIT IN ('" & buin & "') " & _
	"AND BILL_STATUS = 'INV' "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'invoicereprintverfy = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_data", "BILL_TO_CUST_ID")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    invoicereprintverfy = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_data", "BILL_TO_CUST_ID")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    invoicereprintverfy = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_data", "BILL_TO_CUST_ID")
	Else
	    invoicereprintverfy = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_data", "BILL_TO_CUST_ID")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' invoicereprintverfyinvc is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function invoicereprintverfyinvc(buin)
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT BUSINESS_UNIT, BILL_TO_CUST_ID, INVOICE, BILL_STATUS FROM PS_BI_HDR WHERE " & _
	"BUSINESS_UNIT IN ('" & buin & "') " & _
	"AND BILL_STATUS = 'INV' "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'invoicereprintverfyinvc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_data", "INVOICE")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    invoicereprintverfyinvc = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_data", "INVOICE")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    invoicereprintverfyinvc = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_data", "INVOICE")
	Else
	    invoicereprintverfyinvc = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_data", "INVOICE")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' invoicereprintverfyinvc1 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'15Feb2019			Eric Trout	Updated Returned columns for new validation of Reprint
'**************************************************************************************************************
Public Function invoicereprintverfyinvc1(buin)
    Dim sSQL
    Dim arrRecordValues()    

	sSQL ="SELECT A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, A.INVOICE_DT, A.BILL_STATUS, A.BI_CURRENCY_CD, A.DUE_DT, A.INVOICE_AMOUNT, A.* " &_
	"FROM PS_BI_HDR A, PS_ITEM B " &_
	"WHERE A.BUSINESS_UNIT IN ('" & buin & "') AND A.BILL_STATUS = 'INV' AND A.ADJUSTED_FLAG = 'N' AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.INVOICE = B.ITEM AND B.BAL_AMT <> 0 AND PRIOR_ADJ_INVOICE = '' AND NEXT_ADJ_INVOICE = ''"
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'invoicereprintverfyinvc1 = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_data", "INVOICE")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    invoicereprintverfyinvc1 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_data")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    invoicereprintverfyinvc1 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_data")
	Else
	    invoicereprintverfyinvc1 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_data")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' custcc4 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function custcc4(buin)
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT * FROM PS_BI_HDR WHERE PAYMENT_METHOD = 'CC' " & _
	"AND BUSINESS_UNIT IN ('" & buin & "') " & _
	"AND INVOICE LIKE 'ZR%' "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'custcc4 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "bank_data")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    custcc4 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_data" & buin)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    custcc4 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_data" & buin)
	Else
	    custcc4 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_data" & buin)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchNewCustProperties11 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="custID" type="string">Customer id </param>
''' <param name="loc" type="string">location id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchNewCustProperties11(custID, loc)
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "SELECT DISTINCT A.CUST_ID, A.NAME1, A.CURRENCY_CD,A.CUST_FIELD_C1_A, A.CUST_FIELD_C1_B, A.CUST_FIELD_C1_C,A.CUST_FIELD_C6,B.ADDRESS_SEQ_NUM AS LOCATION, B.ADDRESS1, B.ADDRESS2, B.ADDRESS3, B.CITY, B.COUNTY, B.STATE, B.POSTAL, B.GEO_CODE, B.COUNTRY_CODE, D.CR_LIMIT, F.TAX_EXEMPT_FLAG, F.EXEMPT_CATEGORY,F.DESCR, G.AR_SPECIALIST,G.COLLECTOR,H.SUPPORT_TEAM_CD " & _
	   "FROM PS_CUSTOMER A " & _ 
	   "LEFT OUTER JOIN PS_CUST_ADDRESS B ON  A.SETID = B.SETID AND A.CUST_ID = B.CUST_ID " & _ 
	   "LEFT OUTER JOIN PS_CUST_CREDIT D ON  A.SETID = D.SETID AND A.CUST_ID = D.CUST_ID " & _
	   "LEFT OUTER JOIN PS_CUST_EXEMPT_DTL F ON  A.SETID = F.SETID AND A.CUST_ID = F.CUST_ID " & _
	   "LEFT OUTER JOIN PS_CUST_OPTION  G ON A.SETID = G.SETID AND A.CUST_ID = G.CUST_ID " & _
	   "LEFT JOIN PS_CUST_TEAM H ON A.SETID = H.SETID AND A.CUST_ID = H.CUST_ID " & _
	   "WHERE A.CUST_ID = '" & custID & "' AND B.ADDRESS_SEQ_NUM = '" & loc & "'"
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    dbFetchNewCustProperties11 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "custinfo_data" & custID)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    dbFetchNewCustProperties11 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "custinfo_data" & custID)
	Else
	    dbFetchNewCustProperties11 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "custinfo_data" & custID)
	End If
	'dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_data", "INVOICE")
End Function

'**************************************************************************************************************
''' <summary> 
''' lineinfotaxsumz111 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function lineinfotaxsumz111(buin)
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "select BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM, sum(TAX_PCT) as TAX_PCT from PS_BI_LINE_TAX_DTL " & _
 	   	"WHERE BUSINESS_UNIT = '" & buin & "' " & _
		"GROUP BY BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111 = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "INVOICE")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    lineinfotaxsumz111 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "custinfo_data" & buin)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    lineinfotaxsumz111 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "custinfo_data" & buin)
	Else
	    lineinfotaxsumz111 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "custinfo_data" & buin)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' lineinfotaxsumz111perc is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function lineinfotaxsumz111perc(biun)
    Dim sSQL
    Dim arrRecordValues()

	sSQL = "select BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM, sum(TAX_PCT) as TAX_PCT  from PS_BI_LINE_TAX_DTL " & _
     	"WHERE BUSINESS_UNIT = '" & biun& "' " & _
   		"GROUP BY BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info", "TAX_PCT")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info", "TAX_PCT")
	Else
	    lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info", "TAX_PCT")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchVertexIntegration is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="unit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchVertexIntegration(unit)
	Err.Clear
	On Error Resume Next
	Dim sSQL
	Dim arrRecordValues()
	
   	sSQL = "SELECT A.BUSINESS_UNIT, A.INVOICE,A.TOT_SU_TAX, A.INVOICE_AMT_PRETAX, A.TOT_SU_TAX AS TAX_AMT FROM PS_BI_HDR A " & _
		"WHERE A.TOT_SU_TAX <>'0' AND A.BUSINESS_UNIT = '" & unit & "' "
    WriteToReport micDone, "SQL query for Invoice Number", "Query used for Invoice Number info is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbFetchVertexIntegration = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "InvoiceNumber_Info_" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then    
		dbFetchVertexIntegration = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "InvoiceNumber_Info_" & unit)        
	Else
		dbFetchVertexIntegration = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "InvoiceNumber_Info_" & unit)
	End If

	On Error goto 0
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchCreditCardTranHis is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchCreditCardTranHis(unit)
	Err.Clear
	On Error Resume Next
	Dim sSQL
	Dim arrRecordValues()

   	sSQL = "SELECT * FROM PS_CRCARD_HST WHERE BUSINESS_UNIT = '" & unit & "' AND INVOICE <> 'EN00000003'"
    WriteToReport micDone, "SQL query for Customer CC Transaction History ", "Query used for Customer CC Transaction History is " & sSQL, False

 	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchCreditCardTranHis = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "CCTranHist_Info_" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then   
        dbFetchCreditCardTranHis = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "CCTranHist_Info_" & unit)
    Else
        dbFetchCreditCardTranHis = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "CCTranHist_Info_" & unit)
    End If

	On Error goto 0    
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchFinzBillCredEntireBill is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchFinzBillCredEntireBill(unit)
	Err.Clear
	On Error Resume Next
    Dim sSQL
    Dim arrRecordValues()

    sSQL = "SELECT A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, A.INVOICE_DT, A.BILL_STATUS, A.* FROM PS_BI_HDR A, PS_ITEM B WHERE A.BUSINESS_UNIT IN ('" & unit & "') AND A.BILL_STATUS = 'INV' AND A.ADJUSTED_FLAG = 'N' AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.INVOICE = B.ITEM AND B.BAL_AMT <> 0 AND PRIOR_ADJ_INVOICE = '' AND NEXT_ADJ_INVOICE = ''"
    WriteToReport micDone, "SQL query for Finalized Bill - Credit Entire Bill ", "Query used for Finalized Bill - Credit Entire Bill is " & sSQL, False

    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchFinzBillCredEntireBill = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "FinzBill_Info_" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then      
        dbFetchFinzBillCredEntireBill = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "FinzBill_Info_" & unit)	
    Else
        dbFetchFinzBillCredEntireBill = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "FinzBill_Info_" & unit)
    End If

	On Error GoTo 0
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchRfndCrdBalCC is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchRfndCrdBalCC(unit)
	Err.Clear
	On Error Resume Next
	Dim sSQL
	Dim arrRecordValues()
	
   sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, R.INVOICE, Q.ITEM_STATUS " & _
		"FROM PS_ITEM Q , PS_BI_HDR R " & _
		"WHERE Q.BAL_AMT < 0 " & _
		"AND Q.CUST_ID = R.BILL_TO_CUST_ID " & _ 
		"AND R.INVOICE = Q.INVOICE " & _
		"AND Q.BUSINESS_UNIT = '" & unit & "' " & _
		"AND Q.ENTRY_TYPE = 'CR' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _ 
		"AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) " & _
		"AND Q.ITEM NOT IN ( " & _
		"(SELECT  B.ITEM " & _
		  "FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D " & _ 
		  "WHERE ( A.WS_BU = B.WS_BU " & _
		     "AND A.WS_ID = B.WS_ID " & _
		     "AND C.SETCNTRLVALUE = B.BUSINESS_UNIT " & _
		     "AND C.RECNAME = 'CUSTOMER' " & _
		     "AND D.SETID = C.SETID " & _
		     "AND D.CUST_ID = B.CUST_ID " & _
		     "AND B.ITEM_SELECTED = 'Y' " & _
		     "AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _
		     "AND B.ITEM = Q.ITEM))) " & _
		"AND Q.ITEM NOT IN " & _
		"(SELECT  F.ITEM " & _
		  "FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H " & _ 
		  "WHERE ( E.TRN_BU = F.TRN_BU " & _
		     "AND E.TRN_ID = F.TRN_ID " & _
		     "AND F.ITEM_SELECTED = 'Y' " & _
		     "AND G.SETCNTRLVALUE = F.BUSINESS_UNIT " & _
		     "AND G.RECNAME = 'CUSTOMER' " & _
		     "AND H.SETID = G.SETID " & _
		     "AND H.CUST_ID = F.CUST_ID " & _
		     "AND F.ITEM = Q.ITEM " & _
		     "AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT)) " & _
		       "AND Q.ITEM NOT IN " & _
		        "(SELECT J.ITEM " & _
		  "FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L " & _ 
		  "WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU " & _
		     "AND I.DEPOSIT_ID = J.DEPOSIT_ID " & _
		     "AND J.ITEM_SELECTED = 'Y' " & _
		     "AND K.SETCNTRLVALUE = J.BUSINESS_UNIT " & _
		     "AND K.RECNAME = 'CUSTOMER' " & _
		     "AND L.SETID = K.SETID " & _
		     "AND L.CUST_ID = J.CUST_ID " & _
		     "AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _
		     "AND J.ITEM = Q.ITEM)) " & _
		       "AND Q.ITEM NOT IN " & _
		        "(SELECT N.ITEM " & _
		  "FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P " & _ 
		  "WHERE ( M.GROUP_BU = N.GROUP_BU " & _
		     "AND M.GROUP_ID = N.GROUP_ID " & _
		     "AND O.SETCNTRLVALUE = N.BUSINESS_UNIT " & _
		     "AND O.RECNAME = 'CUSTOMER' " & _
		     "AND P.SETID = O.SETID " & _
		     "AND P.CUST_ID = N.CUST_ID " & _
		     "AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _
		     "AND N.ITEM = Q.ITEM " & _
		     "AND N.POST_DT IS NULL))"
    WriteToReport micDone, "SQL query for Refund Credit Balance to Credit Card - Credit Entire Bill ", "Query used for Refund Credit Balance to Credit Card is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchRfndCrdBalCC = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "RfndCrdBalCC_Info" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
        dbFetchRfndCrdBalCC = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "RfndCrdBalCC_Info" & unit)    
    Else
        dbFetchRfndCrdBalCC = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "RfndCrdBalCC_Info" & unit)
    End If

	On Error goto 0  
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchPayMulItemsbyCC is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
'Public Function dbFetchPayMulItemsbyCC(unit)
'	Err.Clear
'On Error Resume Next
'
'	Dim sSQL
'	Dim arrRecordValues()
'	
'	sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.BAL_AMT, R.INVOICE, Q.ITEM_STATUS " & _
'		"FROM PS_ITEM Q , PS_BI_HDR R " & _
'		"WHERE Q.BAL_AMT > 0 " & _ 
'		"AND Q.CUST_ID = R.BILL_TO_CUST_ID " & _
'		"AND R.INVOICE = Q.INVOICE " & _
'		"AND Q.BUSINESS_UNIT ='" & unit & "' " & _ 
'		"AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _
'		"AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) " & _
'		"AND Q.ITEM NOT IN ( " & _
'		"(SELECT B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM))) AND Q.ITEM NOT IN " & _
'		"(SELECT F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE(E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT)) AND Q.ITEM NOT IN (SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM)) " & _  
'		 "AND Q.ITEM NOT IN " & _ 
'		 "(SELECT N.ITEM " & _
'		 "FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P " & _ 
'		"WHERE ( M.GROUP_BU = N.GROUP_BU " & _
'		"AND M.GROUP_ID = N.GROUP_ID " & _ 
'		"AND O.SETCNTRLVALUE = N.BUSINESS_UNIT " & _ 
'		"AND O.RECNAME = 'CUSTOMER' " & _ 
'		"AND P.SETID = O.SETID " & _ 
'		"AND P.CUST_ID = N.CUST_ID " & _ 
'		"AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _ 
'		"AND N.ITEM = Q.ITEM " & _ 
'		"AND N.POST_DT IS NULL)) "
'	
''           sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.ENTRY_TYPE, Q.BAL_AMT FROM PS_ITEM Q , PS_BI_HDR R WHERE Q.BAL_AMT > 0 " & _ 
''"AND Q.BUSINESS_UNIT = '00001' " & _ 
''"AND Q.CUST_ID IN (SELECT CUST_ID FROM PS_ITEM A WHERE A.BAL_AMT > 0 " & _ 
''"GROUP BY CUST_ID " & _ 
''"HAVING COUNT(A.ITEM) = 2) " & _ 
''"AND Q.CUST_ID = R.BILL_TO_CUST_ID AND R.INVOICE LIKE 'ZR%' AND Q.ENTRY_TYPE = 'IN' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _ 
''"AND Q.ITEM NOT IN ( (SELECT B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D " & _ 
''"WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' " & _ 
''"AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM) UNION SELECT F.ITEM FROM " & _ 
''"PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND " & _ 
''"G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT) " & _ 
''  "UNION SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID " & _ 
''  "AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _ 
''  "AND J.ITEM = Q.ITEM) UNION SELECT N.ITEM FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID " & _ 
''   "AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM " & _ 
''   "AND N.POST_DT IS NULL))) " & _ 
'' "GROUP BY  Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.ENTRY_TYPE, Q.BAL_AMT "
'      '''changing query as per rini 06/21
'
'      
'    WriteToReport micDone, "SQL query for Pay Multiple AR Items by Credit Card ", "Query used for Pay Multiple AR Items by Credit Card is sSQL, False
'    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
'        dbFetchPayMulItemsbyCC = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "PayMulItmsCC_Infounit)
'    Else
'        dbFetchPayMulItemsbyCC = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "PayMulItmsCC_Infounit)
'   End If
'    
'On Error goto 0  
'End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchInvoicePerc is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'05/13/2019			Zach A. 	Updated to order by FROM_DT DESC in order to use newer invoices
'**************************************************************************************************************
Public Function dbFetchInvoicePerc(unit)
	Dim sSQL
	Dim arrRecordValues()

   	sSQL = "select A.BUSINESS_UNIT, A.INVOICE, A.INVOICE_AMOUNT AS TOT_AMT, A.INVOICE_AMT_PRETAX, A.TOT_SU_TAX as TAX_AMT, * from PS_BI_HDR A WHERE A.TOT_SU_TAX <>'0' AND A.BUSINESS_UNIT = '" & unit & "' ORDER BY FROM_DT DESC"           
    WriteToReport micDone, "SQL query for Summarized Line Level Tax Percent", "Query used for Summarized Line Level Tax Percent is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchInvoicePerc = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Invoice_Info" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbFetchInvoicePerc = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Invoice_Info" & unit)	
    Else
        dbFetchInvoicePerc = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Invoice_Info" & unit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchInvoiceLine is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchInvoiceLine(unit)
	Err.Clear
	On Error Resume Next
	Dim sSQL
	Dim arrRecordValues()

   sSQL = "SELECT DISTINCT A.BUSINESS_UNIT, A.INVOICE, A.INVOICE_AMOUNT AS TOT_AMT, B.NET_EXTENDED_AMT, A.INVOICE_AMT_PRETAX, A.TOT_SU_TAX as TAX_AMT, COUNT(*) AS NUMBER_OF_LINES from PS_BI_HDR A, PS_BI_LINE B " & _ 
          "WHERE A.TOT_SU_TAX <>'0' AND A.BUSINESS_UNIT = '" & unit & "' " & _ 
          "AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.INVOICE <> 'FD1600100CN' " & _ 
          "AND A.INVOICE = B.INVOICE " & _ 
          "GROUP BY A.BUSINESS_UNIT, A.INVOICE, A.INVOICE_AMOUNT, A.INVOICE_AMT_PRETAX, A.TOT_SU_TAX,B.NET_EXTENDED_AMT " & _ 
          "HAVING COUNT(*) > 1"
    WriteToReport micDone, "SQL query for Summarized Line Level Tax Percent", "Query used for Summarized Line Level Tax Percent is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchInvoiceLine = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "InvoiceLine_Info" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then         
        dbFetchInvoiceLine = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "InvoiceLine_Info" & unit)	
    Else
        dbFetchInvoiceLine = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "InvoiceLine_Info" & unit)
    End If

	On Error goto 0
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchPercentage is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchPercentage(unit)
	Dim sSQL
	Dim arrRecordValues()

  	sSQL = "SELECT BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM, sum(TAX_PCT) from PS_BI_LINE_TAX_DTL " & _ 
          "WHERE BUSINESS_UNIT = '" & unit & "' " & _ 
          "GROUP BY BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM" 
    WriteToReport micDone, "SQL query to fetch Tax Percentage", "Query used to fetch Tax Percentage is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchPercentage = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "TaxPecent_Info" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbFetchPercentage = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "TaxPecent_Info" & unit)      
    Else
        dbFetchPercentage = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "TaxPecent_Info" & unit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchInvNoLngPendgCreditInfo is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchInvNoLngPendgCreditInfo(unit, invoice)
	Err.Clear
	On Error Resume Next
	Dim sSQL
	Dim arrRecordValues()
	
 	sSQL = "SELECT A.BUSINESS_UNIT, A.INVOICE, B.XLATLONGNAME AS CREDIT_CARD_TYPE, A.CR_CARD_DIGITS, A.CR_CARD_EXPMO, A.CR_CARD_EXPYR " & _ 
		"FROM PS_BI_HDR_CRCARD A, PSXLATITEM B " & _ 
		"WHERE A.BUSINESS_UNIT = '" & unit & "' AND A.INVOICE = '" & invoice & "' " & _ 
		"AND B.FIELDNAME = 'CR_CARD_TYPE' " & _ 
		"AND A.CR_CARD_TYPE = B.FIELDVALUE" 
     WriteToReport micDone, "SQL query for Customer Info", "Query used for Customer Info is " & sSQL, False
     If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchInvNoLngPendgCreditInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Credit_Info_" & unit)
      ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbFetchInvNoLngPendgCreditInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Credit_Info_" & unit)      
    Else
        dbFetchInvNoLngPendgCreditInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Credit_Info_" & unit)
    End If

	On Error goto 0    
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchEachBillLine is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchEachBillLine(line, invoice, unit)
	Dim sSQL
	Dim arrRecordValues()
	
	sSQL = "select DISTINCT A.BUSINESS_UNIT, A.INVOICE, A.INVOICE_AMOUNT AS TOT_AMT, B.NET_EXTENDED_AMT, B.LINE_SEQ_NUM, B.TAX_AMT, " & _ 
	      "A.INVOICE_AMT_PRETAX, A.TOT_SU_TAX as TAX_AMT, COUNT(*) AS NUMBER_OF_LINES " & _ 
	      "from PS_BI_HDR A, PS_BI_LINE B " & _ 
	      "WHERE A.TOT_SU_TAX <>'0' " & _ 
	      "AND A.BUSINESS_UNIT = B.BUSINESS_UNIT " & _ 
	      "AND A.INVOICE = B.INVOICE " & _ 
	      "AND A.BUSINESS_UNIT = '" & unit & "' " & _ 
	      "AND  A.INVOICE = '" & invoice & "' " & _ 
	      "AND LINE_SEQ_NUM = '" & line & "' " & _ 
	      "GROUP BY A.BUSINESS_UNIT, A.INVOICE, A.INVOICE_AMOUNT, A.INVOICE_AMT_PRETAX, A.TOT_SU_TAX,B.NET_EXTENDED_AMT, B.LINE_SEQ_NUM, B.TAX_AMT"
           
	WriteToReport micDone, "SQL query to fetch each bill line", "Query used to fetch each bill line is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbFetchEachBillLine = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "BillLine_" & unit & "_" & line)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
		dbFetchEachBillLine = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "BillLine_" & unit & "_" & line)     
	Else
		dbFetchEachBillLine = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "BillLine_" & unit & "_" & line)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchEachBillLine1 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchEachBillLine1(line,invoice,unit)
	Dim sSQL
	Dim arrRecordValues()

	sSQL = "SELECT BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM, sum(TAX_PCT)  from PS_BI_LINE_TAX_DTL " & _ 
		"WHERE BUSINESS_UNIT = '" & unit & "' " & _ 
		"AND LINE_SEQ_NUM = '" & line & "' " & _ 
		"AND INVOICE = '" & invoice & "' " & _ 
		"GROUP BY BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM"
	WriteToReport micDone, "SQL query to fetch each bill line", "Query used to fetch each bill line is " & sSQL, False

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbFetchEachBillLine1 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "BillLine_" & unit & "_" & line)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
		dbFetchEachBillLine1 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "BillLine_" & unit & "_" & line)
	Else
		dbFetchEachBillLine1 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "BillLine_" & unit & "_" & line)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetBillTrust is helper component to retreive the Invoice Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>18-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetBillTrust(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL ="select BILL_TO_MEDIA, ACCOUNTING_DT, * from PS_BI_HDR WHERE BILL_TO_MEDIA IN ('N', 'P')AND BUSINESS_UNIT = '" & srtBusinessValue & "'"
	Call  WriteToReport (micPass, "Query for Customer ID", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    dbgetBillTrust=dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Invoice Details " & srtBusinessValue )
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
	    dbgetBillTrust=dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Invoice Details " & srtBusinessValue )         
	Else
	    dbgetBillTrust=dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Invoice Details " & srtBusinessValue )
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetinvRBT is helper component to retreive the Invoice Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>18-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetinvRBT(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL ="SELECT A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, A.INVOICE_DT, A.BILL_STATUS, A.BI_CURRENCY_CD, A.DUE_DT, A.INVOICE_AMOUNT, A.* " &_
	"FROM PS_BI_HDR A, PS_ITEM B " &_
	"WHERE A.BUSINESS_UNIT IN ('" & srtBusinessValue & "') AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.BILL_TO_CUST_ID = B.CUST_ID AND A.INVOICE = B.ITEM AND A.BILL_STATUS = 'INV' AND A.INVOICE LIKE 'RB%' AND B.ITEM_STATUS = 'O' "
    Call  WriteToReport (micPass, "Query for Invoice ID", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetinvRBT=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Invoice Details " & srtBusinessValue )
  	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbgetinvRBT=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Invoice Details " & srtBusinessValue )      
    Else
        dbgetinvRBT=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Invoice Details " & srtBusinessValue )
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetinvZR is helper component to retreive the Invoice Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>20-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetinvZR(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL ="SELECT A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, A.INVOICE_DT, A.BILL_STATUS, A.BI_CURRENCY_CD, A.DUE_DT, A.INVOICE_AMOUNT, A.* " &_
	"FROM PS_BI_HDR A, PS_ITEM B " &_
	"WHERE A.BUSINESS_UNIT IN ('" & srtBusinessValue & "') AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.BILL_TO_CUST_ID = B.CUST_ID AND A.INVOICE = B.ITEM AND A.BILL_STATUS = 'INV' AND A.INVOICE LIKE 'ZR%' AND B.ITEM_STATUS = 'O' "
    Call  WriteToReport (micPass, "Query for Invoice ID", "" & strSQL& "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetinvZR=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Invoice Details" & srtBusinessValue )
      ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
         dbgetinvZR=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Invoice Details" & srtBusinessValue )     
    Else
        dbgetinvZR=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Invoice Details" & srtBusinessValue )
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetinvZR is helper component to retreive the Invoice Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>20-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetVerifyRebillsOrgINV(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

    strSQL = "SELECT A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, A.INVOICE_DT, A.BILL_STATUS, A.* FROM PS_BI_HDR A, PS_ITEM B " & _ 
		"WHERE A.BUSINESS_UNIT IN ('" & srtBusinessValue & "') " & _ 
		"AND A.BILL_STATUS = 'INV' " & _ 
		"AND A.ADJUSTED_FLAG = 'N' " & _ 
		"AND A.BUSINESS_UNIT = B.BUSINESS_UNIT " & _ 
		"AND A.INVOICE = B.ITEM AND B.BAL_AMT <> 0 " & _ 
		"AND PRIOR_ADJ_INVOICE = ''" & _ 
		"AND NEXT_ADJ_INVOICE = ''"
    Call  WriteToReport (micPass, "Query for Invoice ID", "" & strSQL & "", False)
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetVerifyRebillsOrgINV=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Invoice Details" & srtBusinessValue )
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbgetVerifyRebillsOrgINV=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Invoice Details" & srtBusinessValue )     
    Else
       dbgetVerifyRebillsOrgINV=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Invoice Details" & srtBusinessValue )
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetPaymentmethodCC is helper component to retreive the Customer Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>20-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetPaymentmethodCC(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL ="SELECT DISTINCT Top 1 A.BUSINESS_UNIT, A.CUST_ID, A.PAYMENT_METHOD, B.INVOICE, B.BILL_STATUS, C.IDENTIFIER, C.SHIP_TO_CUST_ID AS SHIP_TO, C.SHIP_TO_ADDR_NUM AS SHIP_TO_LOC, D.ACCOUNT, D.DEPTID FROM PS_ITEM A , PS_BI_HDR B, PS_BI_LINE C, PS_BI_LINE_DST D WHERE A.PAYMENT_METHOD = 'CC' AND A.BUSINESS_UNIT IN ('" & srtBusinessValue & "') AND A.ENTRY_TYPE = 'IN' AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.CUST_ID = B.BILL_TO_CUST_ID AND B.INVOICE LIKE 'ZR%' AND A.ITEM_STATUS = 'O' AND A.BUSINESS_UNIT = C.BUSINESS_UNIT AND B.INVOICE = C.INVOICE AND A.BUSINESS_UNIT = D.BUSINESS_UNIT AND B.INVOICE = D.INVOICE"
    Call  WriteToReport (micPass, "Query for Credit Card Info", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
         dbgetPaymentmethodCC=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
         dbgetPaymentmethodCC=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )     
    Else
         dbgetPaymentmethodCC=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetVerifyPendingcc is helper component to retreive the Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>23-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'16Apr2019			Eric Trout	Updated to account for if Invoice is empty
'**************************************************************************************************************
Public Function dbgetVerifyPendingcc(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL = "select * from  PS_INTFC_CRCARD WHERE BUSINESS_UNIT = '" & srtBusinessValue & "' and CR_CARD_NBR <> '' and INVOICE <> '' "
	Call  WriteToReport (micPass, "Query for Credit Card Info", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetVerifyPendingcc=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
        ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbgetVerifyPendingcc=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )        
    Else
        dbgetVerifyPendingcc=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetVerifyPendingcc1 is helper component to retreive the Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>23-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetVerifyPendingcc1(srtBusinessValue, invoice)
	Dim strSQL
	Dim arrRecordValues()

	strSQL = "SELECT A.BUSINESS_UNIT, A.INVOICE, B.XLATLONGNAME AS CREDIT_CARD_TYPE, A.* FROM PS_INTFC_CRCARD A, PSXLATITEM B WHERE A.BUSINESS_UNIT = '" & srtBusinessValue & "' AND A.INVOICE like '" & invoice & "' AND B.FIELDNAME = 'CR_CARD_TYPE' AND A.CR_CARD_TYPE = B.FIELDVALUE"
	Call  WriteToReport (micPass, "Query for Credit Card Info", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetVerifyPendingcc1=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
  	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbgetVerifyPendingcc1=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )     
    Else
        dbgetVerifyPendingcc1=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetreviewCCNumberappearsonBill is helper component to retreive the Credit Card Last four Digits from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>28-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetreviewCCNumberappearsonBill(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL = "SELECT A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, A.PAYMENT_METHOD, A.BILL_STATUS, C.XLATLONGNAME AS CREDIT_CARD_TYPE, B.CR_CARD_NBR, B.CR_CARD_DIGITS AS LAST_4_NUMBERS, B.CR_CARD_FNAME AS FIRSTNAME, B.CR_CARD_LNAME AS LAST_NAME, B.EMAILID, B.PHONE, B.CR_CARD_EXPMO, B.CR_CARD_EXPYR FROM PS_BI_HDR A, PS_BI_HDR_CRCARD B, PSXLATITEM C WHERE A.BUSINESS_UNIT = '" & srtBusinessValue & "' AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.INVOICE = B.INVOICE AND B.CR_CARD_TYPE = C.FIELDVALUE AND C.FIELDNAME = 'CR_CARD_TYPE'"	
	Call  WriteToReport (micPass, "Query for Customer Info", "" & strSQL& "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetreviewCCNumberappearsonBill=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbgetreviewCCNumberappearsonBill=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )    
    Else
        dbgetreviewCCNumberappearsonBill=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If	
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetPaymentmethodCC is helper component to retreive the Credit Card Last four Digits from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>15-Jan-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetDunningLetter(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL = "SELECT DISTINCT CUST_ID, ITEM FROM PS_ITEM WHERE BUSINESS_UNIT = '" & srtBusinessValue & "' AND BAL_AMT > 0 AND ASOF_DT < = '" & dateadd("d",-45,now) & "'"
	Call  WriteToReport (micPass, "Query for Customer Info", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetDunningLetter=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbgetDunningLetter=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )     
    Else
        dbgetDunningLetter=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetPaymentmethodCC is helper component to retreive the Credit Card Last four Digits from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>15-Jan-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="custid" type="string">Customer id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetDunningLetter1(srtBusinessValue,custid)
	Dim strSQL
	Dim arrRecordValues()

	strSQL = "SELECT DISTINCT CUST_ID, ITEM FROM PS_ITEM WHERE BUSINESS_UNIT = '" & srtBusinessValue & "' AND BAL_AMT > 0 AND ASOF_DT < = '" & dateadd("d",-45,now) & "' AND CUST_ID = 'custid& "'"
	Call  WriteToReport (micPass, "Query for Customer Info", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
         dbgetDunningLetter1=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
      ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
         dbgetDunningLetter1=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )      
    Else
         dbgetDunningLetter1=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If	
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetPaymentmethodCC is helper component to retreive the Credit Card Last four Digits from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>15-Jan-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetcustomersearchfunctnsARpages(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL = "SELECT DISTINCT C.BUSINESS_UNIT, A.CUST_ID,  B.CUST_STATUS FROM PS_CUST_ADDR_SEQ A, PS_CUSTOMER B, PS_ITEM C WHERE A.SHIP_TO_ADDR = 'Y' AND A.CUST_ID = B.CUST_ID AND A.CUST_ID = C.CUST_ID AND C.BAL_AMT > 0 AND C.BUSINESS_UNIT = '" & srtBusinessValue & "' AND B.CUST_STATUS = 'A' GROUP BY C.BUSINESS_UNIT, A.CUST_ID, B.CUST_STATUS HAVING COUNT(A.CUST_ID) > 1"
	Call  WriteToReport (micPass, "Query for Customer Info", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
         dbgetcustomersearchfunctnsARpages=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
         dbgetcustomersearchfunctnsARpages=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )     
    Else
         dbgetcustomersearchfunctnsARpages=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' reviewccdetailsdatarts is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function reviewccdetailsdatarts(biun)
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "SELECT A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, A.PAYMENT_METHOD, A.BILL_STATUS, C.XLATLONGNAME AS CREDIT_CARD_TYPE, B.CR_CARD_NBR, B.CR_CARD_DIGITS AS LAST_4_NUMBERS, B.CR_CARD_FNAME AS FIRSTNAME, B.CR_CARD_LNAME AS LAST_NAME, B.EMAILID, B.PHONE, B.CR_CARD_EXPMO, B.CR_CARD_EXPYR " & _
		"FROM PS_BI_HDR A, PS_BI_HDR_CRCARD B, PSXLATITEM C " & _
		"WHERE A.BUSINESS_UNIT = '" & biun & "' " & _
		"AND A.BUSINESS_UNIT = B.BUSINESS_UNIT " & _
		"AND A.INVOICE = B.INVOICE " & _
		"AND B.CR_CARD_TYPE = C.FIELDVALUE " & _   
		"AND C.FIELDNAME = 'CR_CARD_TYPE' "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	
	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
    	reviewccdetailsdatarts = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ccdetails" & biun)
 	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        reviewccdetailsdatarts = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ccdetails" & biun)
    Else
        reviewccdetailsdatarts = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ccdetails" & biun)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' ccoverbalcc is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'22June2018			Eric Trout	copy of ccoverbalcc due to differences needed in query
'**************************************************************************************************************
Public Function ccoverbalcc2(biun)
    Dim sSQL
    Dim arrRecordValues()	

	sSQL = "Select DISTINCT TOP 1 Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, R.INVOICE, Q.ITEM_STATUS, Q.PAYMENT_METHOD " & _
		"FROM PS_ITEM Q , PS_BI_HDR R " & _
		"WHERE Q.BAL_AMT >  0 " & _
		"AND Q.CUST_ID = R.BILL_TO_CUST_ID " & _
		"AND R.INVOICE = Q.INVOICE " & _
		"AND Q.BUSINESS_UNIT = '" & biun & "' " & _
		"AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _  
		"AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) " & _
      	"AND Q.ITEM NOT IN ((SELECT  B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM))) " & _ 
       	"AND Q.ITEM NOT IN (SELECT  F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT))AND Q.ITEM NOT IN (SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM))AND Q.ITEM NOT IN (SELECT N.ITEM FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL)) AND Q.CUST_ID<>7400434 "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        ccoverbalcc2 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ccdetails" & biun)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        ccoverbalcc2 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ccdetails" & biun)     
    Else
        ccoverbalcc2 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ccdetails" & biun)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' ccoverbalcc is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'22June2018			Eric Trout	Per Rini query updated due to this test requires CC Payment method only
'**************************************************************************************************************
Public Function ccoverbalcc(biun)
    Dim sSQL
    Dim arrRecordValues()
 
	sSQL = "Select DISTINCT TOP 1 Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, R.INVOICE, Q.ITEM_STATUS, Q.PAYMENT_METHOD " & _
	    "FROM PS_ITEM Q , PS_BI_HDR R " & _
		"WHERE Q.BAL_AMT >  0 " & _
		"AND Q.CUST_ID = R.BILL_TO_CUST_ID " & _
		"AND R.INVOICE = Q.INVOICE " & _
		"AND Q.BUSINESS_UNIT = '" & biun & "' " & _
		"AND Q.PAYMENT_METHOD= 'CC' " &_
		"AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _  
		"AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) " & _
      	"AND Q.ITEM NOT IN ((SELECT  B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM))) " & _ 
       "AND Q.ITEM NOT IN (SELECT  F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT))AND Q.ITEM NOT IN (SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM))AND Q.ITEM NOT IN (SELECT N.ITEM FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL)) AND Q.CUST_ID<>7400434 "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	
	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        ccoverbalcc = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ccdetails" & biun)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        ccoverbalcc = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ccdetails" & biun)     
    Else
        ccoverbalcc = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ccdetails" & biun)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' ccoverbalccitem4 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function ccoverbalccitem4(biun)
    Dim sSQL
    Dim arrRecordValues()

	sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, R.INVOICE, Q.ITEM_STATUS " & _
       "FROM PS_ITEM Q , PS_BI_HDR R " & _
      "WHERE Q.BAL_AMT >  0 " & _
      "AND Q.CUST_ID = R.BILL_TO_CUST_ID " & _
      "AND R.INVOICE = Q.INVOICE " & _
      "AND Q.BUSINESS_UNIT = '" & biun & "' " & _
      "AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _  
		"AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) " & _
      "AND Q.ITEM NOT IN ((SELECT  B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM))) " & _ 
       "AND Q.ITEM NOT IN (SELECT  F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT))AND Q.ITEM NOT IN (SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM))AND Q.ITEM NOT IN (SELECT N.ITEM FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL)) "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	
	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        ccoverbalccitem4 = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ccdetails", "ITEM")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        ccoverbalccitem4 = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ccdetails", "ITEM")    
    Else
        ccoverbalccitem4 = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ccdetails", "ITEM")
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' ccoverbalccPromisetoPay is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function ccoverbalccPromisetoPay(biun)
    Dim sSQL
    Dim arrRecordValues()
 
	sSQL = "SELECT A.BUSINESS_UNIT, A.CUST_ID, A.ITEM, B.CUST_STATUS, C.COLLECTOR " & _
       "FROM PS_ITEM A, PS_CUSTOMER B, PS_CUST_OPTION C " & _
      "WHERE A.CUST_ID = B.CUST_ID AND A.CUST_ID = C.CUST_ID " & _
      "AND A.BUSINESS_UNIT = '" & biun & "' " & _
      "AND A.BAL_AMT > 0 " & _
      "AND B.CUST_STATUS = 'A' "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        ccoverbalccPromisetoPay = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info" & biun)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        ccoverbalccPromisetoPay = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info" & biun)     
    Else
        ccoverbalccPromisetoPay = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info" & biun)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' customeriddata12 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function customeriddata12(biun)
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "SELECT BUSINESS_UNIT, CUST_ID, * FROM PS_CUST_CONVER_HDR WHERE BUSINESS_UNIT = '" & biun & "' " 
    WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
    
	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        customeriddata12 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info" & biun)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        customeriddata12 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info" & biun)     
    Else
        customeriddata12 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info" & biun)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' depositid1114 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function depositid1114(biun)
    Dim sSQL
    Dim arrRecordValues()
 
	sSQL = "SELECT * FROM PS_DEPOSIT_CONTROL WHERE BUSINESS_UNIT = '" & biun & "' AND DEP_POST_STATUS <> 'C' AND PAY_WS_TYPE= 'C' AND DEPOSIT_ID <> '10' " 
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	
	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        depositid1114 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info" & biun)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        depositid1114 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info" & biun)
    Else
    	depositid1114 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info" & biun)
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetUniqueCustIDConv is helper component to retreive the sigle row from database of unique customer ID 
''' </summary>
''' <author>Venu Arigela</author>
''' <datecreated>25-Aug-2016</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetUniqueCustIDConv(biun)
    Dim sSQL
    Dim arrRecordValues()
 
	sSQL = "select DISTINCT TOP 1 CUST_ID from PS_ITEM WHERE BUSINESS_UNIT = '" & biun & "' AND BAL_AMT > 0 "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbGetUniqueCustIDConv = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info" & biun)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbGetUniqueCustIDConv = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info" & biun)    
    Else
        dbGetUniqueCustIDConv = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info" & biun)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' depositid8003 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function depositid8003C(custID,biun)
    Dim sSQL
    Dim arrRecordValues()
 
	sSQL = "select * from PS_ITEM WHERE BUSINESS_UNIT = '" & biun & "' AND CUST_ID = '" & custID(0) & "' AND BAL_AMT > 0 "    
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
	
	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        depositid8003C = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info" & biun)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        depositid8003C = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info" & biun)
    Else
        depositid8003C = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info" & biun)
    End If
End Function

Public Function depositid8003(biun)
    Dim sSQL
    Dim arrRecordValues()	
 
	sSQL = "select * from PS_ITEM WHERE BUSINESS_UNIT = '" & biun & "' AND BAL_AMT > 0 "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        depositid8003 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info" & biun)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        depositid8003 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info" & biun)     
    Else
        depositid8003 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info" & biun)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' reviewconv1206 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function reviewconv1206(biun)
    Dim sSQL
    Dim arrRecordValues()
 
	sSQL = "SELECT DISTINCT A.BUSINESS_UNIT, A.CUST_ID, A.ITEM, A.BAL_AMT, C.CONVER_SUBJECT, C.CONVER_SUB_TOPIC, C.PROMISE_DT, C.REVIEW_NEXT_DT, C.REVIEW_OPRID, C.LETTER_CD, C.FOLLOW_UP_ACTION, C.FOLLOW_UP_COMP, C.FOLLOW_UP_DT, C.SUP_REVIEW, C.FOLLOW_UP_OPRID, C.ATTACH_EXIST, C.OPRID, C.KEYWORD1, C.KEYWORD2, C.KEYWORD3, D.CONVER_DT, D.CONTACT_ID, D.LAST_UPDATE_DTTM, D.DESCRLONG, C.* FROM PS_ITEM A, PS_CUSTOMER B, PS_CUST_CONVER_HDR C, PS_CUST_CONVER D WHERE A.BUSINESS_UNIT = '" & biun & "' AND A.CUST_ID = B.CUST_ID AND A.CUST_ID = D.CUST_ID AND A.CUST_ID = C.CUST_ID AND B.CUST_STATUS = 'A' AND A.BAL_AMT > 0 AND A.ITEM_STATUS = 'O' AND D.DESCRLONG <> '' AND C.CONVER_SUBJECT = 'BANKRUPTCY' "
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
	'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        reviewconv1206 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "revlist" & biun)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        reviewconv1206 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "revlist" & biun)    
    Else
        reviewconv1206 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "revlist" & biun)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' contactnamedata1207 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function contactnamedata1207(biun)
    
    Dim sSQL
    Dim arrRecordValues()	
 
sSQL = "SELECT DISTINCT A.BUSINESS_UNIT, A.CUST_ID, B.NAME1 AS CONTACT_NAME FROM PS_CUST_CONVER_HDR A, PS_CUST_CONTACT B WHERE A.BUSINESS_UNIT = '" & biun & "' AND A.CUST_ID = B.CUST_ID AND B.NAME1 <> ' ' " 
       
WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        contactnamedata1207 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "revlist" & biun)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
         contactnamedata1207 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "revlist" & biun)   
    Else
        contactnamedata1207 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "revlist" & biun)
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' dbFetchEditDelConv is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchEditDelConv(unit)
Err.Clear
On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL =  "SELECT DISTINCT TOP 1 A.BUSINESS_UNIT, A.CUST_ID, A.ITEM, A.BAL_AMT, C.CONVER_SUBJECT, C.CONVER_SUB_TOPIC, C.PROMISE_DT, C.REVIEW_NEXT_DT, " & _ 
                    "C.REVIEW_OPRID, C.LETTER_CD, C.FOLLOW_UP_ACTION, C.FOLLOW_UP_COMP, C.FOLLOW_UP_DT, C.SUP_REVIEW, " & _ 
                    "C.FOLLOW_UP_OPRID, C.ATTACH_EXIST, C.OPRID, C.KEYWORD1, C.KEYWORD2, C.KEYWORD3, D.CONVER_DT, D.CONTACT_ID, D.LAST_UPDATE_DTTM, D.DESCRLONG " & _ 
                    "FROM PS_ITEM A, PS_CUSTOMER B, PS_CUST_CONVER_HDR C, PS_CUST_CONVER D " & _ 
                    "WHERE A.BUSINESS_UNIT = '" & unit & "' " & _ 
                    "AND A.CUST_ID = B.CUST_ID " & _ 
                    "AND A.CUST_ID = D.CUST_ID " & _ 
                    "AND A.CUST_ID = C.CUST_ID " & _ 
                    "AND B.CUST_STATUS = 'A' " & _ 
                    "AND A.BAL_AMT > 0 " & _ 
                    "AND A.ITEM_STATUS = 'O' " & _ 
                    "AND D.DESCRLONG <> '' " & _ 
                    "AND C.CONVER_STATUS = 'N'" 
           
     WriteToReport micDone, "SQL query for Customer Info", "Query used for Customer Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchEditDelConv = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Credit_info" & unit)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbFetchEditDelConv = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Credit_info" & unit)     
    Else
        dbFetchEditDelConv = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Credit_info" & unit)
    End If
    
On Error goto 0 	
End Function
'**************************************************************************************************************
''' <summary> 
''' dbFetchEditDelConv1 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchEditDelConv1(unit)
Err.Clear
On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL =  "SELECT DISTINCT TOP 1 A.BUSINESS_UNIT, A.CUST_ID, A.ITEM, A.BAL_AMT, C.CONVER_SUBJECT, C.CONVER_SUB_TOPIC, C.PROMISE_DT, C.REVIEW_NEXT_DT, " & _ 
                    "C.REVIEW_OPRID, C.LETTER_CD, C.FOLLOW_UP_ACTION, C.FOLLOW_UP_COMP, C.FOLLOW_UP_DT, C.SUP_REVIEW, " & _ 
                    "C.FOLLOW_UP_OPRID, C.ATTACH_EXIST, C.OPRID, C.KEYWORD1, C.KEYWORD2, C.KEYWORD3, D.CONVER_DT, D.CONTACT_ID, D.LAST_UPDATE_DTTM, D.DESCRLONG " & _ 
                    "FROM PS_ITEM A, PS_CUSTOMER B, PS_CUST_CONVER_HDR C, PS_CUST_CONVER D " & _ 
                    "WHERE A.BUSINESS_UNIT = '" & unit& "' " & _ 
                    "AND A.CUST_ID = B.CUST_ID " & _ 
                    "AND A.CUST_ID = D.CUST_ID " & _ 
                    "AND A.CUST_ID = C.CUST_ID " & _ 
                    "AND B.CUST_STATUS = 'A' " & _ 
                    "AND A.BAL_AMT > 0 " & _ 
                    "AND A.ITEM_STATUS = 'O' " & _ 
                    "AND D.DESCRLONG <> '' " & _ 
                    "AND C.CONVER_STATUS = 'N'" & _ 
                    "and C.OPRID <> 'SOULMAT'"
           
     WriteToReport micDone, "SQL query for Customer Info", "Query used for Customer Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchEditDelConv1 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "1Credit_info" & unit)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbFetchEditDelConv1 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "1Credit_info" & unit)
    Else
       dbFetchEditDelConv1 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "1Credit_info" & unit)
    End If
    
On Error goto 0 	
End Function
'**************************************************************************************************************
''' <summary> 
''' dbFetchCustBrknPrmPymt is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchCustBrknPrmPymt(unit)
	On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL =  "SELECT DISTINCT TOP 1 A.BUSINESS_UNIT, A.CUST_ID, A.ITEM, A.BAL_AMT, C.CONVER_SUBJECT, " & _
"C.CONVER_SUB_TOPIC, C.PROMISE_DT, C.REVIEW_NEXT_DT, C.REVIEW_OPRID, " & _
"C.LETTER_CD, C.FOLLOW_UP_ACTION, C.FOLLOW_UP_COMP, C.FOLLOW_UP_DT, C.SUP_REVIEW, " & _
"C.FOLLOW_UP_OPRID, C.ATTACH_EXIST, C.OPRID, C.KEYWORD1, C.KEYWORD2, C.KEYWORD3, " & _
"D.CONVER_DT, D.CONTACT_ID, D.LAST_UPDATE_DTTM, D.DESCRLONG " & _
"FROM PS_ITEM A, PS_CUSTOMER B, PS_CUST_CONVER_HDR C, PS_CUST_CONVER D " & _
"WHERE A.BUSINESS_UNIT = '" & unit& "' " & _
"AND A.CUST_ID = B.CUST_ID " & _
 "AND A.CUST_ID = D.CUST_ID " & _
  "AND A.CUST_ID = C.CUST_ID " & _
 "AND B.CUST_STATUS = 'A' " & _
"AND A.BAL_AMT > 0 " & _
"AND A.ITEM_STATUS = 'O' " & _
"AND D.DESCRLONG <> '' " & _
"AND C.CONVER_STATUS <>'C'"
           
     WriteToReport micDone, "SQL query for Customer Info", "Query used for Customer Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchCustBrknPrmPymt = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Database_Info" & unit)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
          dbFetchCustBrknPrmPymt = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Database_Info" & unit)   
    Else
        dbFetchCustBrknPrmPymt = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Database_Info" & unit)
    End If
    
On Error goto 0 
End Function
'**************************************************************************************************************
''' <summary> 
''' dbFetchInvNoLngPendg is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchInvNoLngPendg(unit)
Err.Clear
On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL =  "SELECT DISTINCT A.BUSINESS_UNIT, A.CUST_ID, B.INVOICE, B.PAYMENT_METHOD, B.BILL_STATUS " & _ 
                   "FROM PS_ITEM A , PS_BI_HDR B " & _ 
                   "WHERE B.PAYMENT_METHOD = 'CC' AND " & _ 
                   "A.BUSINESS_UNIT ='" & unit & "' " & _ 
                   "AND A.ENTRY_TYPE = 'IN' AND A.BUSINESS_UNIT = B.BUSINESS_UNIT " & _ 
                   "AND A.CUST_ID = B.BILL_TO_CUST_ID " & _ 
                   "AND A.ITEM_STATUS = 'O'"
           
     WriteToReport micDone, "SQL query for Customer Info", "Query used for Customer Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchInvNoLngPendg = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "CustInv_Info_" & unit)
 	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
       	dbFetchInvNoLngPendg = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "CustInv_Info_" & unit)     
    Else
        dbFetchInvNoLngPendg = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "CustInv_Info_" & unit)
    End If
    
	On Error goto 0    
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchmakeConvSort is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchmakeConvSort(unit)
	On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL =  "SELECT DISTINCT A.BUSINESS_UNIT, A.CUST_ID, B.NAME1 AS CONTACT_NAME " & _
 "FROM PS_CUST_CONVER_HDR A, PS_CUST_CONTACT B " & _
  "WHERE A.BUSINESS_UNIT ='" & unit & "' " & _
  "AND A.CUST_ID = B.CUST_ID " & _
  "AND B.NAME1 <> ''"
           
     WriteToReport micDone, "SQL query for Customer Info", "Query used for Customer Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchmakeConvSort = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Database_Info" & unit)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
          dbFetchmakeConvSort = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Database_Info" & unit)   
    Else
        dbFetchmakeConvSort = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Database_Info" & unit)
    End If
    
On Error goto 0 
End Function
'**************************************************************************************************************
''' <summary> 
''' dbFetchVefyARmvdNewColPropApp is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchVefyARmvdNewColPropApp(unit)
	On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL =  "SELECT A.BUSINESS_UNIT,  A.BILL_TO_CUST_ID, A.INVOICE, B.ITEM_STATUS " & _
  "FROM PS_BI_HDR A, PS_ITEM B " & _
  "WHERE A.BILL_TO_CUST_ID = B.CUST_ID " & _
  "AND A.INVOICE = B.ITEM " & _
  "AND A.BUSINESS_UNIT = B.BUSINESS_UNIT " & _
  "AND A.BUSINESS_UNIT ='" & unit & "' " & _
  "AND B.ITEM_STATUS = 'O'"
           
    WriteToReport micDone, "SQL query for Customer Info", "Query used for Customer Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchVefyARmvdNewColPropApp = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Database_Info" & unit)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
           dbFetchVefyARmvdNewColPropApp = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Database_Info" & unit)  
    Else
        dbFetchVefyARmvdNewColPropApp = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Database_Info" & unit)
    End If
    
On Error goto 0 
End Function
'**************************************************************************************************************
''' <summary> 
''' dbFetchitemRefExiConv is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchitemRefExiConv(unit)
	On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL =  "SELECT DISTINCT A.BUSINESS_UNIT, A.CUST_ID, B.NAME1 AS CONTACT_NAME, C.ITEM " & _
 "FROM PS_CUST_CONVER_HDR A, PS_CUST_CONTACT B, PS_ITEM C " & _
  "WHERE A.BUSINESS_UNIT ='" & unit & "' " & _
  "AND A.CUST_ID = B.CUST_ID " & _
 "AND A.BUSINESS_UNIT = C.BUSINESS_UNIT " & _
 "AND A.CUST_ID = C.CUST_ID " & _
 "AND C.BAL_AMT > 0"
           
    WriteToReport micDone, "SQL query for Customer Info", "Query used for Customer Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
         dbFetchitemRefExiConv = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Database_Info" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
          dbFetchitemRefExiConv = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Database_Info" & unit)
	ElseIf strComp (GlobalDictionary("Environment"),"FNRVTST") = 0 Then
        dbFetchcustConvFollwUpAction = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues, "Database_Info" & unit)
    Else
         dbFetchitemRefExiConv = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Database_Info" & unit)
    End If
    
On Error goto 0 
End Function
'**************************************************************************************************************
''' <summary> 
''' dbFetchcustConvFollwUpAction is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchcustConvFollwUpAction(unit)
	On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL =  "SELECT BUSINESS_UNIT, * FROM PS_CUST_CONVER_HDR WHERE FOLLOW_UP_ACTION <> '' " & _
"AND BUSINESS_UNIT ='" & unit & "' " & _
"AND CONVER_STATUS = 'N' " & _
"AND FOLLOW_UP_COMP = 'N' " & _
"AND REVIEW_NEXT_DT <> ''"
           
    WriteToReport micDone, "SQL query for Customer Info", "Query used for Customer Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchcustConvFollwUpAction = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Database_Info" & unit)
      ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbFetchcustConvFollwUpAction = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Database_Info" & unit)
        ElseIf strComp (GlobalDictionary("Environment"),"FNRVTST") = 0 Then
        dbFetchcustConvFollwUpAction = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues, "Database_Info" & unit)
    Else
        dbFetchcustConvFollwUpAction = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Database_Info" & unit)
    End If
    
On Error goto 0 
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchccAprvlppcctrans is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchccAprvlppcctrans(unit)
		On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
        '   sSQL =  "SELECT BUSINESS_UNIT, INVOICE, AMOUNT, * FROM PS_INTFC_CRCARD WHERE BUSINESS_UNIT ='" & unit & "' AND AMOUNT <> '0' AND PROCESS_INSTANCE = '0' AND CR_CARD_EXPMO  > DATEPART(MONTH, GETDATE ()) AND CR_CARD_EXPYR >= DATEPART(YEAR, GETDATE())"
     ' updated query as per rini 06/09/2016
           sSQL = "SELECT BUSINESS_UNIT, INVOICE, AMOUNT, * FROM PS_INTFC_CRCARD " & _
                 "WHERE BUSINESS_UNIT ='" & unit & "' " & _
                 "AND AMOUNT <> '0' " & _ 
                 "AND CR_CARD_EXPMO >= DATEPART(MONTH, GETDATE ()) AND CR_CARD_EXPYR >= DATEPART(YEAR, GETDATE()) AND CR_CARD_AUTH_STAT <> 'R' "
           
    WriteToReport micDone, "SQL query for Invoice Info", "Query used for Invoice Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchccAprvlppcctrans = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Database_Info" & unit)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbFetchccAprvlppcctrans = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Database_Info" & unit)
	ElseIf strComp (GlobalDictionary("Environment"),"FNRVTST") = 0 Then
        dbFetchcustConvFollwUpAction = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues, "Database_Info" & unit)        
    Else
        dbFetchccAprvlppcctrans = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Database_Info" & unit)
    End If
    
On Error goto 0 
End Function
'**************************************************************************************************************
''' <summary> 
''' dbgetcreateConvoAddSubjectRefAttachment is helper component to retreive the Conversation Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>25-Jan-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetcreateConvoAddSubjectRefAttachment(srtBusinessValue)
	Dim strSQL
    Dim arrRecordValues()
	strSQL = "SELECT A.BUSINESS_UNIT, A.CUST_ID, A.ITEM, A.BAL_AMT FROM PS_ITEM A, PS_CUSTOMER B WHERE A.BUSINESS_UNIT = '" & srtBusinessValue & "' AND A.CUST_ID = B.CUST_ID  AND B.CUST_STATUS = 'A' AND A.BAL_AMT > 0 AND A.ITEM_STATUS = 'O'"	
	Call  WriteToReport (micPass, "Query for Customer Info", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetcreateConvoAddSubjectRefAttachment=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
         dbgetcreateConvoAddSubjectRefAttachment=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )    
    Else
        dbgetcreateConvoAddSubjectRefAttachment=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If		
End Function
'**************************************************************************************************************
''' <summary> 
''' dbgetsubject is helper component to retreive the Conversation Subject from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>25-Jan-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetsubject(srtBusinessValue)
	Dim strSQL
    Dim arrRecordValues()
	strSQL = "select * from PS_SUBJECT_HDR_TBL WHERE SETID = 'SHARE' AND CONVER_SUBJECT <> ''"
	Call  WriteToReport (micPass, "Query for Subject", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetsubject=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbgetsubject=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )     
    Else
        dbgetsubject=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
End Function 
'**************************************************************************************************************
''' <summary> 
''' dbgetmultipleitemupdate is helper component to retreive the Subject Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>25-Jan-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************	
Public Function dbgetmultipleitemupdate(srtBusinessValue)
	Dim strSQL
    Dim arrRecordValues()
	strSQL = "SELECT A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, B.ITEM_STATUS, B.REF_REASON from PS_BI_HDR A, PS_ITEM B WHERE A.BILL_TO_CUST_ID IN (SELECT B.CUST_ID FROM PS_ITEM B  WHERE B.ITEM_STATUS = 'O' AND B.ITEM_STATUS = 'O' and B.REF_REASON = '' GROUP BY B.CUST_ID HAVING COUNT(B.ITEM) > 1) AND A.BILL_TO_CUST_ID = B.CUST_ID AND A.INVOICE = B.ITEM AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.BUSINESS_UNIT = '" & srtBusinessValue & "' AND B.ITEM_STATUS = 'O' and B.REF_REASON = '' ORDER BY A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, B.ITEM_STATUS, B.REF_REASON"
	Call  WriteToReport (micPass, "Query for Subject", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetmultipleitemupdate=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbgetmultipleitemupdate=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )     
    Else
        dbgetmultipleitemupdate=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
	
End Function
'**************************************************************************************************************
''' <summary> 
''' dbgetunpostPaymentMistakenlySentPS is helper component to retreive the Deposit ID from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>22-Feb-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************	
Public Function dbgetunpostPaymentMistakenlySentPS(srtBusinessValue)
	
	Dim strSQL
Dim arrRecordValues()
	strSQL = "SELECT * FROM PS_DEPOSIT_CONTROL WHERE DEPOSIT_BU = '" & srtBusinessValue & "' AND DEP_POST_STATUS = 'C' And CONTROL_AMT > '100.00'"
	Call  WriteToReport (micPass, "Query for Deposit ID", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetunpostPaymentMistakenlySentPS=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        dbgetunpostPaymentMistakenlySentPS=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )     
    Else
        dbgetunpostPaymentMistakenlySentPS=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If	
End Function
'**************************************************************************************************************
''' <summary> 
''' dbgetverifyColumnorderofReferenceReason is helper component to retreive the Customer Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>22-Feb-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************	
Public Function dbgetverifyColumnorderofReferenceReason(srtBusinessValue)
	Dim strSQL
    Dim arrRecordValues()
	strSQL = "SELECT TOP 1 A.BUSINESS_UNIT,  A.BILL_TO_CUST_ID, A.INVOICE, B.ITEM_STATUS, B.REF_REASON from PS_BI_HDR A, PS_ITEM B WHERE A.BILL_TO_CUST_ID = B.CUST_ID AND A.INVOICE = B.ITEM AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.BUSINESS_UNIT = '" & srtBusinessValue & "' AND B.ITEM_STATUS = 'O'"
	Call  WriteToReport (micPass, "Query for Customer Info", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbgetverifyColumnorderofReferenceReason=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
      ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
         dbgetverifyColumnorderofReferenceReason=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )     
    Else
        dbgetverifyColumnorderofReferenceReason=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If	
	
End Function
'**************************************************************************************************************
''' <summary> 
''' dbgettransferPaymentPSAS40003Info is helper component to retreive the Customer Details from database
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>22-Feb-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
' 06/22/2016        venu arigela  changed query as per rini
'**************************************************************************************************************	
Public Function dbgettransferPaymentPSAS40003Info(srtBusinessValue)
	Dim strSQL
    Dim arrRecordValues()
	'strSQL ="SELECT * FROM PS_ITEM WHERE BAL_AMT > 0 AND BUSINESS_UNIT = '" & srtBusinessValue & "'AND ITEM <> 'MD1500889'"
	strSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.BAL_AMT, R.INVOICE, Q.ITEM_STATUS FROM PS_ITEM Q , PS_BI_HDR R WHERE Q.BAL_AMT > 0 AND Q.CUST_ID = R.BILL_TO_CUST_ID AND R.INVOICE = Q.INVOICE AND Q.BUSINESS_UNIT = '" & srtBusinessValue & "' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) AND Q.ITEM NOT IN ( (SELECT B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM))) AND Q.ITEM NOT IN (SELECT F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT)) AND Q.ITEM NOT IN (SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM)) AND Q.ITEM NOT IN (SELECT N.ITEM  FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL))"                       


	Call  WriteToReport (micPass, "Query for Subject", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
         dbgettransferPaymentPSAS40003Info=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
      ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
          dbgettransferPaymentPSAS40003Info=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )     
    Else
         dbgettransferPaymentPSAS40003Info=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If	
End Function
'**************************************************************************************************************
''' <summary> 
''' revconvvee123 is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'26Apr2018			Eric Trout	Updated sort of data returned
'**************************************************************************************************************
Public Function revconvvee123(biun)
    
    Dim sSQL
    Dim arrRecordValues()	
 
'sSQL = "SELECT A.SETID, A.BUSINESS_UNIT, A.CUST_ID, B.PROMISE_AMT as REFERENCE_AMOUNT, A.CONVER_DTTM, B.CONVER_SUBJECT, B.CONVER_SUB_TOPIC, (CONVERT(CHAR(10),B.REVIEW_NEXT_DT,121)) AS NEXT_REVIEW_DATE, B.PROMISE_TO_PAY, (CONVERT(CHAR(10),B.PROMISE_DT,121)) AS PROMISE_DATE, A.CONTACT_ID, A.DESCRLONG, B.FOLLOW_UP_ACTION, B.FOLLOW_UP_OPRID, B.PAY_PROMISE_AMT, B.CURRENCY_CD, A.CONVER_SEQ_NUM, A.LAST_UPDATE_DTTM, B.OPRID, B.OPRID_LAST_UPDT, B.SUP_REVIEW, B.PROMISE_ACTION, B.LETTER_CD, B.REVIEW_OPRID, B.KEYWORD1, B.KEYWORD2, B.KEYWORD3 FROM PS_CUST_CONVER A, PS_CUST_CONVER_HDR B, PS_CUST_CONVER_DTL C WHERE ( A.SETID = B.SETID AND A.BUSINESS_UNIT='biun& "' AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.CUST_ID = B.CUST_ID AND A.CONVER_DTTM_INIT = B.CONVER_DTTM_INIT AND A.CONVER_DT = B.CONVER_DT AND B.SETID = C.SETID AND B.BUSINESS_UNIT = C.BUSINESS_UNIT AND B.CUST_ID = C.CUST_ID AND B.CONVER_DTTM_INIT = C.CONVER_DTTM_INIT AND B.CONVER_DT = C.CONVER_DT AND A.CUST_ID<>'0323527') AND B.CONVER_SUBJECT <> '' ORDER BY 5 DESC " 
  
  sSQL = "SELECT distinct A.SETID, A.BUSINESS_UNIT, A.CUST_ID, B.DESCR, B.PROMISE_AMT as REFERENCE_AMOUNT, A.CONVER_DTTM, B.CONVER_SUBJECT, B.CONVER_SUB_TOPIC,B.AR_PROMISE_STATUS, (CONVERT(CHAR(10),B.REVIEW_NEXT_DT,121)) AS NEXT_REVIEW_DATE, B.PROMISE_TO_PAY, " & _
         "(CONVERT(CHAR(10),B.PROMISE_DT,121)) AS PROMISE_DATE, A.CONTACT_ID, A.DESCRLONG, B.FOLLOW_UP_ACTION, B.FOLLOW_UP_OPRID, B.PAY_PROMISE_AMT, B.CURRENCY_CD, A.CONVER_SEQ_NUM, A.LAST_UPDATE_DTTM, B.OPRID, B.OPRID_LAST_UPDT, " & _ 
         "B.SUP_REVIEW, B.PROMISE_ACTION, B.LETTER_CD, B.REVIEW_OPRID, B.KEYWORD1, B.KEYWORD2, B.KEYWORD3 " & _
         "FROM PS_CUST_CONVER A, PS_CUST_CONVER_HDR B, PS_CUST_CONVER_DTL C WHERE ( A.SETID = B.SETID AND A.BUSINESS_UNIT='" & biun & "' " & _ 
         "AND B.PROMISE_AMT <> 0 " & _
         "AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.CUST_ID = B.CUST_ID AND A.CONVER_DTTM_INIT = B.CONVER_DTTM_INIT AND A.CONVER_DT = B.CONVER_DT AND B.SETID = C.SETID " & _
         "AND B.BUSINESS_UNIT = C.BUSINESS_UNIT AND B.CUST_ID = C.CUST_ID AND B.CONVER_DTTM_INIT = C.CONVER_DTTM_INIT AND B.CONVER_DT = C.CONVER_DT AND A.CUST_ID<>'0323527') AND B.CONVER_SUBJECT <> '' " & _
         "GROUP BY A.SETID, A.BUSINESS_UNIT, A.CUST_ID, B.DESCR, B.PROMISE_AMT, A.CONVER_DTTM, B.CONVER_SUBJECT, B.CONVER_SUB_TOPIC,B.AR_PROMISE_STATUS, (CONVERT(CHAR(10),B.REVIEW_NEXT_DT,121)), B.PROMISE_TO_PAY, " & _
         "(CONVERT(CHAR(10),B.PROMISE_DT,121)), A.CONTACT_ID, A.DESCRLONG, B.FOLLOW_UP_ACTION, B.FOLLOW_UP_OPRID, B.PAY_PROMISE_AMT, B.CURRENCY_CD, A.CONVER_SEQ_NUM, A.LAST_UPDATE_DTTM, B.OPRID, B.OPRID_LAST_UPDT, " & _
         "B.SUP_REVIEW, B.PROMISE_ACTION, B.LETTER_CD, B.REVIEW_OPRID, B.KEYWORD1, B.KEYWORD2, B.KEYWORD3 " & _
          "ORDER BY 6 DESC "    
WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        revconvvee123 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "revlist" & biun)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
           revconvvee123 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "revlist" & biun)  
    Else
        revconvvee123 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "revlist" & biun)
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' dblinkedaacoutfinal is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <param name="bunit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dblinkedaacoutfinal(biun)
	Dim strSQL
    Dim arrRecordValues()
	strSQL ="SELECT DISTINCT A.CUST_ID, B.CUST_ID, B.CORPORATE_CUST_ID FROM PS_ITEM A, PS_CUSTOMER B WHERE A.BUSINESS_UNIT = '" & biun & "' AND A.CUST_ID = B.CUST_ID AND B.CORPORATE_CUST_ID = B.CUST_ID "
	Call  WriteToReport (micPass, "Query for Subject", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dblinkedaacoutfinal=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & biun )
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
          dblinkedaacoutfinal=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & biun )   
    Else
        dblinkedaacoutfinal=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & biun )
    End If	
End Function
'**************************************************************************************************************
''' <summary> 
''' dbGetVerifyRecords helps to get the Record from DB to verify if the invoice getting Processed
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Mar-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetVerifyRecords(invoice,srtBusinessValue)
Dim strSQL
Dim arrRecordValues()

	strSQL ="Select * FROM PS_BI_HDR A WHERE A.ACCOUNTING_DT = '"&DATE& "' AND A.BUSINESS_UNIT = '" & srtBusinessValue & "' AND A.BILL_STATUS = 'INV' AND INVOICE ='"&invoice& "' AND A.INVOICE NOT IN (SELECT ITEM FROM PS_ITEM WHERE  ACCOUNTING_DT = '"&DATE& "' AND BUSINESS_UNIT = '" & srtBusinessValue & "' AND POST_DT = '"&DATE& "')"
	Call  WriteToReport (micPass, "Query to Verify Records", "" & strSQL & "", False)
	'dbGetVerifyRecords=dbGetFirstRecord(strSQL,PSFCONNECTIONSTR, arrRecordValues, "Details" & srtBusinessValue )
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	dbGetVerifyRecords=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
	 ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
		dbGetVerifyRecords=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue ) 
    Else
    dbGetVerifyRecords=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' dbGetVerifyRecords1 helps to Verify there are No Records in the DB which means the invoice got Processed
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Mar-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetVerifyRecords1(invoice,srtBusinessValue)
Dim strSQL
Dim arrRecordValues()
	strSQL ="Select * FROM PS_BI_HDR A WHERE A.ACCOUNTING_DT = 'DATE& "' AND A.BUSINESS_UNIT = '" & srtBusinessValue & "' AND A.BILL_STATUS = 'INV' AND INVOICE ='invoice& "' AND A.INVOICE NOT IN (SELECT ITEM FROM PS_ITEM WHERE  ACCOUNTING_DT = 'DATE& "' AND BUSINESS_UNIT = '" & srtBusinessValue & "' AND POST_DT = 'DATE& "')"
	Call  WriteToReport (micPass, "Query to Verify Records", "" & strSQL & "", False)
	'dbGetVerifyRecords=dbGetNoRecords(strSQL,PSFCONNECTIONSTR, arrRecordValues, "Details" & srtBusinessValue )
		If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	dbGetVerifyRecords1=dbGetNoRecords(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
	 ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
		dbGetVerifyRecords1=dbGetNoRecords(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue ) 
    Else
    dbGetVerifyRecords1=dbGetNoRecords(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
	
End Function
'**************************************************************************************************************
''' <summary> 
''' dbGetNoRecords is a funtion to check if there are Zero Records 
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetNoRecords(strSQL,sConnectionString, arrRecordValues,sheetName)
Dim dBRecSet,objConnection,connectionString	,databaseName
	Dim intLoop, iArrayNo, nRecordCount, sOneRecord,nReportValue
	Dim sTemp,i,j,fields
	 If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	      connectionString = PSFCONNECTIONSTRFNQA
	      databaseName     = dbName_FNQA
      elseIf  StrComp (GlobalDictionary("Environment"), "FNTST") = 0 Then
	      connectionString = PSFCONNECTIONSTRFNTST
	      databaseName     = dbName_FNTST
	    Else
           connectionString = PSFCONNECTIONSTRFNREG
	      databaseName     = dbName_FNREG     
	 End If
  'Set the Database connection object 
	Set objConnection= dbOpenConnection(connectionString,databaseName,dbPWDVM)
	
	'Verify for object exist or not
	If IsObject(objConnection) Then	
		'Execute the SQL and get the recordset object
		On Error Resume Next
		Set dBRecSet = objConnection.Execute(strSQL)
		DataTable.AddSheet(sheetName)
		DataTable.GetSheet(sheetName).SetCurrentRow(0)
		fields = 0
        If IsObject(dBRecSet) Then
	
			If dBRecSet.EOF = False Then
			    For i = 0 To dBRecSet.fields.count-1
			    	DataTable.GetSheet(sheetName).AddParameter dBRecSet.fields(i).Name, ""
			    Next
			    DataTable.SetCurrentRow(1)
			
			    For j = 0 To dBRecSet.fields.count-1
			         ReDim Preserve arrRecordValues(j)
			        DataTable.Value(""&dBRecSet.fields(j).Name,sheetName) = ""&dBRecSet.fields(j).Value
			        arrRecordValues(j) = ""&dBRecSet.fields(j).Value
			      
			    Next
			Else
			 WriteToReport micPass,"DB records", "Returned zero records", false
		    End If
		Else
		   WriteToReport nReportValue, "Verifying the Record from Database", "No Record Exist for SQL: [" & strSQL& "]"
			
	     End If
	     
	     Else
	        WriteToReport micFail, "DB connection", "Data base connection is failed", false
	     End If
	        

	dbGetNoRecords = arrRecordValues

	'Clean up opened objects
 	dBRecSet.Close
	objConnection.Close
	
End Function
'**************************************************************************************************************
''' <summary> 
''' dbGetmasscorrect helps to get the Error Data from DB
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>14-Mar-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetmasscorrect(srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL = "SELECT A.INTFC_ID, A.ERROR_STATUS_BI, B.XLATLONGNAME AS ERROR_DESCR, A.BUSINESS_UNIT, A.BILL_TO_CUST_ID FROM PS_BI_INTFC_ERR_VW A, PSXLATITEM B WHERE A.ERROR_STATUS_BI = B.FIELDVALUE AND BUSINESS_UNIT = '" & srtBusinessValue & "'"
	Call WriteToReport (micPass, "Query For Error Data", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbGetmasscorrect=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details" & srtBusinessValue )
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
		dbGetmasscorrect=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details" & srtBusinessValue )  
  	Else
    	dbGetmasscorrect=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details" & srtBusinessValue )
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetmasscorrectinv helps to get the Invoice Information from DB
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>14-Mar-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetmasscorrectinv(interface, customer, srtBusinessValue)
	Dim strSQL
	Dim arrRecordValues()

	strSQL = "SELECT DISTINCT BUSINESS_UNIT, BILL_TO_CUST_ID, INVOICE FROM PS_INTFC_BI_CMP A WHERE INTFC_ID = '" & interface & "' AND LOAD_STATUS_BI = 'DON' AND BILL_TO_CUST_ID = '" & customer & "'"
	Call WriteToReport (micPass, "Query For Invoice", "" & strSQL & "", False)
	If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbGetmasscorrectinv = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Details1" & srtBusinessValue)
	ElseIf strComp(GlobalDictionary("Environment"), "FNTST") = 0 Then
		dbGetmasscorrectinv=dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Details1" & srtBusinessValue)
    Else
    	dbGetmasscorrectinv=dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Details1" & srtBusinessValue)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetcustomerduplicatepmnt helps to get the Customer Information from DB
''' </summary>
''' <author>Rama Peela</author>
''' <datecreated>10-Dec-2015</datecreated>
''' <param name="srtBusinessValue" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetcustomerduplicatepmnt(srtBusinessValue)
Dim strSQL
Dim arrRecordValues()
	    strSQL ="Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.BAL_AMT, R.INVOICE, Q.ITEM_STATUS FROM PS_ITEM Q , PS_BI_HDR R WHERE Q.BAL_AMT > 0 AND Q.CUST_ID = R.BILL_TO_CUST_ID AND R.INVOICE = Q.INVOICE AND Q.BUSINESS_UNIT = '" & srtBusinessValue & "' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT AND NOT ITEM ='BO1600016' AND R.INVOICE NOT IN" & _ 
				"( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) AND Q.ITEM NOT IN ((SELECT B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM))) AND Q.ITEM NOT IN " & _					
				"(SELECT F.ITEM	FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT)) AND Q.ITEM NOT IN" & _ 					
				"(SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM)) AND Q.ITEM NOT IN" & _ 					
				"(SELECT N.ITEM FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL))"					
					
	Call  WriteToReport (micPass, "Query For Customer Details", "" & strSQL & "", False)
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    dbgetcustomerduplicatepmnt=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNQA, arrRecordValues, "Details1" & srtBusinessValue )
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
	    dbgetcustomerduplicatepmnt=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNTST, arrRecordValues, "Details1" & srtBusinessValue )	
    Else
        dbgetcustomerduplicatepmnt=dbGetFirstRecord(strSQL,PSFCONNECTIONSTRFNREG, arrRecordValues, "Details1" & srtBusinessValue )
    End If	
End Function

Public Function dbFetchRfndCrdBalCC(unit)
	Err.Clear
On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, R.INVOICE, Q.ITEM_STATUS " & _
"FROM PS_ITEM Q , PS_BI_HDR R " & _
"WHERE Q.BAL_AMT < 0 " & _
"AND Q.CUST_ID = R.BILL_TO_CUST_ID " & _ 
"AND R.INVOICE = Q.INVOICE " & _
"AND Q.BUSINESS_UNIT ='" & unit & "' " & _
"AND Q.ENTRY_TYPE = 'CR' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _ 
"AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) " & _
"AND Q.ITEM NOT IN ( " & _
"(SELECT  B.ITEM " & _
  "FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D " & _ 
  "WHERE ( A.WS_BU = B.WS_BU " & _
     "AND A.WS_ID = B.WS_ID " & _
     "AND C.SETCNTRLVALUE = B.BUSINESS_UNIT " & _
     "AND C.RECNAME = 'CUSTOMER' " & _
     "AND D.SETID = C.SETID " & _
     "AND D.CUST_ID = B.CUST_ID " & _
     "AND B.ITEM_SELECTED = 'Y' " & _
     "AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _
     "AND B.ITEM = Q.ITEM))) " & _
"AND Q.ITEM NOT IN " & _
"(SELECT  F.ITEM " & _
  "FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H " & _ 
  "WHERE ( E.TRN_BU = F.TRN_BU " & _
     "AND E.TRN_ID = F.TRN_ID " & _
     "AND F.ITEM_SELECTED = 'Y' " & _
     "AND G.SETCNTRLVALUE = F.BUSINESS_UNIT " & _
     "AND G.RECNAME = 'CUSTOMER' " & _
     "AND H.SETID = G.SETID " & _
     "AND H.CUST_ID = F.CUST_ID " & _
     "AND F.ITEM = Q.ITEM " & _
     "AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT)) " & _
       "AND Q.ITEM NOT IN " & _
        "(SELECT J.ITEM " & _
  "FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L " & _ 
  "WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU " & _
     "AND I.DEPOSIT_ID = J.DEPOSIT_ID " & _
     "AND J.ITEM_SELECTED = 'Y' " & _
     "AND K.SETCNTRLVALUE = J.BUSINESS_UNIT " & _
     "AND K.RECNAME = 'CUSTOMER' " & _
     "AND L.SETID = K.SETID " & _
     "AND L.CUST_ID = J.CUST_ID " & _
     "AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _
     "AND J.ITEM = Q.ITEM)) " & _
       "AND Q.ITEM NOT IN " & _
        "(SELECT N.ITEM " & _
  "FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P " & _ 
  "WHERE ( M.GROUP_BU = N.GROUP_BU " & _
     "AND M.GROUP_ID = N.GROUP_ID " & _
     "AND O.SETCNTRLVALUE = N.BUSINESS_UNIT " & _
     "AND O.RECNAME = 'CUSTOMER' " & _
     "AND P.SETID = O.SETID " & _
     "AND P.CUST_ID = N.CUST_ID " & _
     "AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _
     "AND N.ITEM = Q.ITEM " & _
     "AND N.POST_DT IS NULL))"
           
    WriteToReport micDone, "SQL query for Refund Credit Balance to Credit Card - Credit Entire Bill ", "Query used for Refund Credit Balance to Credit Card is " & sSQL, False
      If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
    	dbFetchRfndCrdBalCC = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "RfndCrdBalCC_Info" & unit)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        	dbFetchRfndCrdBalCC = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "RfndCrdBalCC_Info" & unit)
    Else
    dbFetchRfndCrdBalCC = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "RfndCrdBalCC_Info" & unit)
    End If
    
On Error goto 0  
End Function

Public Function genrtjrnltwo3(ProcessInstance)
    
    Dim sSQL
    Dim arrRecordValues()	
 
sSQL = "Select * FROM PS_JRNL_LN WHERE PROCESS_INSTANCE ='" & ProcessInstance & "' " 
       
WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
    genrtjrnltwo3 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info" & ProcessInstance)
 ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
     genrtjrnltwo3 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info" & ProcessInstance)
 Else
    genrtjrnltwo3 = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info" & ProcessInstance)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchPayMulItemsbyCC is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function cccollectionsing(unit)
	Err.Clear
On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.ENTRY_TYPE, Q.BAL_AMT FROM PS_ITEM Q , PS_BI_HDR R WHERE Q.BAL_AMT > 0 AND Q.BUSINESS_UNIT ='" & unit & "' AND Q.CUST_ID IN (SELECT CUST_ID FROM PS_ITEM A WHERE A.BAL_AMT > 0 GROUP BY CUST_ID HAVING COUNT(A.ITEM) = 2) AND Q.CUST_ID = R.BILL_TO_CUST_ID AND R.INVOICE LIKE 'ZR%' AND Q.ENTRY_TYPE = 'IN' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT AND Q.ITEM NOT IN ( (SELECT B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM) UNION SELECT F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT) UNION SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM) UNION SELECT N.ITEM FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL))) GROUP BY  Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.ENTRY_TYPE, Q.BAL_AMT "
           
    WriteToReport micDone, "SQL query for Refund Credit Balance to Credit Card - Credit Entire Bill ", "Query used for Refund Credit Balance to Credit Card is " & sSQL, False
      If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
    	cccollectionsing = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "RfndCrdBalCC_Info" & unit)
     ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        	cccollectionsing = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "RfndCrdBalCC_Info" & unit)
    Else
    	cccollectionsing = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "RfndCrdBalCC_Info" & unit)
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchPayMulItemsbyCC is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function cccardreviwlast(biun)
    
    Dim sSQL
    Dim arrRecordValues()	
 
sSQL = "select DISTINCT A.BUSINESS_UNIT, A.CUST_ID, B.INVOICE, B.BILL_STATUS, C.IDENTIFIER, C.SHIP_TO_CUST_ID AS SHIP_TO, C.SHIP_TO_ADDR_NUM AS SHIP_TO_LOC, D.ACCOUNT, D.DEPTID " & _
       "FROM PS_ITEM A , PS_BI_HDR B, PS_BI_LINE C, PS_BI_LINE_DST D " & _
      "WHERE A.PAYMENT_METHOD = 'CC' AND A.BUSINESS_UNIT IN ('" & biun & "') " & _
      "AND A.ENTRY_TYPE = 'IN' AND A.BUSINESS_UNIT = B.BUSINESS_UNIT " & _
      "AND A.CUST_ID = B.BILL_TO_CUST_ID " & _
      "AND B.INVOICE LIKE 'ZR%' " & _
      "AND A.ITEM_STATUS = 'O' " & _
      "AND A.BUSINESS_UNIT = C.BUSINESS_UNIT " & _
      "AND B.INVOICE = C.INVOICE " & _
      "AND A.BUSINESS_UNIT = D.BUSINESS_UNIT " & _
      "AND B.INVOICE = D.INVOICE "
WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False
'dbFetchNewCustProperties = dbGetFirstRecord(sSQL, PSFCONNECTIONSTR, arrRecordValues, "Billing_Data")
'lineinfotaxsumz111perc = dbGetAllRecords(sSQL, PSFCONNECTIONSTR, arrRecordValues, "invoice_id_info", "TAX_PCT")
If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
    cccardreviwlast = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info" & biun)
  ElseIf strComp (GlobalDictionary("Environment"),"FNRVTST") = 0 Then 
		cccardreviwlast = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues, "invoice_id_info" & biun)
  
  ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
        cccardreviwlast = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info" & biun)
    Else
    cccardreviwlast = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info" & biun)
    End If
End Function

Public Function cccnewlistiwlast(biun)
	Err.Clear
On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
           sSQL = "SELECT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, A.INVOICE, B.XLATLONGNAME AS CREDIT_CARD_TYPE, A.CR_CARD_NBR, A.CR_CARD_EXPYR,A.CR_CARD_EXPMO, A.CR_CARD_DIGITS as LAST_4_DIGITS, A.CR_CARD_AUTH_CD, A.CR_CARD_FNAME AS FIRSTNAME,  A.CR_CARD_LNAME AS LASTNAME, A.CR_CARD_AUTH_STAT, A.EMAILID, A.PHONE, A.TRANSACTION_DT, A.AMOUNT FROM PS_ITEM Q, PS_CDW_CRCARD_VW A, PSXLATITEM B WHERE Q.ITEM_STATUS = 'O' AND Q.BUSINESS_UNIT = '" & biun & "' AND A.CR_CARD_TYPE = B.FIELDVALUE AND B.FIELDNAME = 'CR_CARD_TYPE' AND A.CUST_ID  = Q.CUST_ID AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND Q.ITEM NOT IN (SELECT  F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT)) AND Q.ITEM NOT IN (SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM)) AND Q.ITEM NOT IN (SELECT N.ITEM FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL)) AND Q.CUST_ID IN ( SELECT A.CUST_ID FROM PS_CDW_CRCARD_VW A WHERE  A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND A.CUST_ID  = Q.CUST_ID) "

    WriteToReport micDone, "SQL query for Refund Credit Balance to Credit Card - Credit Entire Bill ", "Query used for Refund Credit Balance to Credit Card is " & sSQL, False
      If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
    cccnewlistiwlast = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_id_info" & biun)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then        
      cccnewlistiwlast = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_id_info" & biun)
  Else
    cccnewlistiwlast = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_id_info" & biun)
    End If
End Function


'**************************************************************************************************************
''' <summary> 
''' dbFetchEDITransCDWDirectAccount is helper component to retreive the sigle row from database
''' </summary>
''' <author>Swetha Ravoori</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'05/15/2019			Zach A. 	Added PS_CUST_PND_MNT_VW to the exclusion tables
'**************************************************************************************************************
Public Function dbFetchEDITransCDWDirectAccount(unit)
On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
sSQL = "SELECT DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.BAL_AMT, R.INVOICE, Q.ITEM_STATUS " & _
"FROM PS_ITEM Q , PS_BI_HDR R " & _		
"WHERE Q.BAL_AMT > 0 " & _ 		
"AND Q.CUST_ID = R.BILL_TO_CUST_ID " & _		
"AND R.INVOICE = Q.INVOICE " & _		
"AND Q.BUSINESS_UNIT ='" & unit & "' " & _		
"AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _		
"AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) " & _		
"AND Q.ITEM NOT IN ( " & _		
"(SELECT B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE A.WS_BU = B.WS_BU " & _		
"AND A.WS_ID = B.WS_ID " & _ 		
"AND C.SETCNTRLVALUE = B.BUSINESS_UNIT " & _		
"AND C.RECNAME = 'CUSTOMER' " & _ 		
"AND D.SETID = C.SETID " & _		
"AND D.CUST_ID = B.CUST_ID " & _		
"AND B.ITEM_SELECTED = 'Y' " & _ 		
"AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _		
"AND B.ITEM = Q.ITEM)) " & _	
"AND Q.ITEM NOT IN " & _ 		
"(SELECT F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H " & _	 		
"WHERE E.TRN_BU = F.TRN_BU " & _	 		
"AND E.TRN_ID = F.TRN_ID " & _	 		
"AND F.ITEM_SELECTED = 'Y' " & _	 		
"AND G.SETCNTRLVALUE = F.BUSINESS_UNIT " & _	 		
"AND G.RECNAME = 'CUSTOMER' " & _	 		
"AND H.SETID = G.SETID " & _	 		
"AND H.CUST_ID = F.CUST_ID " & _	 		
"AND F.ITEM = Q.ITEM " & _	 		
"AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT) " & _			
"AND Q.ITEM NOT IN " & _	 		
"(SELECT J.ITEM " & _	 		
"FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L " & _	 		
"WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU " & _	 		
"AND I.DEPOSIT_ID = J.DEPOSIT_ID " & _	 		
"AND J.ITEM_SELECTED = 'Y' " & _	 		
"AND K.SETCNTRLVALUE = J.BUSINESS_UNIT " & _	 		
"AND K.RECNAME = 'CUSTOMER' " & _	 		
"AND L.SETID = K.SETID " & _	 		
"AND L.CUST_ID = J.CUST_ID " & _	 		
"AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _	 		
"AND J.ITEM = Q.ITEM)) " & _
"AND Q.ITEM NOT IN " & _	 		
"(SELECT Z.ITEM " & _	 		
"FROM PS_CUST_PND_MNT_VW Y, PS_PAYMENT_ITEM Z, PS_SET_CNTRL_REC X, PS_CUSTOMER W " & _	 		
"WHERE ( Y.BUSINESS_UNIT = Z.DEPOSIT_BU " & _	 		
"AND Y.WS_ID = Z.DEPOSIT_ID " & _	 		
"AND Z.ITEM_SELECTED = 'Y' " & _	 		
"AND X.SETCNTRLVALUE = Z.BUSINESS_UNIT " & _	 		
"AND X.RECNAME = 'CUSTOMER' " & _	 		
"AND W.SETID = X.SETID " & _	 		
"AND W.CUST_ID = Z.CUST_ID " & _	 		
"AND Z.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _	 		
"AND Z.ITEM = Q.ITEM)) " & _			
"AND Q.ITEM NOT IN " & _	 		
"(SELECT N.ITEM " & _			
"FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P " & _	 		
"WHERE ( M.GROUP_BU = N.GROUP_BU " & _	 		
"AND M.GROUP_ID = N.GROUP_ID " & _	 		
"AND O.SETCNTRLVALUE = N.BUSINESS_UNIT " & _	 		
"AND O.RECNAME = 'CUSTOMER' " & _	 		
"AND P.SETID = O.SETID " & _	 		
"AND P.CUST_ID = N.CUST_ID " & _	 		
"AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _	 		
"AND N.ITEM = Q.ITEM " & _	 		
"AND N.POST_DT IS NULL)) "

           
    WriteToReport micDone, "SQL query for " & unit & "", "Query used for Invoice Info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
    	dbFetchEDITransCDWDirectAccount = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Database_Info" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then   
        dbFetchEDITransCDWDirectAccount = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Database_Info" & unit)
    Else
    	dbFetchEDITransCDWDirectAccount = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Database_Info" & unit)
    End If
    
On Error goto 0	
End Function

Public Function dbGetIDInfo(businessUnit)
	Dim sSQL
	Dim arrRecordValues()
	
	sSQL = " SELECT * FROM PS_DEPOSIT_CONTROL WHERE BUSINESS_UNIT = '" & businessUnit& "' " & _
                "AND DEP_POST_STATUS <> 'C' " & _
                 "AND PAY_WS_TYPE= 'C' "
	WriteToReport micDone, "SQL query for " & businessUnit & "", "Query used for Invoice Info is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	   dbGetIDInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Database_Info1_" & businessUnit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then   
	   dbGetIDInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Database_Info1_" & businessUnit)		
	Else
	  dbGetIDInfo = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Database_Info1_" & businessUnit)
	End If
    
On Error goto 0
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchPayMulItemsbyCC is helper component to retreive the sigle row from database
''' </summary>
''' <author>Vikram Enukonda</author>
''' <datecreated>1-Dec-2015</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'08/18/2016                     added custID parameter to retrieve multiple records for the given cust ID
'**************************************************************************************************************
Public Function dbFetchPayMulItemsbyCC(unit,custID)
	Err.Clear
On Error Resume Next

	Dim sSQL
	Dim arrRecordValues()
	
	sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.BAL_AMT, R.INVOICE, Q.ITEM_STATUS FROM PS_ITEM Q , PS_BI_HDR R WHERE Q.BAL_AMT > 0 AND Q.CUST_ID = R.BILL_TO_CUST_ID AND R.INVOICE = Q.INVOICE AND Q.BUSINESS_UNIT ='" & unit & "'  AND Q.CUST_ID = 'custID& "' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) AND Q.ITEM NOT IN ( (SELECT B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM))) AND Q.ITEM NOT IN (SELECT F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT)) AND Q.ITEM NOT IN (SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM)) AND Q.ITEM NOT IN (SELECT N.ITEM  FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL)) "                       
	
'           sSQL = "Select DISTINCT Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.ENTRY_TYPE, Q.BAL_AMT FROM PS_ITEM Q , PS_BI_HDR R WHERE Q.BAL_AMT > 0 " & _ 
'"AND Q.BUSINESS_UNIT = '00001' " & _ 
'"AND Q.CUST_ID IN (SELECT CUST_ID FROM PS_ITEM A WHERE A.BAL_AMT > 0 " & _ 
'"GROUP BY CUST_ID " & _ 
'"HAVING COUNT(A.ITEM) = 2) " & _ 
'"AND Q.CUST_ID = R.BILL_TO_CUST_ID AND R.INVOICE LIKE 'ZR%' AND Q.ENTRY_TYPE = 'IN' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _ 
'"AND Q.ITEM NOT IN ( (SELECT B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D " & _ 
'"WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' " & _ 
'"AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM) UNION SELECT F.ITEM FROM " & _ 
'"PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND " & _ 
'"G.SETCNTRLVALUE = F.BUSINESS_UNIT AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT) " & _ 
'  "UNION SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU AND I.DEPOSIT_ID = J.DEPOSIT_ID " & _ 
'  "AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT " & _ 
'  "AND J.ITEM = Q.ITEM) UNION SELECT N.ITEM FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID " & _ 
'   "AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM " & _ 
'   "AND N.POST_DT IS NULL))) " & _ 
' "GROUP BY  Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.ENTRY_TYPE, Q.BAL_AMT "
      '''changing query as per rini 06/21

      
    WriteToReport micDone, "SQL query for Pay Multiple AR Items by Credit Card ", "Query used for Pay Multiple AR Items by Credit Card is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchPayMulItemsbyCC = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "PayMulItmsCC_Info" & unit, "ITEM")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then     
	     dbFetchPayMulItemsbyCC = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "PayMulItmsCC_Info" & unit, "ITEM")
    Else
        dbFetchPayMulItemsbyCC = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "PayMulItmsCC_Info" & unit, "ITEM")
   End If
    
On Error goto 0  
End Function

'**************************************************************************************************************
''' <summary> 
''' noOfItemsCount is helper component to retreive the number of items count for each customer ID
''' </summary>
''' <author>Venu Arigela</author>
''' <datecreated>18-Aug-2016</datecreated>
''' <param name="unit" type="string">Business unit id </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
''' <returns type="Number">0 if no records found, else record count</returns>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function noOfItemsCount(unit)
	Dim sSQL
	Dim arrRecordValues()

  sSQL = "Select Q.BUSINESS_UNIT, Q.CUST_ID , COUNT(Q.ITEM) as ITEMS_COUNT " & _
		    "FROM PS_ITEM Q , PS_BI_HDR R " & _
			"WHERE Q.BAL_AMT > 0 AND Q.CUST_ID = R.BILL_TO_CUST_ID AND R.INVOICE = Q.INVOICE AND Q.BUSINESS_UNIT ='" & unit & "' " & _ 
			"AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT " & _
			"AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) " & _ 
			"AND Q.ITEM NOT IN ( (SELECT  B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D " & _
			                       "WHERE ( A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID  AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' " & _ 
			                        "AND D.SETID = C.SETID   AND D.CUST_ID = B.CUST_ID  AND B.ITEM_SELECTED = 'Y' AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM))) " & _ 
			 "AND Q.ITEM NOT IN (SELECT  F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H " & _  
			                     "WHERE ( E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID   AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT  AND G.RECNAME = 'CUSTOMER' " & _
			                     "AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID  AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT)) " & _ 
			 "AND Q.ITEM NOT IN (SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L " & _ 
			                       "WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU  AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' " & _
			                       "AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER' " & _ 
			                       "AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM)) " & _ 
			 "AND Q.ITEM NOT IN (SELECT N.ITEM  FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P " & _ 
			                      "WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' " & _ 
			                      "AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL)) " & _ 
			   "GROUP BY Q.BUSINESS_UNIT, Q.CUST_ID " & _
			   "HAVING COUNT(Q.ITEM) > 1 "
			   
    WriteToReport micPass,"SQL query for Customer", "Query used for customer info is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		 noOfItemsCount = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Items_Count_" & unit)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then        		 
		noOfItemsCount = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Items_Count_" & unit)
	  Else
          noOfItemsCount = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Items_Count_" & unit)   	  
	End If

End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetRevProBillingTableHDR is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>27-Nov-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetRevProBillingTableHDR(BusinessUnit, Invoice)
	Dim sSQL
	Dim arrRecordValues()
	
    'Perform a SQL operation to validate that the Invoice has posted or not posted
       'Query used
       sSQL =  "Select BUSINESS_UNIT, INVOICE, CDW_EXTRACT_DATE, CDW_APPLIED_DATE, POSTED_FLAG " & _
       "from PS_CDW_RPBI_HD_STG " &_
       "Where BUSINESS_UNIT = '" & BusinessUnit & "' AND " & _ 
       "INVOICE = '" & Invoice & "'"

     WriteToReport micDone, "SQL query", "Query used for RevProBillingTableHDR is " & sSQL, False
     
    'First parameter is our sql query
	'Second parameter is created in function.
	'Third parameter is arrRecordValues, which is our previously declared  empty array.
	'Final parameter is the label for our data being stored in the datatable
	 dbgetRevProBillingTableHDR = dbGetFirstRecord(sSQL, "", arrRecordValues, "dbgetRevProBillingTableHDR")
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetRevProBillingTableHDRDetails is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>27-Nov-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'12/27/2017        Eric Trout   Updated to pull all rows of results
'**************************************************************************************************************
Public Function dbgetRevProBillingTableHDRDetails(BusinessUnit, Invoice)
	Dim sSQL
	Dim arrResults()
   
   'Perform a SQL operation to validate Invoice details are still the same
   'Query used
	sSQL =  "Select B.BUSINESS_UNIT, B.INVOICE, B.LINE_SEQ_NUM, B.ACCOUNT, B.DEPTID, B.GROSS_EXTENDED_AMT, B.INVOICE_TYPE, B.BILL_SOURCE_ID " & _
   	"from PS_BI_LINE_DST A, PS_CDW_RPBI_DT_STG B " &_
   	"Where A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.INVOICE = B.INVOICE AND A.LINE_SEQ_NUM = B.LINE_SEQ_NUM AND A.BUSINESS_UNIT = '" & BusinessUnit & "' AND " & _ 
   	"B.INVOICE = '" & Invoice & "' ORDER BY B.LINE_SEQ_NUM"

	WriteToReport micDone, "SQL query", "Query used for RevProBillingTableHDRDetails is " & sSQL, False
     
    'First parameter is our sql query
	'Second parameter is created in function.
	'Third parameter is arrResults, which is our previously declared  empty array.
	'Final parameter is the label for our data being stored in the datatable
	dbgetRevProBillingTableHDRDetails = dbGetRecords(sSQL,"", arrResults, "dbgetRevProBillingTableHDRDetails")
 End Function
    
'*************************************************************************************************************
''' <summary> 
''' dbgetDistributionStatus is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>27-Nov-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'*************************************************************************************************************
Public Function dbgetDistributionStatus(Invoice)
	Dim sSQL
	Dim arrRecordValues()
    
    'Run the following SQL query to verify our distribution status
	sSql =  "SELECT GL_DISTRIB_STATUS, INVOICE, ACCT_ENTRY_TYPE " &_
			"FROM PS_BI_ACCT_ENTRY " &_
			"WHERE GL_DISTRIB_STATUS = 'D' and ACCT_ENTRY_TYPE = 'RR' and INVOICE like '%" & Invoice & "%'"
	WriteToReport micDone, "SQL query", "Query used for VerifyGLDistribution is " & sSQL, False
	
	'First parameter is our sql query
	'Second parameter is a constant based on our environment.
	'Third parameter is arrRecordValues, which is our previously declared  empty array.
	'Final parameter is the label for our data being stored in the datatable
	dbgetDistributionStatus = dbGetFirstRecord(sSQL, "", arrRecordValues, "dbgetDistributionStatus")
    
End Function   

'**************************************************************************************************************
''' <summary> 
''' dbgetWOHDR is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>27-Nov-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetWOHDR(BusinessUnit, CustID, Item, Item_Line, Item_Seq)
	Dim sSQL
	Dim arrRecordValues() 
    
   'Perform a SQL operation to validate that the transaction has posted or not posted
   'Query used
   	sSQL =  "Select BUSINESS_UNIT, CUST_ID, ITEM, ITEM_LINE, ITEM_SEQ_NUM , CDW_EXTRACT_DATE, CDW_APPLIED_DATE, POSTED_FLAG " & _
	   "from PS_CDW_RPAR_HD_STG " &_
	   "Where BUSINESS_UNIT = '" & BusinessUnit & "' AND CUST_ID = '" & CustID & "' AND ITEM = '" & Item & "' AND  ITEM_LINE = '" & Item_Line & "'"
    WriteToReport micDone, "SQL query", "Query used for dbgetWOHDR is " & sSQL, False
     
    'First parameter is our sql query
	'Second parameter is set in function
	'Third parameter is arrRecordValues, which is our previously declared  empty array.
	'Final parameter is the label for our data being stored in the datatable
     dbgetWOHDR = dbGetFirstRecord(sSQL, "", arrRecordValues, "dbgetWOHDR")
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetWOHDRDetails is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>27-Nov-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetWOHDRDetails(BusinessUnit, CustID, Item, Item_Line, Item_Seq)
	Dim sSQL
	Dim arrRecordValues() 
    
    'Perform a SQL operation to validate details are still the same
    'Query used
     sSQL =  "Select ACCOUNT, DEPTID, * " & _
   		"from  PS_CDW_RPAR_DT_STG " &_
    	"Where BUSINESS_UNIT = '" & BusinessUnit & "' AND CUST_ID = '" & CustID & "' AND ITEM = '" & Item & "' AND ITEM_LINE = '" & Item_Line & "' "
     WriteToReport micDone, "SQL query", "Query used for dbgetWOHDRDetails is " & sSQL, False
     
    'First parameter is our sql query
	'Second parameter is set in function
	'Third parameter is arrRecordValues, which is our previously declared  empty array.
	'Final parameter is the label for our data being stored in the datatable
     dbgetWOHDRDetails = dbGetFirstRecord(sSQL, "", arrRecordValues, "dbgetWOHDRDetails")
End Function 

'**************************************************************************************************************
''' <summary> 
''' Get the WriteOff that we will be performing our testing on
''' </summary>
''' <author>Rama Stephen King</author>
''' <datecreated>13-Nov-2017</datecreated>
''' <startstate>LaunchApplication called with username LISAPAP</startstate>
''' <endstate>Completed</endstate>
''' <returns type="NA"> True if found and clicked</returns>
'Change Control: 
'Date of Change 	Author 		Description of change
'11/17/2017			Stephen King	Updated variables and global dictionary values. Updated reporter statements for each object.
'11/27/2017         Eric Trout      Moved to PSF_Database
'02/25/2019			Eric Trout		Updated to allow for Greater Than and Less Than Balance Amount
'*************************************************************************************************************
Public Function dbgetWOItem(BU,GreaterThan,LessThan)
	Dim arrRecordValues()
	Dim sSQL
	
	'Get the Item to work on
	sSQL = "SELECT TOP 1 * FROM (PS_ITEM A LEFT OUTER JOIN PS_CUST_PND_MNT_VW B ON A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.ITEM = B.ITEM),"&_ 
			" (PS_ITEM E LEFT OUTER JOIN PS_PAYMENT_ID_ITEM F ON E.BUSINESS_UNIT = F.DEPOSIT_BU AND E.ITEM = F.ITEM),"&_ 
			" (PS_ITEM G LEFT OUTER JOIN PS_WS_ITEM H ON G.BUSINESS_UNIT = H.BUSINESS_UNIT AND G.ITEM = H.ITEM),"&_ 
			" (PS_ITEM I LEFT OUTER JOIN PS_PAYMENT_ITEM J ON I.BUSINESS_UNIT = J.BUSINESS_UNIT AND I.ITEM = J.ITEM)"&_ 
			" WHERE A.ITEM_STATUS = 'O' AND A.REF_REASON = '' AND A.ENTRY_TYPE = 'IN' AND A.BUSINESS_UNIT IN ('"&GlobalDictionary("BusinessUnit")&"')"&_ 
			"AND A.BAL_AMT > "&GreaterThan&" AND A.BAL_AMT < "&LessThan&" " &_
			" AND B.ITEM IS NULL AND F.ITEM IS NULL AND H.ITEM IS NULL AND J.ITEM IS NULL"&_ 
			" AND A.ITEM = E.ITEM AND A.ITEM = G.ITEM AND A.ITEM = I.ITEM ORDER BY A.POST_DT"
	WriteToReport micDone, "SQL query", "Query used for dbgetWOItem is " & sSQL, False
	
	dbGetWOItem = dbGetFirstRecord(sSQL, "", arrRecordValues, "GetWOItem")
End Function

'**************************************************************************************************************
''' <summary> 
''' dbgetApprover is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>28-Nov-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbgetApprover(User)
	Dim sSQL
	Dim arrRecordValues() 

    'Perform a SQL operation to validate that our created invoice exists in the database
	sSql =  "SELECT C.OPRID FROM PS_JOB A, PSOPRDEFN B, PSOPRDEFN C " &_
            "WHERE  A.EMPLID = B.EMPLID " &_ 
            "AND B.OPRID = '" & User & "' " &_
            "AND A.SUPERVISOR_ID = C.EMPLID " &_
            "AND ( A.EFFDT =" &_ 
                    "(SELECT MAX(A_ED.EFFDT) FROM PS_JOB A_ED " &_ 
                    "WHERE A.EMPLID = A_ED.EMPLID " &_ 
                    "AND A.EMPL_RCD = A_ED.EMPL_RCD " &_ 
                    "AND A_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) " &_ 
            "AND A.EFFSEQ = " &_ 
                    "(SELECT MAX(A_ES.EFFSEQ) FROM PS_JOB A_ES " &_ 
                    "WHERE A.EMPLID = A_ES.EMPLID " &_ 
                    "AND A.EMPL_RCD = A_ES.EMPL_RCD " &_ 
                    "AND A.EFFDT = A_ES.EFFDT))"
	WriteToReport micDone, "SQL Query", "Query used for dbgetApprover is " & sSQL, false
	
	'First parameter is our sql query
	'Second parameter is created in function.
	'Third parameter is arrRecordValues, which is our previously declared  empty array.
	'Final parameter is the label for our data being stored in the datatable
	dbgetApprover = dbGetFirstRecord(sSQL,"", arrRecordValues, "dbgetApprover")
End Function 
'*************************************************************************************************************
''' <summary> 
''' dbgetWOReason is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>29-Nov-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'*************************************************************************************************************
Public Function dbgetWOReason(sSetID)
    Dim sSQL
	Dim arrRecordValues() 
        'Pull in Reason with Query
        sSQL =  "Select Top 1  ENTRY_REASON  from PS_AUTO_LINES_TBL where ACCOUNT = '27544' AND SETID = '" & sSetID & "' AND ENTRY_REASON <> '' "
         WriteToReport micDone, "SQL query for Reason", "Query used for Reason is " & sSQL, false
         
        'First parameter is our sql query
        'Second parameter is created in function.
        'Third parameter is arrRecordValues, which is our previously declared  empty array.
        'Final parameter is the label for our data being stored in the datatable
        dbgetWOReason = dbGetFirstRecord(sSQL, "", arrRecordValues, "WriteOffReason")
End Function 


'**************************************************************************************************************
''' <summary> 
''' dbGetRevProAccountingEntries is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>27-Nov-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetRevProAccountingEntries(Invoice)
	Dim sSQL
	Dim arrRecordValues() 
    
    'Perform a SQL operation to validate that our created invoice exists in the database
	sSql =  "SELECT HDR.BUSINESS_UNIT, HDR.INVOICE, HDR.INVOICE_DT, HDR.BILL_STATUS , HDR.BILL_SOURCE_ID, HDR.PAYMENT_METHOD, HDR.INVOICE_AMOUNT, HDR.BILL_TYPE_ID " &_
			"FROM PS_BI_HDR HDR " &_
			"WHERE HDR.INVOICE = '" & Invoice & "'"

	WriteToReport micDone, "SQL Query", "Query used for dbGetRevProAccountingEntries is " & sSQL, false
	
	'First parameter is our sql query
	'Second parameter is created in function.
	'Third parameter is arrRecordValues, which is our previously declared  empty array.
	'Final parameter is the label for our data being stored in the datatable
	dbGetRevProAccountingEntries = dbGetFirstRecord(sSQL,"", arrRecordValues, "dbGetRevProAccountingEntries")
 
End Function 

'**************************************************************************************************************
''' <summary> 
''' dbgetItemActivity is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>05-Dec-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'*************************************************************************************************************
Public Function dbgetItemActivity(sCustID, sItem, sWOType)
	Dim sSQL
	Dim arrRecordValues() 
    
    'Perform a SQL operation to validate that our created invoice exists in the database
	sSql =  "Select BUSINESS_UNIT, CUST_ID,ITEM, ITEM_LINE, ITEM_SEQ_NUM " &_
    	"From PS_ITEM_ACTIVITY " &_
    	"Where CUST_ID = '" & sCustID & "' AND ITEM = '" & sItem & "' AND ENTRY_TYPE = '" & sWOType & "'"

	WriteToReport micDone, "SQL Query", "Query used for dbgetItemActivity is " & sSQL, false
	
	'First parameter is our sql query
	'Second parameter is created in function.
	'Third parameter is arrRecordValues, which is our previously declared  empty array.
	'Final parameter is the label for our data being stored in the datatable
	dbgetItemActivity = dbGetFirstRecord(sSQL,"", arrRecordValues, "dbgetItemActivity")
 
End Function 


'**************************************************************************************************************
''' <summary> 
''' dbgetItemDetailsy is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>05-Dec-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'*************************************************************************************************************
Public Function dbgetItemDetails(BusinessUnit, CustID, Item, Item_Line, Item_Seq)
	Dim sSQL
	Dim arrRecordValues() 
    
    'Perform a SQL operation to validate that our created invoice exists in the database
	sSql =  "SELECT ACCOUNT, DEPTID, * " &_
            "FROM PS_ITEM_DST " &_ 
            "Where BUSINESS_UNIT = '" & BusinessUnit & "' AND CUST_ID = '" & CustID & "' AND ITEM = '" & Item & "' AND ITEM_LINE = '" & Item_Line & "' AND ITEM_SEQ_NUM = '" & Item_Seq & "'"
	WriteToReport micDone, "SQL Query", "Query used for dbgetItemDetails is " & sSQL, false
	
	'First parameter is our sql query
	'Second parameter is created in function.
	'Third parameter is arrRecordValues, which is our previously declared  empty array.
	'Final parameter is the label for our data being stored in the datatable
	dbgetItemDetails = dbGetFirstRecord(sSQL,"", arrRecordValues, "dbgetItemDetails")
End Function 

'*************************************************************************************************************
''' <summary> 
''' dbgetNonRevRecWOReason is helper component to retreive the sigle row from database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>7-Dec-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'*************************************************************************************************************
Public Function dbgetNonRevRecWOReason(sSetID)
    Dim sSQL
	Dim arrRecordValues() 
        'Pull in Reason with Query
        sSQL =  "select distinct  ENTRY_REASON  from PS_AUTO_LINES_TBL where ACCOUNT <> '27544' and SETID = '"& sSetID &"' AND ENTRY_REASON <> ''"

         WriteToReport micDone, "SQL query for Reason", "Query used for Reason is " & sSQL, false
         
        'First parameter is our sql query
        'Second parameter is created in function.
        'Third parameter is arrRecordValues, which is our previously declared  empty array.
        'Final parameter is the label for our data being stored in the datatable
        dbgetNonRevRecWOReason = dbGetFirstRecord(sSQL, "", arrRecordValues, "dbgetNonRevRecWOReason")
End Function 

'**************************************************************************************************************
''' <summary> 
''' dbGetRecords is helper component to retreive all records from database and put them into a datatable.  Modified GetAllRecords
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>11-Dec-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetRecords(strSQL,sConnectionString, arrRecordValues,sheetName)

Dim dBRecSet,objConnection, connectionString, databaseName	
	Dim intLoop, iArrayNo, nRecordCount, sOneRecord,nReportValue
	Dim sTemp,i,j,x, fields, nColumns, n, nRow
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	      connectionString = PSFCONNECTIONSTRFNQA
	      databaseName     = dbName_FNQA
    elseIf  StrComp (GlobalDictionary("Environment"),"FNDEV") = 0 Then
	      connectionString = PSFCONNECTIONSTRFNDEV
	      databaseName     = dbName_FNDEV      
	elseIf  StrComp (GlobalDictionary("Environment"), "FNTST") = 0 Then
	      connectionString = PSFCONNECTIONSTRFNTST
	      databaseName     = dbName_FNTST
	ElseIf StrComp(GlobalDictionary("Environment"),"FNRVTST") = 0 Then
	      connectionString = PSFCONNECTIONSTRFNRVTST
	      databaseName     = dbName_FNRVTST
	Else
           connectionString = PSFCONNECTIONSTRFNREG
	      databaseName     = dbName_FNREG     
	End If
  'Set the Database connection object 
	Set objConnection= dbOpenConnection(connectionString,databaseName,dbPWDVM)
	
	'Increase our execution time to allow for db performance and/or lots of records returning
	objConnection.CommandTimeout = 120

	'Verify for object exist or not
	If IsObject(objConnection) Then	
		'Execute the SQL and get the recordset object
		On Error Resume Next
		Set dBRecSet = objConnection.Execute(strSQL)
		Datatable.AddSheet (sheetName)
        'Sets to 0 to pull column name first
		Datatable.AddSheet (sheetName).SetCurrentRow(0)
		fields = 0
        If IsObject(dBRecSet) Then
	
			If dBRecSet.EOF = False Then
				'Column Names
			    For i = 0 To dBRecSet.fields.count-1
			    	DataTable.GetSheet(sheetName).AddParameter dBRecSet.fields(i).Name,""
			    Next
				
                'sets to 1 to start pulling in data
				j=1
                 'Data
				Do while dBRecSet.EOF <> True				
                    ReDim Preserve arrRecordValues(j)
                    DataTable.SetCurrentRow(j)
                    'Row
                    For x = 0 To dBRecSet.fields.count-1
                             ReDim Preserve arrRecordValues(x)
                            DataTable.Value(""&dBRecSet.fields(x).Name,sheetName) = ""&dBRecSet.fields(x).Value
                            arrRecordValues(x) = ""&dBRecSet.fields(x).Value				      
                     Next					                   

                    dBRecSet.MoveNext                        
                    j = j + 1
                Loop             


			Else
			 WriteToReport micFail, "DB records", "Returned zero records", false
		    End If
		Else
		   WriteToReport nReportValue, "Verifying the Record from Database", "No Record Exist for SQL: [" & strSQL & "]"
			
	     End If
	     
	     Else
	        WriteToReport micFail, "DB connection", "Data base connection is failed", false
	     End If

	dbGetRecords =arrRecordValues

	'Clean up opened objects
 	dBRecSet.Close
	objConnection.Close

End Function

'*************************************************************************************************************
''' <summary> 
''' dbGetRevProJournalEntries is helper component to all results from the database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>11-Dec-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'*************************************************************************************************************
Public Function dbGetRevProJournalEntries(sBusinessUnit, sTransactionID)
    Dim sSQL
	Dim arrRecordValues() 
        'Pull in Journal Entries with Query
        sSQL =  "SELECT DISTINCT JOURNAL_ID " &_
                "FROM PS_JGEN_ACCT_ENTRY " &_
                "WHERE TRANSACTION_ID = '" & sTransactionID & "' and BUSINESS_UNIT = '" & sBusinessUnit & "'"

         WriteToReport micDone, "SQL query for Journal Entries", "Query used to retrieve journal entries is " & sSQL, false
         
        'First parameter is our sql query
        'Second parameter is created in function.
        'Third parameter is arrRecordValues, which is our previously declared  empty array.
        'Final parameter is the label for our data being stored in the datatable
        dbGetRevProJournalEntries = dbGetRecords(sSQL, "", arrRecordValues, "dbGetRevProJournalEntries")
End Function 

'*************************************************************************************************************
''' <summary> 
''' dbgetBILineDetails is helper component to all results from the database
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>13-Dec-2017</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'12/27/2017        Eric Trout   Updated to pull all rows of results
'*************************************************************************************************************
Public Function dbgetBILineDetails(sBusinessUnit, sInvoice)
    Dim sSQL
	Dim arrRecordValues() 
        'Pull in BI Line Details with Query
        sSQL =  "SELECT A.BUSINESS_UNIT, A.INVOICE, A.LINE_SEQ_NUM, A.ACCOUNT, A.DEPTID, A.AMOUNT " &_
                "FROM PS_BI_LINE_DST A, PS_CDW_RPBI_DT_STG B " &_
                "WHERE A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.INVOICE = B.INVOICE AND A.LINE_SEQ_NUM = B.LINE_SEQ_NUM AND A.INVOICE = '" & sInvoice & "' and A.BUSINESS_UNIT = '" & sBusinessUnit & "' ORDER BY B.LINE_SEQ_NUM"
         WriteToReport micDone, "SQL query for BI Line Details", "Query used to BI Line Details is " & sSQL, False

        'First parameter is our sql query
        'Second parameter is created in function.
        'Third parameter is arrRecordValues, which is our previously declared  empty array.
        'Final parameter is the label for our data being stored in the datatable
        dbgetBILineDetails = dbGetRecords(sSQL, "", arrRecordValues, "dbgetBILineDetails")
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetTransactionID exists to pull the most recent transaction ID so that we can ensure a unique one for testing
''' </summary>
''' <author>Stephen King</author>
''' <datecreated>15-Jan-20185</datecreated>
''' <param name="ProjecID" type="string">Project code, such as RG or RP</param>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
''' <returns type="String">"" if an error, 00000000 if no IDs found, the most recent transaction ID otherwise</returns>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetTransactionID(ProjectID)
	Dim nResult
	Dim sSQL
	Dim arrResults()

	'Build and report our SQL string to search for the newest entry based on our project code
			'We pull the project code(usually 2 but sometimes 3, full transaction ID, and the batch ID
			'Limit our results to what matches our project code
			'Make sure that we return the most recent result(sorts by cdw_batch_id)
'	sSQL = "SELECT substring(FILENAME, 17, " & Len(ProjectID) & ") AS PROJECT, substring(FILENAME, 19, 8) AS T_ID, CDW_BATCH_ID " &_
'			"FROM PS_CDW_JGENFLD_FNM " &_
'			"WHERE substring(FILENAME, 17, " & Len(ProjectID) & ") = '" & ProjectID & "' " &_
'			"ORDER BY T_ID DESC"
	sSQL = "SELECT DISTINCT TRANSACTION_ID FROM PS_JGEN_ACCT_ENTRY WHERE substring(TRANSACTION_ID, 1, 2) = '" & ProjectID & "'  ORDER BY 1 DESC"
	WriteToReport micDone, "SQL QUERY", sSQL, False

	'Execute our SQL query
	dbGetTransactionID = dbGetFirstRecord(sSQL, "", arrResults, "dbGetTransactionID")

	'Check our results
    On Error Resume Next
	nResult = UBound(arrResults)
	If IsEmpty(nResult) = False Then
		'If our first string matches our project code, then we return the transaction ID
    	If InStr(1, arrResults(0), ProjectID, vbTextCompare) > 0 Then
	    	WriteToReport micPass, "dbGetTransactionID - SQL Query", ProjectID & " Transaction ID found in database, returning transaction ID " & arrResults(0), False
	    	
	    	'Transaction ID lengths without the project code are always formatted for 8 spaces
	    	dbGetTransactionID = Right(arrResults(0), 8)
	    	Exit Function

		'If there was an issue executing the query for some reason, report an error and exit the test    
	    Else
	    	On Error Goto 0
	    	WriteToReport micFail, "dbGetTransactionID - SQL Query", "Returned " & arrResults(0) & ", expecting " & ProjectID & ". Please check query and database.", False
	    	dbGetTransactionID = ""
    		ExitTest
	    End If

	'If the query successfully executed but there's no results returned, then we start over
	Else
	    On Error Goto 0
	    WriteToReport micDone, "dbGetTransactionID - SQL Query", "No " & ProjectID & " Transaction ID found in database, starting from '00000000'", False
	    dbGetTransactionID = "00000000"
	    Exit Function
    End If
End Function

'**************************************************************************************************************
''' <summary>
''' This function is used to return the value of a specified column from the output of SQLquery
''' </summary>
''' <author>Jolly</author>
''' <datecreated>Oct 17, 2008 </datecreated>
''' <param name="sColumnName" type="string"></param>
''' <param name="strSQL" type="string"></param>
''' <param name="sConnectionString" type="string"></param>
''' <startstate>none</startstate>
''' <endstate>none</endstate>
''' <returns type="string"></returns>
'Change Control: 
'       Date of Change          Author          Desc 
'______________________________________________________ 
Public Function dbGetResultValue(sColumnName, strSQL,sConnectionString )

	Dim dBRecSet,objConnection	
	Dim sColValue, connectionString, databaseName
	
	If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
		connectionString = PSFCONNECTIONSTRFNQA
		databaseName     = dbName_FNQA
 	ElseIf StrComp(GlobalDictionary("Environment"), "FNTST") = 0 Then
		connectionString = PSFCONNECTIONSTRFNTST
		databaseName     = dbName_FNTST
	ElseIf StrComp(GlobalDictionary("Environment"), "FNRVTST") = 0 Then
		connectionString = PSFCONNECTIONSTRFNRVTST
		databaseName     = dbName_FNRVTST
	Else
		connectionString = PSFCONNECTIONSTRFNREG
		databaseName     = dbName_FNREG     
	End If
	
  'Set the Database connection object 
	Set objConnection= dbOpenConnection(connectionString,databaseName,dbPWDVM)
	
	'Verify for object exist or not
	If IsObject(objConnection) Then	
		'Execute the SQL and get the recordset object
		On Error Resume Next
		Set dBRecSet = objConnection.Execute(strSQL)
		If IsObject(dBRecSet) Then
			If dBRecSet.EOF = False Then
				sColValue = dBRecSet(sColumnName)
			Else			
				WriteToReport micFail, "Unable to retrieve records from database ", "No Record Exist for SQL " & strSQL
			End If
			WriteToReport micDone, "Column " & sColumnName &" has value: " & sColValue , "The SQL is " & strSQL 
		End If
	End If

	dbGetResultValue = sColValue

	'Clean up opened objects
 	dBRecSet.Close
	objConnection.Close
End Function 

'Status is based on posted or not(0/1)
'Reversed is reversed(N/R)
Public Function FindJournalForNegativeTesting(sSQL)
	Dim sDate, sMonth, sYear, tempSQL
    Dim arrRecordValues()
    Dim i, iMonth, iYear, nResult

	nResult = 0
	tempSQL = sSQL & " ORDER BY 2 DESC"
	WriteToReport micDone, "SQL query for Customer", "Query used for journal data is " & tempSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		FindJournalForNegativeTesting = dbGetFirstRecord(tempSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "FindJournalForNegativeTesting")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
		FindJournalForNegativeTesting = dbGetFirstRecord(tempSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "FindJournalForNegativeTesting")
	Else
		FindJournalForNegativeTesting = dbGetFirstRecord(tempSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "FindJournalForNegativeTesting")
	End If
End Function

'Return information for either the first journal with the known criteria(business unit) or a specific one based off of journal ID
Public Function FindJournal(journalID)
    Dim sSQL
    Dim arrRecordValues()

 	sSQL = "Select * FROM PS_JRNL_HEADER WHERE BUSINESS_UNIT = '" & GlobalDictionary("BusinessUnit") & "'"
 	If journalID <> "" Then
 		sSQL = sSQL & " AND JOURNAL_ID ='" & journalID & "'"
 	End If

	WriteToReport micDone, "SQL query for Customer", "Query used for journal data is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		FindJournal = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "FindJournalByID")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
		FindJournal = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "FindJournalByID")
	Else
		FindJournal = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "FindJournalByID")
	End If
End Function

'Header status: P for posted to ledgers, U for unposted, V for Valid Journal Edits Complete
'M Valid journal - do not post, N?
Public Function FindJournalsByPostedStatus(status)
	Dim sSQL, sDate, sMonth, sYear
    Dim arrRecordValues()

	'Format our date in a way that we can pull open journals from the database with a recently opened period
	'Periods are opened by month. However, early on(say, the first or second) the period either might not be open yet or there might not be any data
	'So we go back one month from the current month, with special logic for January as there is no 0th month.
	sMonth = DatePart("m", Now())
	sYear = DatePart("yyyy", Now())
	If sMonth <> 1 Then
		sMonth = sMonth - 1
	Else
		sMonth = 12
		sYear = sYear - 1
	End If

	sDate = sYear & "-" & sMonth & "-01 00:00:00.000"
	'sSQL = "Select * FROM PS_JRNL_HEADER WHERE BUSINESS_UNIT = '" & GlobalDictionary("BusinessUnit") & "' AND JRNL_HDR_STATUS = '" & status & "' AND OPRID = '" & GlobalDictionary("SignInUser") & "' AND SOURCE NOT IN ('ACR', 'TAR', 'FNA') "
	'sSQL = "Select * FROM PS_JRNL_HEADER WHERE BUSINESS_UNIT = '" & GlobalDictionary("BusinessUnit") & "' AND JRNL_HDR_STATUS = '" & status & "' AND OPRID = '" & GlobalDictionary("SignInUser") & "' AND SOURCE IN ('AR', 'BI') AND JOURNAL_DATE > '" & sDate & "'"
	'sSQL = status & " AND JOURNAL_DATE > '" & sDate & "' ORDER BY JOURNAL_ID DESC"
	sSQL = status & " ORDER BY JOURNAL_ID DESC"
	WriteToReport micDone, "SQL query for Customer", "Query used for journal data is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		FindJournalsByPostedStatus = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "FindJournalsByPostedStatus")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
		FindJournalsByPostedStatus = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "FindJournalsByPostedStatus")
	Else
		FindJournalsByPostedStatus = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "FindJournalsByPostedStatus")
	End If
End Function

'**************************************************************************************************************
''' <summary>
''' This function is used to return the value of the journal IDs and business units created after our consolidation process
''' </summary>
''' <author>Stephen King</author>
''' <datecreated>Oct 04, 2018 </datecreated>
''' <param name="strSource" type="string"></param>
''' <startstate>GLPOCONS process ran</startstate>
''' <endstate>none</endstate>
''' <returns type="string"></returns>
'Change Control: 
'       Date of Change          Author          Desc 
'______________________________________________________ 
Public Function dbReturnConsolidatedJournals(strSource)
	Dim sSQL, sDate
    Dim arrRecordValues()

	'Get the current date in yyyy-mm-dd format
	sDate = DatePart("yyyy", Now()) & "-" & DatePart("m", Now()) & "-" & DatePart("d", Now())

	'Build our SQL string, sorting by the highest(newest) journal ID)
	sSQL = "SELECT BUSINESS_UNIT, JOURNAL_ID, (CONVERT(CHAR(10), JOURNAL_DATE, 121)) " &_
			"FROM PS_JRNL_HEADER WHERE JOURNAL_DATE = '" & sDate & "' AND SOURCE = '" & strSource & "' ORDER BY 2 DESC"
	WriteToReport micDone, "SQL query for Consolidated Journals", "Query used for consolidated journals is " & sSQL, False
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		dbReturnConsolidatedJournals = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "dbReturnConsolidatedJournals")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then  
		dbReturnConsolidatedJournals = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "dbReturnConsolidatedJournals")
	Else
		dbReturnConsolidatedJournals = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "dbReturnConsolidatedJournals")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' Grabs Journal based on Status looking for and passes out to be used
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>10/17/2018</datecreated>
''' <param name="JournalStatus" type="string">Journal Header Status lookig for </param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'01/01/2019			Eric Trout	Added option to use datasheet to fill in data
'**************************************************************************************************************
Public Function dbGetJournalfromHeaderStatus(JournalStatus)
	Dim sAccountingPeriod , strSQL, sConnectionString, sFiscalYear, sheetName, sRows, sTodayDate 
	Dim arrRecordValues
	Dim count

	'get current Fiscal Year and Accounting Period
	sTodayDate = Date
	sFiscalYear = Year(sTodayDate)
	sAccountingPeriod = Month(sTodayDate)
	
	If GlobalDictionary("FiscalYear") <> "" Then
		sFiscalYear = GlobalDictionary("FiscalYear") 			
	End If
	
	If GlobalDictionary("AccountingPeriod") <> "" Then
		sAccountingPeriod = GlobalDictionary("AccountingPeriod") 			
	End If

	'Check for data to see if any needs to be created
	If JournalStatus = "N" OR JournalStatus = "U" Then
		strSQL = "Select Count(Distinct JOURNAL_ID) FROM PS_JRNL_HEADER " &_
				"Where FISCAL_YEAR = '" & sFiscalYear & "' AND BUSINESS_UNIT = '" & GlobalDictionary("BusinessUnit") & "' AND JRNL_HDR_STATUS = '" & JournalStatus & "' "
	Else
		strSQL = "Select Count(Distinct JOURNAL_ID) FROM PS_JRNL_HEADER " &_
				"Where FISCAL_YEAR = '" & sFiscalYear & "' AND ACCOUNTING_PERIOD = '" & sAccountingPeriod & "' AND BUSINESS_UNIT = '" & GlobalDictionary("BusinessUnit") & "' AND JRNL_HDR_STATUS = '" & JournalStatus & "' "
	End If

	dbGetFirstRecord strSQL, "", arrRecordValues, "dbGetJournalfromHeaderStatus"
	DataTable.SetCurrentRow(1)
	count = DataTable.Value("", "dbGetJournalfromHeaderStatus")
	'count = 0
	If count = 0 OR count = "0" Then

		'Create but don't post a journal
		If JournalStatus = "N" Then
			'GlobalDictionary("Account2") = ""
			'GlobalDictionary("Amount") = "-" & GlobalDictionary("Amount")
			GlobalDictionary("N") = "Y"
			SharedCreateAddJournal "dbGetJournalfromHeaderStatus", True
		Else
			SharedCreateAddJournal "dbGetJournalfromHeaderStatus", False
		End If

		If JournalStatus = "U" Then
			SharedProcessJournal "dbGetJournalfromHeaderStatus", False
		End If
	End If

	'Run our SQL for the test case
	If JournalStatus = "N" OR JournalStatus = "U" Then
		strSQL = "Select BUSINESS_UNIT, JOURNAL_ID, LEDGER_GROUP, FISCAL_YEAR, ACCOUNTING_PERIOD, JRNL_HDR_STATUS  " &_
				"FROM PS_JRNL_HEADER " &_
				"Where FISCAL_YEAR = '" & sFiscalYear & "' AND BUSINESS_UNIT = '" & GlobalDictionary("BusinessUnit") & "' AND JRNL_HDR_STATUS = '" & JournalStatus & "' "
	Else
	
		strSQL = "Select BUSINESS_UNIT, JOURNAL_ID, LEDGER_GROUP, FISCAL_YEAR, ACCOUNTING_PERIOD, JRNL_HDR_STATUS  " &_
				"FROM PS_JRNL_HEADER " &_
				"Where FISCAL_YEAR = '" & sFiscalYear & "' AND ACCOUNTING_PERIOD = '" & sAccountingPeriod & "' AND BUSINESS_UNIT = '" & GlobalDictionary("BusinessUnit") & "' AND JRNL_HDR_STATUS = '" & JournalStatus & "' "
	End If

	Call  WriteToReport (micPass, "Query used", "" & strSQL & "", False)
	GlobalDictionary("DBsheetname") = "JournalID_" & JournalStatus
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    dbGetJournalfromHeaderStatus = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, GlobalDictionary("DBsheetname"))
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    dbGetJournalfromHeaderStatus = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, GlobalDictionary("DBsheetname"))
	Else
	     dbGetJournalfromHeaderStatus = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, GlobalDictionary("DBsheetname"))    
	End If
	
	'Need to add check to see if there are no results and report
	'Checks to see if any results are in DataTable
	sRows = DataTable.GetSheet(GlobalDictionary("DBsheetname")).GetRowCount
	If  sRows <> 0 Then	
		GlobalDictionary("BusinessUnit") = DataTable.Value("BUSINESS_UNIT",GlobalDictionary("DBsheetname"))
		GlobalDictionary("Ledger") = DataTable.Value("LEDGER_GROUP",GlobalDictionary("DBsheetname"))
		GlobalDictionary("FiscalYear") = DataTable.Value("FISCAL_YEAR",GlobalDictionary("DBsheetname"))
		GlobalDictionary("AccountingPeriod") = DataTable.Value("ACCOUNTING_PERIOD",GlobalDictionary("DBsheetname"))
		GlobalDictionary("JournalID") = DataTable.Value("JOURNAL_ID",GlobalDictionary("DBsheetname"))
	Else
		Call WriteToReport (micFail, "No Results", "Returned empty results.", False)		
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' Find Account number that does not exist, inputs Start and goes thru 20 iterations
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>23Oct2018</datecreated>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Function FindNewAccount
	Dim arrRecordValues, i, sAccount, sRows, strSQL, bFound

		bFound = FALSE
	'Start seaching from here
	sAccount = GlobalDictionary("Account")
	
	'will search up to 20 times
	For i = 0 to 20

		strSQL = "Select *  " &_
				 "From PS_GL_ACCOUNT_TBL " &_
				 "Where ACCOUNT = '" & sAccount &"' "


		Call  WriteToReport (micPass, "Query used", "" & strSQL & "", False)
		GlobalDictionary("DBsheetname") = "Account"
		If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
			FindNewAccount = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, GlobalDictionary("DBsheetname"))
		ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
			FindNewAccount = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, GlobalDictionary("DBsheetname"))
		Else
			 FindNewAccount = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, GlobalDictionary("DBsheetname"))    
		End If
		
		'Checks to see if any results are in DataTable
		sRows = DataTable.GetSheet(GlobalDictionary("DBsheetname")).GetRowCount
		If  sRows <> 0 Then	
			'If Results increments Account and deletes Datasheet
			bFound = TRUE
			sAccount = sAccount + 1
			sAccount = Pad(sAccount, "5", "0")
			
			DataTable.DeleteSheet(GlobalDictionary("DBsheetname"))
		Else
			bFound = FALSE
			Exit For
		End If

	Next
		
		'Test stops and reports to check data if empty
		If bFound = TRUE Then
			WriteToReport micFail, "FindNewAccount", "Unable to find an account that does not exist within 20 from start account of ["& GlobalDictionary("Account")&"].  Try a different starting point.", True
			ExitTest		
		End If
		
		'Passes out Account not found to be used later
		GlobalDictionary("Account") = sAccount
		
End Function	

'**************************************************************************************************************
''' <summary> 
''' Find DeptID that does not exist, inputs Start and goes thru 20 iterations
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>23Oct2018</datecreated>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Function FindNewDeptID
	Dim arrRecordValues, i, sDeptID, sRows, strSQL, bFound
	
	bFound = FALSE

	'Start seaching from here
	sDeptID = GlobalDictionary("DeptID")
	
	'will search up to 20 times
	For i = 0 to 20

		strSQL = "Select *  " &_
				 "From PS_DEPT_TBL " &_
				 "Where DEPTID = '" & sDeptID &"' "

		Call  WriteToReport (micPass, "Query used", "" & strSQL & "", False)
		GlobalDictionary("DBsheetname") = "DeptID"
		If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
			FindNewDeptID = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, GlobalDictionary("DBsheetname"))
		ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
			FindNewDeptID = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, GlobalDictionary("DBsheetname"))
		Else
			 FindNewDeptID = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, GlobalDictionary("DBsheetname"))    
		End If
		
		'Checks to see if any results are in DataTable
		sRows = DataTable.GetSheet(GlobalDictionary("DBsheetname")).GetRowCount
		If  sRows <> 0 Then	
			bFound = TRUE
			'If Results increments Dept and deletes Datasheet
			sDeptID = sDeptID + 1
			sDeptID = Pad (sDeptID, "5", "0")
			
			DataTable.DeleteSheet(GlobalDictionary("DBsheetname"))
		Else
			bFound = FALSE
			Exit For
		End If

	Next
	
		'Test stops and reports to check data if empty
		If bFound = TRUE Then
			WriteToReport micFail, "FindNewAccount", "Unable to find an DeptID that does not exist within 20 from start Dept of ["& GlobalDictionary("DeptID")&"].  Try a different starting point.", True
			ExitTest		
		End If
		
		'Passes out Dept not found to be used later
		GlobalDictionary("DeptID") = sDeptID
		
End Function

'**************************************************************************************************************
''' <summary> 
''' Find Dept ID match with Account or Account match with Dept ID
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>23Oct2018</datecreated>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Function dbGetCombinations(sType, sValue)
	Dim arrRecordValues, sRows, strSQL


	If sType = "Account" Then
		strSQL = "Select *  " &_
				 "From PS_COMBO_DATA_TBL  " &_
				 "Where ACCOUNT = '" & sValue &"' "	&_				
				 "AND PROCESS_GROUP = '" & GlobalDictionary("BusinessUnit") &"' "		
	End If
	
	If sType = "Dept" Then
		strSQL = "Select *  " &_
				 "From PS_COMBO_DATA_TBL  " &_				
				"Where DEPTID = '" & sValue &"' " &_
				"AND PROCESS_GROUP = '" & GlobalDictionary("BusinessUnit") &"' "	
	End If	
				
		Call  WriteToReport (micPass, "Query used", "" & strSQL & "", False)
		GlobalDictionary("DBsheetname") = "dbGetCombinations_"& sType
		If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
			dbGetCombinations = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, GlobalDictionary("DBsheetname"))
		ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
			dbGetCombinations = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, GlobalDictionary("DBsheetname"))
		Else
			 dbGetCombinations = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, GlobalDictionary("DBsheetname"))    
		End If
		
		'Checks to see if any results are in DataTable
		sRows = DataTable.GetSheet(GlobalDictionary("DBsheetname")).GetRowCount
		If  sRows = 0 Then	
			WriteToReport micPass, "dbGetCombinations", "No results returned.", False	
			ExitTest
		End If

End Function

'**************************************************************************************************************
''' <summary> 
''' Find Account number that does exist, inputs Start and goes thru 20 iterations
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>01Nov2018</datecreated>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Function FindExistingAccount
	Dim arrRecordValues, i, sAccount, sRows, strSQL

	'Start seaching from here
	sAccount = GlobalDictionary("Account")
	
	'will search up to 20 times
	For i = 0 to 20

		strSQL = "Select *  " &_
				 "From PS_GL_ACCOUNT_TBL " &_
				 "Where ACCOUNT = '" & sAccount &"' "


		Call  WriteToReport (micPass, "Query used", "" & strSQL & "", False)
		GlobalDictionary("DBsheetname") = "Account"
		If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
			FindExistingAccount = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, GlobalDictionary("DBsheetname"))
		ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
			FindExistingAccount = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, GlobalDictionary("DBsheetname"))
		Else
			FindExistingAccount = dbGetFirstRecord(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, GlobalDictionary("DBsheetname"))    
		End If
		
		'Checks to see if any results are in DataTable
		sRows = DataTable.GetSheet(GlobalDictionary("DBsheetname")).GetRowCount
		If  sRows = 0 Then	
			'If Results increments Account and deletes Datasheet
			sAccount = sAccount + 1
			sAccount = Pad(sAccount, "5", "0")
			
			DataTable.DeleteSheet(GlobalDictionary("DBsheetname"))
		Else
			Exit For
		End If

	Next
		
		'Test stops and reports to check data if empty
		If sAccount = "" Then
			WriteToReport micFail, "FindExistingAccount", "Unable to find an account that does exist within 20 from start account of ["& GlobalDictionary("Account")&"].  Try a different starting point.", True
			ExitTest		
		End If
		
		'Passes out Account found to be used later
		GlobalDictionary("Account") = sAccount
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFetchUserFromId is helper component to retreive the User that belongs to a userID
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>6-Nov-2018</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFetchUserFromId(userID)
	Dim sSQL, unit
	Dim arrRecordValues()

	unit = GlobalDictionary("BusinessUnit")
	sSQL = "SELECT OPRDEFNDESC, OPRID FROM PSOPRDEFN WHERE OPRID LIKE '" & userID & "' "
    WriteToReport micDone, "SQL query for User ID", "Query used for User ID is " & sSQL, False
    If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFetchUserFromId = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "UserID_Info_" & unit)
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       dbFetchUserFromId = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "UserID_Info_" & unit)    
    Else
        dbFetchUserFromId = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "UserID_Info_" & unit)
    End If
End Function

Public Function dbFindApprovedExpense(expReportID, expManager)
	Dim sSQL
	Dim arrRecordValues()

	sSQL = "SELECT EX_DOC_ID, OPRID, ACTION_NAME FROM PS_EX_APRVL_HIST WHERE EX_DOC_ID ='"&expReportID&"' AND OPRID = '"&expManager&"' ORDER BY SEQ_NUM DESC"
	WriteToReport micDone, "SQL query for Approved Expense", "Query used for Approved Expense is " & sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFindApprovedExpense = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ApprovedExpense")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	dbFindApprovedExpense = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ApprovedExpense")    
    Else
        dbFindApprovedExpense = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ApprovedExpense")
    End If
    '0=EX_DOC_ID
    '1=OPRID
    '2=ACTION_NAME
End Function

Public Function dbFindUserWithExpenseReport()
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_EX_TRANS A WHERE A.SHEET_ID = '' AND A.TXN_STATUS = 'U' ORDER BY EMPLID,TRANS_NBR,SEQ_NBR"
	WriteToReport micDone, "SQL query for User with Expense", "Query used is " & sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ApprovedExpense")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ApprovedExpense")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ApprovedExpense")
    End If
    dbFindUserWithExpenseReport = dbFindUserByEMPLID(arrResult(0))

End Function

Public Function dbFindUserByEMPLID(emplid)
	Dim sSQL
	Dim arrRecordValues()

	sSQL = "SELECT OPRID FROM PSOPRDEFN WHERE EMPLID = '"&emplid&"'"
	WriteToReport micDone, "SQL query for User with EMPLID ["&emplid&"]", "Query used is " & sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFindUserByEMPLID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "UserID")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	dbFindUserByEMPLID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "UserID")    
    Else
        dbFindUserByEMPLID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "UserID")
    End If
End Function

Public Function dbFindEMPLIDByOPRID(oprid)
	Dim sSQL
	Dim arrRecordValues()

	sSQL = "SELECT EMPLID FROM PSOPRDEFN WHERE OPRID = '"&oprid&"'"
	WriteToReport micDone, "SQL query for User with OPRID ["&oprid&"]", "Query used is " & sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        dbFindEMPLIDByOPRID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "UserID")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	dbFindEMPLIDByOPRID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "UserID")    
    Else
        dbFindEMPLIDByOPRID = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "UserID")
    End If
End Function

'Execute a SQL upload statement to kick off a daemon job
Public Function dbExecuteStatement(sSQL)
	Dim objConnection, connectionString, databaseName

	If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
		connectionString = PSFCONNECTIONSTRFNQA
	    databaseName = dbName_FNQA
	ElseIf StrComp(GlobalDictionary("Environment"), "FNTST") = 0 Then
      	connectionString = PSFCONNECTIONSTRFNTST
	    databaseName = dbName_FNTST
	ElseIf StrComp(GlobalDictionary("Environment"), "FNRVTST") = 0 Then
      	connectionString = PSFCONNECTIONSTRFNRVTST
	    databaseName = dbName_FNRVTST
    Else
 		connectionString = PSFCONNECTIONSTRFNREG
	    databaseName = dbName_FNREG     
	End If

  	'Set the Database connection object 
	Set objConnection= dbOpenConnection(connectionString, databaseName, dbPWDVM)

	'Verify for object exist or not
	If IsObject(objConnection) Then

		WriteToReport micPass, "DB connection", "Database connection created!", False
		'Execute the SQL and get the recordset object
		On Error Resume Next
		objConnection.CommandTimeout = 120
		objConnection.Execute(sSQL)
		WriteToReport micPass, "DB Query execution", "SQL query executed", False
	Else
		WriteToReport micFail, "DB connection", "No database connection created", False
	End If  

	'Close our connection
	objConnection.Close
End Function

Public Function dbFindHotelInWallet
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_EX_TRANS WHERE TXN_STATUS = 'U' AND EXPENSE_TYPE = 'HOTEL'"
	WriteToReport micDone, "SQL query for User with Hotel Expense", "Query used is " & sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ApprovedExpense")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ApprovedExpense")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ApprovedExpense")
    End If
    dbFindHotelInWallet = dbFindUserByEMPLID(arrResult(0))

End Function

Public Function dbFindUserWithManyExpenses
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT A.EMPLID, B.OPRID, COUNT(*) FROM PS_EX_TRANS A, PSOPRDEFN B WHERE A.TXN_STATUS = 'U' AND B.EMPLID = A.EMPLID AND B.OPRID<>'1962' GROUP BY A.EMPLID,B.OPRID ORDER BY 3 DESC"
	WriteToReport micDone, "SQL query for User with Hotel Expense", "Query used is " & sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ApprovedExpense")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ApprovedExpense")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ApprovedExpense")
    End If
    dbFindUserWithManyExpenses = arrResult(1)
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetJournalIdfrmInvoice helps to get the Journal ID with the invoice
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>28-Jan-2019</datecreated>
''' <param name="Invoice" type="string">Invoice</param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>Invoice</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetJournalIdfrmInvoice(Invoice)
	Dim strSQL, sConnectionString, sheetName, supplier_id, arrRecordValues

	strSQL = "Select JOURNAL_ID FROM PS_BI_ACCT_ENTRY WHERE GL_DISTRIB_STATUS = 'D' and ACCT_ENTRY_TYPE = 'RR' and INVOICE like '%" & Invoice & "%'"
	Call  WriteToReport (micPass, "Query for Journal ID", "" & strSQL & "", False)
	GlobalDictionary("DBsheetname") = "JournalID_" & Invoice
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    GlobalDictionary("JournalID") = dbGetSingleFieldValue(strSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "JournalID_" & Invoice)
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    GlobalDictionary("JournalID") = dbGetSingleFieldValue(strSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "JournalID_" & Invoice)
	Else
	     GlobalDictionary("JournalID") = dbGetSingleFieldValue(strSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "JournalID_" & Invoice)    
	End If

	dbGetJournalIdfrmInvoice = GlobalDictionary("JournalID")
End Function
'**************************************************************************************************************
''' <summary> 
''' get all the record and save in to given sheetname
''' </summary>
''' <author>Gunasekaran S</author>
''' <datecreated>03Jan2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>Completed</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetSpecifiRecords(strSQL, sConnectionString, sheetName)
	Dim dBRecSet, objConnection, connectionString, databaseName
	Dim intLoop, iArrayNo, nRecordCount, sOneRecord, nReportValue
	Dim sTemp, i, j, fields,k,flag

	If StrComp(GlobalDictionary("Environment"), "FNQA") = 0 Then
		connectionString = PSFCONNECTIONSTRFNQA
	    databaseName = dbName_FNQA
	ElseIf StrComp(GlobalDictionary("Environment"), "FNTST") = 0 Then
      	connectionString = PSFCONNECTIONSTRFNTST
	    databaseName = dbName_FNTST
	ElseIf StrComp(GlobalDictionary("Environment"), "FNRVTST") = 0 Then
      	connectionString = PSFCONNECTIONSTRFNRVTST
	    databaseName = dbName_FNRVTST
    Else
' 		connectionString = PSFCONNECTIONSTRFNREG'sConnectionString
 		connectionString = sConnectionString
	    databaseName = dbName_FNREG     
	End If

	
	Const adStateOpen = 1
	flag=false
	Set objConnection = CreateObject("ADODB.Connection")

	'Changing the timeout property for SQL statement execution. Highest we've seen is 1 minute 15 seconds, so using 90 as the upper end for now
	objConnection.ConnectionTimeout = 2390
	objConnection.Open  sConnectionString

	If Not objConnection.State = adStateOpen Then 
		reporter.ReportEvent micfail,"Error on opening database connection","Verify details of connection string " & sConnectionString
		Set objConnection = Nothing 
	else

		'Verify for object exist or not
		If IsObject(objConnection) Then
	
			'Execute the SQL and get the recordset object
			On Error Resume Next
			objConnection.CommandTimeout = 2390
			Set dBRecSet = objConnection.Execute(strSQL)
			DataTable.GetSheet(sheetName).SetCurrentRow(0)
			If err.number<>0 Then
				DataTable.AddSheet(sheetName)
				err.clear
			End If
			DataTable.GetSheet(sheetName).SetCurrentRow(0)
			fields = 0
	        If IsObject(dBRecSet) Then
				If dBRecSet.EOF = False Then
				    For i = 0 To dBRecSet.fields.count-1
				    	DataTable.GetSheet(sheetName).GetParameter(dBRecSet.fields(i).Name)
				    	If err.number<>0 Then
							DataTable.GetSheet(sheetName).AddParameter dBRecSet.fields(i).Name, ""
							err.clear
						End If
				    Next

					k=1
					Do While dBRecSet.EOF <> True
						DataTable.SetCurrentRow(k)
					    For j = 0 To dBRecSet.fields.count-1
					        DataTable.Value("" & dBRecSet.fields(j).Name, sheetName) = "" & dBRecSet.fields(j).Value
					    Next
					    k=k+1
					    dBRecSet.MoveNext
					Loop
					flag=true
					reporter.ReportEvent micPass, "DB records", "Returned records captured in "&sheetname
					reporter.ReportEvent micPass, "SQL query executed", "SQL query : [" & strSQL & "]"
				Else
					reporter.ReportEvent micFail, "DB records", "Returned zero records"
			    End If
			Else
			   reporter.ReportEvent micFail, "Verifying the Record from Database", "No Record Exist for SQL: [" & strSQL & "]"
			End If
		Else
			reporter.ReportEvent micFail, "DB connection", "Data base connection is failed"
		End If  
	
	
		'Clean up opened objects
	 	dBRecSet.Close
		objConnection.Close
	End If
dbGetSpecifiRecords=flag
End Function

'**************************************************************************************************************
''' <summary> 
''' dbCheckRequestApprover returns the last year projected for Depreciation
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>14-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbCheckRequestApprover(FLD_REQUEST_ID)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_FLD_REQ_APPR_VW WHERE FLD_REQUEST_ID = '"&FLD_REQUEST_ID&"' AND GL_APPR_STATUS = 'P'"
	WriteToReport micDone, "SQL Query for Chartfield Request", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Asset")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Asset")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Asset")
    End If

    If IsArrayDimmed(arrResult) Then 'The Row was returned successfully
    	dbCheckRequestApprover = arrResult
    Else
    	WriteToReport micFail, "No Row Returned for Chartfield Request: "&FLD_REQUEST_ID, "Nothing Returned", FALSE
    	ExitTest
    End If
End Function

Public Function dbGetProjectFromBUAndActivity(BusinessUnit, ActivityID, ProjectIDs)
	Dim sSQL
	dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_PROJ_RESOURCE WHERE BUSINESS_UNIT = '"&BusinessUnit&"' AND ASSET_ID = '' AND ACTIVITY_ID = '"&ActivityID&"' AND AM_DISTRIB_STATUS != 'D' AND PROJECT_ID in ("&ProjectIDs&")"
	WriteToReport micDone, "SQL query for Valid Project with Resources Corresponding to Activity ["&ActivityID&"] and Business Unit ["&BusinessUnit&"] from possible Projects ["&ProjectIDs&"]", "Query Used is: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ProjectWithResource")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ProjectWithResource")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ProjectWithResource")
    End If
    If NOT IsArray(arrResult) Then
    	WriteToReport micWarning, "No Projects with Resources of Activity ["&ActivityID&"] Found for Business Unit ["&BusinessUnit&"]", "No Data Found", FALSE
    End If
  	
  	dbGetProjectFromBUAndActivity = arrResult
End Function

Public Function dbGetCopiedAsset(AssetID)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT DESCR, DESCRSHORT, ASSET_TYPE, ASSET_STATUS, ACQUISITION_CD, PROFILE_ID from PS_ASSET_JV_VW WHERE ASSET_ID = " & AssetID
	
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "CopiedAsset")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
		arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "CopiedAsset")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "CopiedAsset")
    End If
    
    If NOT IsArray(arrResult) Then
    	WriteToReport micWarning, "No Results Returned for Asset ID ["& AssetID &"]", " Query Used [" & sSQL & "].", FALSE
    End If
  	
  	dbGetCopiedAsset = arrResult
End Function

Public Function dbFindInterfaceIDStatus(Interface_ID)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_INTFC_FIN_SUM WHERE INTFC_ID = "&Interface_ID
	WriteToReport micDone, "SQL query for Interface ID Status", "Query Used is: "&sSQL, FALSE
	
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Interface ID")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Interface ID")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Interface ID")
    End If
    If NOT IsArray(arrResult) Then
    	WriteToReport micWarning, "No Interface found with ID: "&Interface_ID, "No Data Found", FALSE
    End If

    dbFindInterfaceIDStatus = arrResult
End Function

Public Function dbGetAnyAssetID
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT ASSET_ID FROM PS_ASSET_JV_VW WHERE BUSINESS_UNIT = '"&GlobalDictionary("BusinessUnit")&"' AND ASSET_STATUS = 'I'"
	WriteToReport micDone, "SQL Query for any In Service Asset", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Asset ID")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Asset ID")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Asset ID")
    End If

    If NOT IsArray(arrResult) Then
    	WriteToReport micWarning, "No Asset ID Found", "No Data Found", FALSE
    End If

    dbGetAnyAssetID = arrResult
End Function

Public Function dbFindAMJournals(ProcessInstance)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT DISTINCT JOURNAL_ID FROM PS_DIST_LN WHERE PROCESS_INSTANCE = '"&ProcessInstance&"'"
	WriteToReport micDone, "SQL Query for AM Journals", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "AM Generated", "JOURNAL_ID")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "AM Generated", "JOURNAL_ID")    
    Else
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "AM Generated", "JOURNAL_ID")
    End If

    If NOT IsArray(arrResult) Then
    	WriteToReport micWarning, "No Asset ID Found", "No Data Found", FALSE
    End If

	dbFindAMJournals = arrResult
End Function

Public Function dbMonthEndDeprAssetsChanged
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT DISTINCT ASSET_ID, BUSINESS_UNIT FROM PS_DEPR_ALL_PD_VW WHERE DTTM_STAMP > '"&GlobalDictionary("DEPR_Time")&"'"
	WriteToReport micDone, "SQL Query for Assets Deprecated at Month's End", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "AM Generated", "ASSET_ID")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "AM Generated", "ASSET_ID")    
    Else
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "AM Generated", "ASSET_ID")
    End If

    If NOT IsArray(arrResult) Then
    	WriteToReport micWarning, "No Asset ID Found", "No Data Found", FALSE
    End If

    If GlobalDictionary.Exists("ME_AM_DEPR_Assets") Then
   		GlobalDictionary.Remove("ME_AM_DEPR_Assets")
	End If
	GlobalDictionary.Add "ME_AM_DEPR_Assets", arrResult
	WriteToReport micDone, "Month End Deprecated Assets Array stored", "array stored", FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "AM Generated", "BUSINESS_UNIT")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "AM Generated", "BUSINESS_UNIT")    
    Else
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "AM Generated", "BUSINESS_UNIT")
    End If

    If NOT IsArray(arrResult) Then
    	WriteToReport micWarning, "No Asset ID Found", "No Data Found", FALSE
    End If

    If GlobalDictionary.Exists("ME_AM_DEPR_BUs") Then
   		GlobalDictionary.Remove("ME_AM_DEPR_BUs")
	End If
	GlobalDictionary.Add "ME_AM_DEPR_BUs", arrResult
	WriteToReport micDone, "Month End Deprecated BUs Array stored", "array stored", FALSE
End Function
'**************************************************************************************************************
''' <summary> 
''' dbFindRowDeprRptTable returns TRUE only if a row is found, else it returns FALSE
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>05-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFindRowDeprRptTable(BU, ASSET_ID, BOOK, FISCAL_YEAR, ACCOUNTING_PERIOD, CATEGORY, DEPR, CURRENCY_CD)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_DEPR_RPT WHERE BUSINESS_UNIT = '"&BU&"' AND ASSET_ID = '"&ASSET_ID&"' AND BOOK = '"&BOOK&"' AND FISCAL_YEAR = '"&FISCAL_YEAR _
		   &"' AND ACCOUNTING_PERIOD = '"&ACCOUNTING_PERIOD&"' AND CATEGORY = '"&CATEGORY&"' AND DEPR LIKE '%"&DEPR&"%' AND CURRENCY_CD = '"&CURRENCY_CD&"'"
		   WriteToReport micDone, "SQL Query for Depr Rpt Table", "Query Used is: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Depr Rept Table")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Depr Rept Table")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Depr Rept Table")
    End If

    If IsArrayDimmed(arrResult) Then 'The Row was returned successfully
    	dbFindRowDeprRptTable = TRUE
    Else
    	dbFindRowDeprRptTable = FALSE
    End If

End Function
'**************************************************************************************************************
''' <summary> 
''' dbFindRowNBVTable returns TRUE only if a row is found, else it returns FALSE
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>05-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFindRowNBVTable(BU, ASSET_ID, BOOK, COST, CURRENCY_CD, ACCUM_DEPR, NBV)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_ASSET_NBV_TBL WHERE BUSINESS_UNIT = '"&BU&"' AND ASSET_ID = '"&ASSET_ID&"' AND BOOK = '"&BOOK&"' AND " _
		   &"COST LIKE '%"&COST&"%' AND CURRENCY_CD = '"&CURRENCY_CD&"' AND ACCUM_DEPR LIKE '%"&ACCUM_DEPR&"%' AND NET_BK_VALUE LIKE '%"&NBV&"%'"
	WriteToReport micDone, "SQL Query for NBV Table", "Query Used is: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "NBV Table")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "NBV Table")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "NBV Table")
    End If

    If IsArrayDimmed(arrResult) Then 'The Row was returned successfully
    	dbFindRowNBVTable = TRUE
    Else
    	dbFindRowNBVTable = FALSE
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbFindAssetProjectIDAndActivityID returns a valid asset project ID and activity ID combination.
''' </summary>
''' <author>Brian B.</author>
''' <datecreated>11-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFindAssetProjectIDAndActivityID()
	Dim sSQL, sProjectID, sActivityID
	Dim i
	Dim arrResult, arrResult2, arrResult3, arrRecordValues()
	
	sSQL ="SELECT A.BUSINESS_UNIT, A.PROJECT_ID, B.ACTIVITY_ID,  G.LOCATION, H.PROJECT_STATUS "_
		& "FROM (PS_PROJECT A LEFT OUTER JOIN  PS_PROJ_RESOURCE B ON  A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.PROJECT_ID = B.PROJECT_ID AND B.ANALYSIS_TYPE IN ('ACT','GLE','INH','EXL','INL') ), (PS_PROJECT E LEFT OUTER JOIN  PS_PROJ_LOCATION G ON  E.BUSINESS_UNIT = G.BUSINESS_UNIT  AND E.PROJECT_ID = G.PROJECT_ID AND G.EFFDT = "_
			& "(SELECT MAX(G_ED.EFFDT) FROM PS_PROJ_LOCATION G_ED "_
		& "WHERE G.BUSINESS_UNIT = G_ED.BUSINESS_UNIT "_
			& "AND G.PROJECT_ID = G_ED.PROJECT_ID "_
			& "AND G_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) "_
			& "AND G.EFFSEQ = "_
				& "(SELECT MAX(G_ES.EFFSEQ) FROM PS_PROJ_LOCATION G_ES "_
		& "WHERE G.BUSINESS_UNIT = G_ES.BUSINESS_UNIT "_
			& "AND G.PROJECT_ID = G_ES.PROJECT_ID "_
			& "AND G.EFFDT = G_ES.EFFDT) ), PS_PROJECT_STATUS H "_
		& "WHERE ( A.PROJECT_TYPE = 'CAPEX' "_
			& "AND A.BUSINESS_UNIT = E.BUSINESS_UNIT "_
			& "AND A.PROJECT_ID = E.PROJECT_ID "_
			& "AND E.BUSINESS_UNIT = H.BUSINESS_UNIT "_
			& "AND E.PROJECT_ID = H.PROJECT_ID "_
			& "AND H.EFFDT = "_
				& "(SELECT MAX(H_ED.EFFDT) FROM PS_PROJECT_STATUS H_ED "_
		& "WHERE H.BUSINESS_UNIT = H_ED.BUSINESS_UNIT "_
			& "AND H.PROJECT_ID = H_ED.PROJECT_ID "_
			& "AND H .PROJECT_STATUS = 'A'"_
			& "AND H_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) "_
			& "AND H.EFFSEQ = "_
				& "(SELECT MAX(H_ES.EFFSEQ) FROM PS_PROJECT_STATUS H_ES "_
		& "WHERE H.BUSINESS_UNIT = H_ES.BUSINESS_UNIT "_
			& "AND H.PROJECT_ID = H_ES.PROJECT_ID "_
			& "AND H .PROJECT_STATUS = 'A'"_
			& "AND H.EFFDT = H_ES.EFFDT) "_
			& "AND A.PROJECT_ID NOT IN('999999','CAPITAL_LEASE','CAPEX','999')"_
			& "AND B.ACTIVITY_ID  IN ('EXT_LABOR', 'INT_LABOR','COMP_HARDWARE','COMP_SOFTWARE','FURNITURE','MACH_EQUIP','BUILD_IMP','OFFICE_EQUIP','LEASE_IMP'))"_
			& "GROUP BY  A.BUSINESS_UNIT,  A.PROJECT_ID, B.ACTIVITY_ID,  G.LOCATION,  H.PROJECT_STATUS "_
		& "UNION "_
		& "SELECT C.BUSINESS_UNIT, C.PROJECT_ID, D.ACTIVITY_ID, F.LOCATION, I.PROJECT_STATUS "_
		& "FROM ((PS_PROJECT C LEFT OUTER JOIN  PS_PROJ_RESOURCE D ON  C.BUSINESS_UNIT = D.BUSINESS_UNIT AND C.PROJECT_ID = D.PROJECT_ID AND D.ANALYSIS_TYPE IN ('ACT','GLE','INH','INL','EXL') ) LEFT OUTER JOIN  PS_PROJ_LOCATION F ON  D.BUSINESS_UNIT = F.BUSINESS_UNIT AND D.PROJECT_ID = F.PROJECT_ID AND F.EFFDT = "_
			& "(SELECT MAX(F_ED.EFFDT) FROM PS_PROJ_LOCATION F_ED "_
		& "WHERE F.BUSINESS_UNIT = F_ED.BUSINESS_UNIT "_
			& "AND F.PROJECT_ID = F_ED.PROJECT_ID "_
			& "AND F_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) "_
			& "AND F.EFFSEQ = "_
				& "(SELECT MAX(F_ES.EFFSEQ) FROM PS_PROJ_LOCATION F_ES "_
		& "WHERE F.BUSINESS_UNIT = F_ES.BUSINESS_UNIT "_
			& "AND F.PROJECT_ID = F_ES.PROJECT_ID "_
			& "AND F.EFFDT = F_ES.EFFDT) ), PS_PROJECT_STATUS I "_
		& "WHERE ( C.BUSINESS_UNIT = I.BUSINESS_UNIT "_
			& "AND C.PROJECT_ID = I.PROJECT_ID "_
			& "AND I.EFFDT = "_
				& "(SELECT MAX(I_ED.EFFDT) FROM PS_PROJECT_STATUS I_ED "_
		& "WHERE I.BUSINESS_UNIT = I_ED.BUSINESS_UNIT "_
			& "AND I.PROJECT_ID = I_ED.PROJECT_ID "_
			& "AND I.PROJECT_STATUS = 'A'"_
			& "AND I_ED.EFFDT <= SUBSTRING(CONVERT(CHAR,GETDATE(),121), 1, 10)) "_
			& "AND I.EFFSEQ = "_
				& "(SELECT MAX(I_ES.EFFSEQ) FROM PS_PROJECT_STATUS I_ES "_
		& "WHERE I.BUSINESS_UNIT = I_ES.BUSINESS_UNIT "_
			& "AND I.PROJECT_ID = I_ES.PROJECT_ID "_
			& "AND I.PROJECT_STATUS = 'A' "_
			& "AND I.EFFDT = I_ES.EFFDT) "_
			& "AND C.PROJECT_TYPE = 'CAPEX' "_
			& "and C.PROJECT_ID NOT IN('999999','CAPITAL_LEASE','CAPEX','999') "_
			& "AND D.ACTIVITY_ID  IN ('EXT_LABOR', 'INT_LABOR','COMP_HARDWARE','COMP_SOFTWARE','FURNITURE','MACH_EQUIP','BUILD_IMP','OFFICE_EQUIP','LEASE_IMP')"_
			& ") "_
		& "GROUP BY  C.BUSINESS_UNIT,  C.PROJECT_ID,  D.ACTIVITY_ID, F.LOCATION,  I.PROJECT_STATUS "_
		& "Order by 1,2 desc"_

	WriteToReport micDone, "SQL Query for Finding Project IDs and Activity IDs", "Query used is [" & sSQL & "].", FALSE
			
	' Grab Project ID's and Activity ID's.	
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Projects", "PROJECT_ID")     
		arrResult2 = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Projects", "ACTIVITY_ID") 
	ElseIf StrComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
		arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Projects", "PROJECT_ID")     
		arrResult2 = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Projects", "ACTIVITY_ID") 		
	Else
		arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Projects", "PROJECT_ID")     
		arrResult2 = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Projects", "ACTIVITY_ID") 
	End If
	
	' Keep using Project ID's in query until ONLY one row is returned and has "N" in it.
	For i = 1 To UBound(arrResult2)
		If NOT(UCase(arrResult2(i)) = "TOTAL COST") Then
			arrResult3 = dbAMDistributeStatus(Trim(arrResult(i)))
			
			If NOT(UBound(arrResult3) > 1) Then
				If arrResult3(1) = "N" Then
					sProjectID = Trim(arrResult(i))
					sActivityID = Trim(arrResult2(i))
					WriteToReport micInfo, "Project ID [" & sProjectID & "] and Activity ID [" & sActivityID & "] Found", "Exiting Loop.", False
					Exit For
				End If
			End If
		End If
		
		If i = UBound(arrResult2) Then
			WriteToReport micFail, "Suitable Project and Activity ID's Were Not Found", "Exiting Test.", FALSE
			ExitTest
		End If
	Next
	
	dbFindAssetProjectIDAndActivityID = Array(sProjectID, sActivityID)
	
	' Cleanup
	If isArray(arrResult) Then Erase arrResult
	If isArray(arrResult2) Then Erase arrResult2
	If isArray(arrResult3) Then Erase arrResult3
	If isArray(arrRecordValues) Then Erase arrRecordValues
End Function

'**************************************************************************************************************
''' <summary> 
''' dbAMDistributeStatus returns the AM Distribute status of a profile ID.
''' </summary>
''' <author>Brian B.</author>
''' <datecreated>11-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbAMDistributeStatus(sProfileID)
	Dim sSQL
	Dim arrResult, arrRecordValues()
	
	sSQL = "SELECT DISTINCT AM_DISTRIB_STATUS FROM PS_PROJ_RESOURCE WHERE PROJECT_ID = '" & sProfileID & "'"
	WriteToReport micDone, "SQL Query for AM Distribute Status", "Query used is [" & sSQL & "].", FALSE
	
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
		arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Projects", "AM_DISTRIB_STATUS")     
	ElseIf StrComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
		arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Projects", "AM_DISTRIB_STATUS")     		
	Else
		arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Projects", "AM_DISTRIB_STATUS")     
	End If
	
	dbAMDistributeStatus = arrResult
	
	' Cleanup
	If isArray(arrResult) Then Erase arrResult
	If isArray(arrRecordValues) Then Erase arrRecordValues
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetAssetStatus returns The Status of the Asset if the Asset Exists
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>14-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetAssetStatus(ASSET_ID)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT ASSET_STATUS FROM PS_ASSET_JV_VW WHERE ASSET_ID = '"&ASSET_ID&"'"
	WriteToReport micDone, "SQL Query for Asset Status", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Asset")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Asset")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Asset")
    End If

    If IsArrayDimmed(arrResult) Then 'The Row was returned successfully
    	dbGetAssetStatus = arrResult
    Else
    	WriteToReport micFail, "No Row Returned for Asset: "&ASSET_ID, "Nothing Returned", FALSE
    	ExitTest
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbCheckNBVTableRunID returns TRUE only if a row is found, else it returns FALSE
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>14-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbCheckNBVTableRunID(RUN_ID)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_ASSET_NBV_TBL WHERE RUN_ID = '"&RUN_ID&"'"
	WriteToReport micDone, "SQL Query for NBV Table", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Asset")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Asset")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Asset")
    End If

    If IsArrayDimmed(arrResult) Then 'The Row was returned successfully
    	dbCheckNBVTableRunID = TRUE
    Else
    	dbCheckNBVTableRunID = FALSE
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetLastDeprYear returns the last year projected for Depreciation
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>14-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetLastDeprYear(BOOK, ASSET_ID, BUSINESS_UNIT)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_DEPR_YEAR_VW WHERE ASSET_ID = '"&ASSET_ID&"' AND BOOK = '"&BOOK&"' AND BUSINESS_UNIT = '"&BUSINESS_UNIT&"' ORDER BY FISCAL_YEAR DESC"
	WriteToReport micDone, "SQL Query for Depreciation Years", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Asset")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Asset")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Asset")
    End If

    If IsArrayDimmed(arrResult) Then 'The Row was returned successfully
    	dbGetLastDeprYear = arrResult(3) 'The FISCAL_YEAR column is index 3
    Else
    	WriteToReport micFail, "No Row Returned for Asset: "&ASSET_ID, "Nothing Returned", FALSE
    	ExitTest
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' dbInvoiceReprint is helper component to retrieve an Invoice to be reprinted
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>12Feb2019</datecreated>
''' <param name="BU" type="string">Business unit</param>
''' <param name="InvForm" type="string">Invoice Form ID determines type of Invoice</param>
''' <param name="arrRecordValues" type="array">output parameter for array of records</param>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbInvoiceReprint(BU,InvForm, BillSource)
    Dim sSQL
    Dim arrRecordValues()    

	sSQL ="SELECT A.BUSINESS_UNIT, A.BILL_TO_CUST_ID, A.INVOICE, A.INVOICE_DT, A.BILL_STATUS, A.BI_CURRENCY_CD, A.DUE_DT, A.INVOICE_AMOUNT, BILL_SOURCE_ID,  A.* " &_
	"FROM PS_BI_HDR A, PS_ITEM B " &_
	"WHERE A.BUSINESS_UNIT IN ('" & BU & "') AND A.BILL_STATUS = 'INV' AND A.ADJUSTED_FLAG = 'N' AND A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.INVOICE = B.ITEM " &_ 
	"AND B.BAL_AMT <> 0 AND PRIOR_ADJ_INVOICE = '' AND NEXT_ADJ_INVOICE = '' AND INVOICE_FORM_ID = '"&InvForm &"' AND A.INVOICE_AMOUNT > 0 AND B.ITEM_STATUS = 'O' " 
	If BillSource <> "" Then
	sSQL = sSQL & "AND BILL_SOURCE_ID = '" & BillSource &"' "

	End If
	
	WriteToReport micDone, "SQL query for Customer", "Query used for customer info is " & sSQL, False

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    dbInvoiceReprint = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "invoice_data")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	    dbInvoiceReprint = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "invoice_data")
	Else
	    dbInvoiceReprint = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "invoice_data")
	End If
End Function

'**************************************************************************************************************
''' <summary> 
''' dbGetActivityFromProjects finds an Activity for project resources that have not been distributed and assigned to an Asset
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>21-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'01April2019		Eric Trout	Added OFFICE_EQUIP into Not in Activity ID
'**************************************************************************************************************
Public Function dbGetActivityFromProjects(BusinessUnit, ProjectIDs)
	Dim sSQL
	dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_PROJ_RESOURCE WHERE BUSINESS_UNIT = '"&BusinessUnit&"' AND ASSET_ID = '' AND AM_DISTRIB_STATUS != 'D' AND PROJECT_ID in ("&ProjectIDs&") AND ACTIVITY_ID NOT IN ('OFFICE_EQUIP','NON_CAP_EXPENSE','PROJ_SUPPORT','BUILDINGS')"
	WriteToReport micDone, "SQL query for Activity with Resources Not Assigned to Asset with Business Unit ["&BusinessUnit&"] from possible Projects ["&ProjectIDs&"]", "Query Used is: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Unassigned Activity")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Unassigned Activity")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Unassigned Activity")
    End If
    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Activities for Projects In ["&ProjectIDs&"] Found for Business Unit ["&BusinessUnit&"]", "No Data Found", FALSE
    	ExitTest
    End If
  	
  	dbGetActivityFromProjects = arrResult
End Function

'**************************************************************************************************************
''' <summary> 
''' dbExpApprover returns the Approver that has the WorksheetID in their Worklist
''' </summary>
''' <author>Eric Trout</author>
''' <datecreated>19-Mar-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbExpApprover(Worksheet_ID)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_EX_ER_MGRLST_VW WHERE SHEET_ID = '"&Worksheet_ID&"'"
	WriteToReport micDone, "SQL Query for Expense Approver", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Expense_Approver")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Expense_Approver")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Expense_Approver")
    End If

	dbExpApprover= arrResult

End Function

'**************************************************************************************************************
''' <summary> 
''' Returns the OPRID of the Portfolio Manager assigned to the given Lease
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>26-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetLeasePortfolioMgrID(LS_NBR)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT PRTFL_MGR_OPRID FROM PS_RE_LS_SRCH WHERE LS_NBR = '"&LS_NBR&"'"
	WriteToReport micDone, "SQL query for OPRID for Lease Number: "&LS_NBR, "Query Used: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Portfolio Manager")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Portfolio Manager")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Portfolio Manager")
    End If

    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Activities for Projects In ["&ProjectIDs&"] Found for Business Unit ["&BusinessUnit&"]", "No Data Found", FALSE
    	ExitTest
    End If
  	
  	dbGetLeasePortfolioMgrID = arrResult(0)
End Function
'**************************************************************************************************************
''' <summary> 
''' Returns the Total Payment Value for a Lease
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>26-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetLeasePaymentTotal(LS_NBR)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT MLP FROM PS_RE_LS WHERE LS_KEY = (SELECT LS_KEY FROM PS_RE_AM_LS_VW WHERE LS_NBR = '"&LS_NBR&"')"
	WriteToReport micDone, "SQL query for Lease Payment Total for Lease Number: "&LS_NBR, "Query Used: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Portfolio Manager")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Portfolio Manager")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Portfolio Manager")
    End If

    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Activities for Projects In ["&ProjectIDs&"] Found for Business Unit ["&BusinessUnit&"]", "No Data Found", FALSE
    	ExitTest
    End If
  	
  	dbGetLeasePaymentTotal = arrResult(0)
End Function
'**************************************************************************************************************
''' <summary> 
''' Finds Lease Journals
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>27-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFindLeaseJournals(PROCESS_INSTANCE)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT DISTINCT JOURNAL_ID FROM PS_FUS_JRNL_LN WHERE PROCESS_INSTANCE = '"&PROCESS_INSTANCE&"'"
	WriteToReport micDone, "SQL Query for LS Journals", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "LS Generated", "JOURNAL_ID")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "LS Generated", "JOURNAL_ID")    
    Else
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "LS Generated", "JOURNAL_ID")
    End If

    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micWarning, "No Journal ID(s) Found", "No Data Found", FALSE
    End If

	dbFindLeaseJournals = arrResult
End Function
'**************************************************************************************************************
''' <summary> 
''' Gets Lease Journal Status
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>27-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetLeaseJournalStatus(JOURNAL_ID)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_JRNL_HDR_IU_VW WHERE JOURNAL_ID = '"&JOURNAL_ID&"'"
	WriteToReport micDone, "SQL Query for LS Journal "&JOURNAL_ID, "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Journal Status")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Journal Status")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Journal Status")
    End If

     If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micWarning, "No Date Found for Given Journal: "&JOURNAL_ID, "No Data Found", FALSE
    End If

    dbGetLeaseJournalStatus = arrResult
End Function
'**************************************************************************************************************
''' <summary> 
''' Gets Description of BU for Leasing/REM
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>27-Feb-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbLeaseBUDesc
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT DESCR FROM PS_RE_BU_SRCH_VW WHERE BUSINESS_UNIT = '"&GlobalDictionary("BusinessUnit")&"'"
	WriteToReport micDone, "SQL Query for BU Description "&GlobalDictionary("BusinessUnit"), "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Journal Status")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Journal Status")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Journal Status")
    End If

     If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micWarning, "No Date Found for Given Journal: "&JOURNAL_ID, "No Data Found", FALSE
    End If

    dbLeaseBUDesc = arrResult
End Function
'**************************************************************************************************************
''' <summary> 
''' dbFetchDepositInformation returns the Deposit Information.
''' </summary>
''' <author>Brian B.</author>
''' <datecreated>07-Mar-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'03/22/2019			Stephen King	Added code to pull multiple rows without returning a 2d array so we don't have to modify any existing code using this function
'**************************************************************************************************************
Public Function dbFetchDepositInformation(nRowsToRequest, sBUnit)
	Dim sSQL
	Dim arrResult, arrRecordValues()
	Dim strJoin1, strJoin2

	sSQL = "SELECT TOP " & nRowsToRequest & " Q.BUSINESS_UNIT, Q.CUST_ID, Q.ITEM, Q.ITEM_LINE, Q.ITEM_STATUS, Q.ITEM_SEQ_NUM, Q.ACCOUNTING_DT, Q.BAL_AMT, R.INVOICE " &_
		"FROM PS_ITEM Q , PS_BI_HDR R " &_
		"WHERE Q.BAL_AMT > 0 AND Q.CUST_ID = R.BILL_TO_CUST_ID AND R.INVOICE = Q.INVOICE AND Q.ITEM_STATUS = 'O' AND Q.BAL_AMT > '2500' AND Q.BAL_AMT < '5000' AND Q.BUSINESS_UNIT = '" & sBUnit & "' AND Q.BUSINESS_UNIT = R.BUSINESS_UNIT AND R.INVOICE NOT IN ( SELECT S.INVOICE FROM PS_PAYMENT_ITEM S) " &_
			"AND Q.ITEM NOT IN ( (SELECT B.ITEM FROM PS_WS_CONTROL A, PS_WS_ITEM B, PS_SET_CNTRL_REC C, PS_CUSTOMER D WHERE A.WS_BU = B.WS_BU AND A.WS_ID = B.WS_ID AND C.SETCNTRLVALUE = B.BUSINESS_UNIT AND C.RECNAME = 'CUSTOMER' AND D.SETID = C.SETID AND D.CUST_ID = B.CUST_ID AND B.ITEM_SELECTED = 'Y' " &_
			"AND A.BUSINESS_UNIT = Q.BUSINESS_UNIT AND B.ITEM = Q.ITEM)) AND Q.ITEM NOT IN (SELECT F.ITEM FROM PS_TRN_CONTROL E, PS_TRN_ITEM F, PS_SET_CNTRL_REC G, PS_CUSTOMER H WHERE E.TRN_BU = F.TRN_BU AND E.TRN_ID = F.TRN_ID AND F.ITEM_SELECTED = 'Y' AND G.SETCNTRLVALUE = F.BUSINESS_UNIT " &_
			"AND G.RECNAME = 'CUSTOMER' AND H.SETID = G.SETID AND H.CUST_ID = F.CUST_ID AND F.ITEM = Q.ITEM AND F.BUSINESS_UNIT = Q.BUSINESS_UNIT) AND Q.ITEM NOT IN (SELECT J.ITEM FROM PS_DEPOSIT_CONTROL I, PS_PAYMENT_ITEM J, PS_SET_CNTRL_REC K, PS_CUSTOMER L WHERE ( I.DEPOSIT_BU = J.DEPOSIT_BU " &_
			"AND I.DEPOSIT_ID = J.DEPOSIT_ID AND J.ITEM_SELECTED = 'Y' AND K.SETCNTRLVALUE = J.BUSINESS_UNIT AND K.RECNAME = 'CUSTOMER'AND L.SETID = K.SETID AND L.CUST_ID = J.CUST_ID AND J.BUSINESS_UNIT = Q.BUSINESS_UNIT AND J.ITEM = Q.ITEM)) " &_
			"AND Q.ITEM NOT IN (SELECT N.ITEM FROM PS_GROUP_CONTROL M, PS_PENDING_ITEM N, PS_SET_CNTRL_REC O, PS_CUSTOMER P WHERE ( M.GROUP_BU = N.GROUP_BU AND M.GROUP_ID = N.GROUP_ID AND O.SETCNTRLVALUE = N.BUSINESS_UNIT AND O.RECNAME = 'CUSTOMER' AND P.SETID = O.SETID AND P.CUST_ID = N.CUST_ID " &_
			"AND N.BUSINESS_UNIT = Q.BUSINESS_UNIT AND N.ITEM = Q.ITEM AND N.POST_DT IS NULL))"
	WriteToReport micDone, "SQL Query for Deposit Information", "Query used is [" & sSQL & "].", FALSE
	
	If nRowsToRequest = 1 Then
		If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
			arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Deposit Information")
	'		arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Projects", "AM_DISTRIB_STATUS")     
		ElseIf StrComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
			arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Deposit Information")
	'		arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Projects", "AM_DISTRIB_STATUS")     		
		Else
			arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Deposit Information")
	'		arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Projects", "AM_DISTRIB_STATUS")     
		End If
	Else
		If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
			arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Deposit Information")
			strJoin1 = Join(arrResult, ";")
			arrResult = dbGetRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Deposit Information")
		ElseIf StrComp (GlobalDictionary("Environment"), "FNTST") = 0 Then
			arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Deposit Information")
			strJoin1 = Join(arrResult, ";")
			arrResult = dbGetRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Deposit Information")
		Else
			arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Deposit Information")
			strJoin1 = Join(arrResult, ";")
			arrResult = dbGetRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Deposit Information")
		End If

		'Turn our 2nd row results into a string
		strJoin2 = Join(arrResult, ";")

		'Combine into our new results array
		arrResult = Split(strJoin1 & ";" & strJoin2, ";")
	End If

	dbFetchDepositInformation = arrResult
	
	' Cleanup
	If isArray(arrResult) Then Erase arrResult
	If isArray(arrRecordValues) Then Erase arrRecordValues
End Function

'**************************************************************************************************************
''' <summary> 
''' Gets a Customer and Item conbo for an open Item in AR
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>06-Mar-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetCustAndItem
	Dim sSQL
	dim arrRecordValues(), arrResult

	sSQL = 	"SELECT TOP 1 A.ITEM, A.CUST_ID FROM (PS_ITEM A LEFT OUTER JOIN PS_CUST_PND_MNT_VW B ON A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.ITEM = B.ITEM),"_
		& " (PS_ITEM E LEFT OUTER JOIN PS_PAYMENT_ID_ITEM F ON E.BUSINESS_UNIT = F.DEPOSIT_BU AND E.ITEM = F.ITEM),"_
		& " (PS_ITEM G LEFT OUTER JOIN PS_WS_ITEM H ON G.BUSINESS_UNIT = H.BUSINESS_UNIT AND G.ITEM = H.ITEM),"_
		& " (PS_ITEM I LEFT OUTER JOIN PS_PAYMENT_ITEM J ON I.BUSINESS_UNIT = J.BUSINESS_UNIT AND I.ITEM = J.ITEM)"_
		& " WHERE A.ITEM_STATUS = 'O' AND A.REF_REASON = '' AND A.ENTRY_TYPE = 'IN' AND A.BUSINESS_UNIT IN ('"&GlobalDictionary("BusinessUnit")&"')"_
		& " AND B.ITEM IS NULL AND F.ITEM IS NULL AND H.ITEM IS NULL AND J.ITEM IS NULL"_
		& " AND A.ITEM = E.ITEM AND A.ITEM = G.ITEM AND A.ITEM = I.ITEM"

	WriteToReport micDone, "SQL query for Customer with Item with Status Open in Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "Query Used is: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer and Item")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer and Item")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer and Item")
    End If
    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Open Items Found for Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "No Data Found", FALSE
    	ExitTest
    Else
    	WriteToReport micDone, "Retrieved a Customer/Item Combo", "", FALSE
    End If
  	
  	dbGetCustAndItem = arrResult
End Function

'**************************************************************************************************************
''' <summary> 
''' Gets a Customer from the Business Unit that is not the one passed in
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>06-Mar-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetCustFromBU(ORIG_CUST_ID)
	Dim sSQL
	dim arrRecordValues(), arrResult

	sSQL = "SELECT TOP 1 CUST_ID FROM PS_AR_CUST_VW WHERE BUSINESS_UNIT = '"&GlobalDictionary("BusinessUnit")&"' AND CUST_ID NOT IN ('"&ORIG_CUST_ID&"')"
	WriteToReport micDone, "SQL query for Customer in Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "Query Used is: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer")
    End If
    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Customers Found for Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "No Data Found", FALSE
    	ExitTest
    Else
    	WriteToReport micDone, "Retrieved a Customer", "", FALSE
    End If 
  	
  	dbGetCustFromBU = arrResult
End Function

'**************************************************************************************************************
''' <summary> 
''' Gets a Customer that has Item Credit/Debit that are of opposite value ie Credit = -1*Debit
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>07-Mar-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'27MAR19			Zach Apple  Update query to be more specific, try to find items where neither A or B are open on another worksheet
'**************************************************************************************************************
Public Function dbGetOffsetCreditDebit
	Dim sSQL
	dim arrRecordValues(), arrResult

	sSQL = "SELECT TOP 1 * FROM "_
	&		" (PS_ITEM A LEFT OUTER JOIN PS_CUST_PND_MNT_VW Z ON A.BUSINESS_UNIT = Z.BUSINESS_UNIT AND A.ITEM = Z.ITEM),"_
	&		" (PS_ITEM E LEFT OUTER JOIN PS_PAYMENT_ID_ITEM F ON E.BUSINESS_UNIT = F.DEPOSIT_BU AND E.ITEM = F.ITEM),"_
	&		" (PS_ITEM G LEFT OUTER JOIN PS_WS_ITEM H ON G.BUSINESS_UNIT = H.BUSINESS_UNIT AND G.ITEM = H.ITEM),"_
	&		" (PS_ITEM I LEFT OUTER JOIN PS_PAYMENT_ITEM J ON I.BUSINESS_UNIT = J.BUSINESS_UNIT AND I.ITEM = J.ITEM)"_
	&	" WHERE A.ITEM_STATUS = 'O' "_
	&		" AND A.BUSINESS_UNIT IN ('00001') "_
	&		" AND Z.ITEM IS NULL AND F.ITEM IS NULL AND H.ITEM IS NULL AND J.ITEM IS NULL"_
	&		" AND A.ITEM = E.ITEM AND A.ITEM = G.ITEM AND A.ITEM = I.ITEM"_
	&	" AND EXISTS "_
	&		" (SELECT 'X' FROM "_
	&			" (PS_ITEM B LEFT OUTER JOIN PS_CUST_PND_MNT_VW Y ON B.BUSINESS_UNIT = Y.BUSINESS_UNIT AND B.ITEM = Y.ITEM),"_
	&			" (PS_ITEM J LEFT OUTER JOIN PS_PAYMENT_ID_ITEM K ON J.BUSINESS_UNIT = K.DEPOSIT_BU AND J.ITEM = K.ITEM),"_
	&			" (PS_ITEM L LEFT OUTER JOIN PS_WS_ITEM M ON L.BUSINESS_UNIT = M.BUSINESS_UNIT AND L.ITEM = M.ITEM),"_
	&			" (PS_ITEM N LEFT OUTER JOIN PS_PAYMENT_ITEM O ON N.BUSINESS_UNIT = O.BUSINESS_UNIT AND N.ITEM = O.ITEM)"_
	&		" WHERE "_
	&			" Y.ITEM IS NULL AND K.ITEM IS NULL AND M.ITEM IS NULL AND O.ITEM IS NULL"_
	&			" AND B.ITEM = J.ITEM AND B.ITEM = L.ITEM AND B.ITEM = N.ITEM "_
	&			" AND A.BUSINESS_UNIT = B.BUSINESS_UNIT "_
	&			" AND A.CUST_ID = B.CUST_ID "_
	&			" AND B.ITEM_STATUS = 'O' "_
	&			" AND A.BAL_AMT = (B.BAL_AMT * -1)"_
	&		" ) "_
	&" ORDER BY A.CUST_ID, ABS(A.BAL_AMT)"

	WriteToReport micDone, "SQL query for Customer With Offset Credit/Debit in Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "Query Used is: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer")
    End If
    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Customers Found for Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "No Data Found", FALSE
    	ExitTest
    Else
    	WriteToReport micDone, "Retrieved a Customer", "", FALSE
    End If 
  	
  	dbGetOffsetCreditDebit = arrResult
End Function

'**************************************************************************************************************
''' <summary> 
''' Finds an Open Item that is not currently on any* other worksheet (*there may be more worksheets other than those below)
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>07-Mar-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'5/15/2019			Zach A. 	Updated query by changing the order of the last two rows below
'**************************************************************************************************************
Public Function dbGetItems(COUNT)
	Dim sSQL, sItems, i, upperBound, sCusts
	Dim arrRecordValues(), arrResult, arrReturn()
	ReDim arrReturn(2)
	sItems = "''"
	sCusts = "''"

	For i=0 To COUNT-1
		sSQL = "SELECT TOP 1 * FROM (PS_ITEM A LEFT OUTER JOIN PS_CUST_PND_MNT_VW B ON A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.ITEM = B.ITEM),"_
		& " (PS_ITEM E LEFT OUTER JOIN PS_PAYMENT_ID_ITEM F ON E.BUSINESS_UNIT = F.DEPOSIT_BU AND E.ITEM = F.ITEM),"_
		& " (PS_ITEM G LEFT OUTER JOIN PS_WS_ITEM H ON G.BUSINESS_UNIT = H.BUSINESS_UNIT AND G.ITEM = H.ITEM),"_
		& " (PS_ITEM I LEFT OUTER JOIN PS_PAYMENT_ITEM J ON I.BUSINESS_UNIT = J.BUSINESS_UNIT AND I.ITEM = J.ITEM)"_
		& " WHERE A.ITEM_STATUS = 'O' AND A.REF_REASON = '' AND A.ENTRY_TYPE = 'IN' AND A.BUSINESS_UNIT IN ('"&GlobalDictionary("BusinessUnit")&"')"_
		& " AND A.ITEM NOT IN ("&sItems&") AND A.CUST_ID NOT IN ("&sCusts&")"_
		& " AND A.ITEM = E.ITEM AND A.ITEM = G.ITEM AND A.ITEM = I.ITEM"_
		& " AND B.ITEM IS NULL AND F.ITEM IS NULL AND H.ITEM IS NULL AND J.ITEM IS NULL"

		WriteToReport micDone, "SQL query for Item in Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "Query Used is: "&sSQL, FALSE
		If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Item")
	    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
	       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Item") 
	    Else
	        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Item")
	    End If
	    If NOT IsArrayDimmed(arrResult) Then
	    	WriteToReport micFail, "No Customers Found for Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "No Data Found", FALSE
	    	ExitTest
	    Else
	    	WriteToReport micDone, "Retrieved an Item", "", FALSE
	    End If 
	  	upperBound = 2 + (i * 3)
	  	ReDim Preserve arrReturn(upperBound)
	  	arrReturn(0 + (i * 3)) = arrResult(1) 'Customer
	  	arrReturn(1 + (i * 3)) = Trim(arrResult(2)) 'Item ID
	  	arrReturn(2 + (i * 3)) = arrResult(9) 'Balance Amount

	  	sItems = sItems & ",'"&Trim(arrResult(2))&"'"
	  	sCusts = sCusts & ",'"&Trim(arrResult(1))&"'"
	Next
	GlobalDictionary.Add "Items", Split(sItems,"'',")(1)
  	dbGetItems = arrReturn
End Function
'**************************************************************************************************************
''' <summary> 
''' Gets the payment activity for an item 
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>07-Mar-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbCheckItemPayment(ITEM_ID, DEPOSIT_ID)
	Dim sSQL
	dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_ITEM_ACTIVITY WHERE (ITEM = "&ITEM_ID&" OR DOCUMENT = "&ITEM_ID&") AND DEPOSIT_ID = '"&DEPOSIT_ID&"'" 'The passed in Item already has '' around the value
	WriteToReport micDone, "SQL query for Item With Payment with Deposit ID ["&DEPOSIT_ID&"]", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer")
    End If
    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Items Found For Deposit ID ["&DEPOSIT_ID&"]", "No Data Found", FALSE
    	ExitTest
    Else
    	WriteToReport micDone, "Found Item", "", FALSE
    End If 
  	
  	dbCheckItemPayment = arrResult
End Function
'**************************************************************************************************************
''' <summary> 
''' Checks for Cashflow entry
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>28-Mar-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbCheckCashflowEntry(DEAL_ID, BUSINESS_DATE, AMOUNT)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_CASH_FLOW_TR WHERE SOURCE_BUS_UNIT = '"&GlobalDictionary("BusinessUnit")_
	& "' AND TR_SOURCE_ID = '"&DEAL_ID&"' AND BUSINESS_DATE = '"&SQLAnyDateLeadingZeros(BUSINESS_DATE)_
	& "' AND AMOUNT LIKE '%"&Replace(AMOUNT, ",", "")&"%'"

	WriteToReport micDone, "SQL Query for Entry in Cashflows Table", "Query used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer")
    End If

    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Entry Found For Deal ID ["&DEAL_ID&"]", "No Data Found, check query", FALSE
    	dbCheckCashflowEntry = FALSE
    Else
    	dbCheckCashflowEntry = TRUE
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' Checks for Cashflow entry
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>28-Mar-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbCheckEstIntAccr(TABLE, TRX_YEAR_NUM, TRX_PERIOD_NUM, FROM_DATE, TO_DATE, TR_SOURCE_ID, ACCRUED_INT)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM "&TABLE&" WHERE TRX_YEAR_NUM = '"&TRX_YEAR_NUM&"' AND TRX_PERIOD_NUM = '"&TRX_PERIOD_NUM&"' AND"_
	& " FROM_DATE = '"&FROM_DATE&"' AND TO_DATE = '"&TO_DATE&"' AND TR_SOURCE_ID = '"&TR_SOURCE_ID&"' AND ACCRUED_INT BETWEEN "&ACCRUED_INT - 0.01&" AND "&ACCRUED_INT + 0.01

	WriteToReport micDone, "SQL Query for Estimated Interest Accrual in Table ["&TABLE&"]", "Query used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer")
    End If

     If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Accrual Found", "No Data Found, check query", FALSE
    	dbCheckEstIntAccr = FALSE
    Else
    	dbCheckEstIntAccr = TRUE
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' Checks for Accounting Entry
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>01-Apr-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbCheckAcctgEntry(EVENT_DT, EVENT_ID, TR_SOURCE_CD, REPYMNT_CHECK)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_TRA_EVENT_CAL WHERE EVENT_DT = '"&EVENT_DT&"' AND TR_SOURCE_CD = '"&TR_SOURCE_CD&"' AND BUSINESS_UNIT = '"&GlobalDictionary("BusinessUnit")&"' AND EVENT_ID = '"&EVENT_ID&"'"
	If REPYMNT_CHECK Then
		sSQL = sSQL & " AND ACCTG_TMPL_ID = 'TERM REPYMNT'"
	End If

	WriteToReport micDone, "SQL Query for Accounting Entry", "Query used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Customer")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Customer") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Customer")
    End If

     If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Entry Found", "No Data Found, check query", FALSE
    	dbCheckAcctgEntry = FALSE
    Else
		dbCheckAcctgEntry = TRUE
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' Checks for Accounting Summary
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>01-Apr-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbCheckAcctgSumm(ACCOUNTING_DT, TRA_SOURCE_CD, MONETARY_AMOUNT, EVENT_ID, REPYMNT_CHECK)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_TRA_ENT_SUM_VW WHERE ACCOUNTING_DT = '"&ACCOUNTING_DT&"' AND BUSINESS_UNIT = '"&GlobalDictionary("BusinessUnit")_
		&"' AND MONETARY_AMOUNT = '"&MONETARY_AMOUNT&"' AND EVENT_ID = '"&EVENT_ID&"'"

	If TRA_SOURCE_CD <> "" Then
		sSQL = sSQL &" AND TRA_SOURCE_CD = '"&TRA_SOURCE_CD&"'"
	End If

	If REPYMNT_CHECK Then
		sSQL = sSQL & " AND ACCTG_EVENT_TYPE = '21'"
	End If

	WriteToReport micDone, "SQL Query for Accounting Entry", "Query used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "AcctgSumm")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "AcctgSumm") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "AcctgSumm")
    End If

     If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Entry Found", "No Data Found, check query", FALSE
    	dbCheckAcctgSumm = FALSE
    Else
    	dbCheckAcctgSumm = TRUE
    End If
End Function

'**************************************************************************************************************
''' <summary> 
''' Finds new Bank Code
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>02-Apr-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Function FindNewBankCode
	Dim arrRecordValues, i, sBankCode, sRows, sSQL, bFound

	bFound = FALSE
	'Start seaching from here
	sBankCode = GlobalDictionary("BankCode")
	
	'will search up to 20 times
	For i = 0 to 20
		sSQL = "SELECT * FROM PS_BANK_CD_TBL WHERE BANK_CD IN ('" &sBankCode&"')"

		WriteToReport micDone, "SQL Query for Bank Code", "Query used is: "&sSQL, FALSE

		If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
			FindNewBankCode = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "BankCode")
		ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
			FindNewBankCode = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "BankCode")
		Else
			 FindNewBankCode = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "BankCode")    
		End If
		
		'Checks to see if any results are in DataTable
		sRows = DataTable.GetSheet("BankCode").GetRowCount
		If  sRows <> 0 Then	
			'If Results increments BankCode and deletes Datasheet
			bFound = TRUE
			sBankCode = sBankCode + 1
			sBankCode = Pad(sBankCode, "5", "0")
			DataTable.DeleteSheet("BankCode")
		Else
			bFound = FALSE
			Exit For
		End If
	Next
		
	'Test stops and reports to check data if empty
	If bFound = TRUE Then
		WriteToReport micFail, "FindNewBankCode", "Unable to find an Bank Code that does not exist within 20 from start Bank Code of ["& GlobalDictionary("BankCode")&"].  Try a different starting point.", True
		ExitTest		
	End If
	
	'Passes out BankCode not found to be used later
	GlobalDictionary("BankCode") = sBankCode
End Function
'**************************************************************************************************************
''' <summary> 
''' Verifies Manual Cash Position Entry
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>09-Apr-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Function dbCheckCshPosEntry(SETID, BUSINESS_UNIT, POS_CATEGORY, VALUE_DT, REFERENCE, AMOUNT, CURRENCY_CD)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT * FROM PS_MANUAL_POSN_ENT WHERE SETID = '"&SETID&"' AND BUSINESS_UNIT = '"&BUSINESS_UNIT&"' AND POS_CATEGORY = '"&POS_CATEGORY&"' AND "_
	&   " VALUE_DT = '"&VALUE_DT&"' AND REFERENCE = '"&REFERENCE&"' AND AMOUNT LIKE '%"&AMOUNT&"%' AND CURRENCY_CD = '"&CURRENCY_CD&"'"

	WriteToReport micDone, "SQL Query for Cash Position Entry", "Query used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Cash Position")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Cash Position") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Cash Position")
    End If

     If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Entry Found", "No Data Found, check query", FALSE
    	dbCheckCshPosEntry = FALSE
    Else
    	dbCheckCshPosEntry = TRUE
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' Check Activity Types for Statement
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>09-Apr-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Function dbCheckActivities(BNK_ID_NBR, BANK_ACCOUNT_NUM, RECON_CYCLE_NBR)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT DISTINCT STMT_ACTIVITY_TYPE FROM PS_BANK_STMT_TBL WHERE BNK_ID_NBR = '"&BNK_ID_NBR&"' AND BANK_ACCOUNT_NUM = '"&BANK_ACCOUNT_NUM&"'  AND RECON_CYCLE_NBR = '"&RECON_CYCLE_NBR&"' AND RECON_STATUS = 'NTF'"

	WriteToReport micDone, "SQL Query for Statement Activity", "Query used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Statement Activity", "STMT_ACTIVITY_TYPE")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Statement Activity", "STMT_ACTIVITY_TYPE") 
    Else
        arrResult = dbGetAllRecords(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Statement Activity", "STMT_ACTIVITY_TYPE")
    End If

     If NOT IsArrayDimmed(arrResult) OR UBound(arrResult) = 0 Then 'Due to the way dbGetAllRecords works, there is always an empty row
     	WriteToReport micFail, "No Activities Found for Bank ID ["&BNK_ID_NBR&"] Account ["&BANK_ACCOUNT_NUM&"] and Statement ["&RECON_CYCLE_NBR&"]", "Check Data/Query", TRUE
    	ExitTest
    Else
    	dbCheckActivities = arrResult
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' Get Unnetted Deal
''' Amount must be greater than zero to obtain the Deal to Settle
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>11-Apr-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Function dbGetUnnettedDeal(INSTRUMENT_TYPE, BUSINESS_UNIT)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT TOP 1 * FROM PS_TRX_CASHFLOW_VW WHERE INSTRUMENT_TYPE = '"&INSTRUMENT_TYPE&"' AND BUSINESS_UNIT = '"&BUSINESS_UNIT&"' AND AMOUNT > 0 ORDER BY SETTLEMENT_DT DESC"

	WriteToReport micDone, "SQL Query for Unnetted Deal", "Query used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "UnnettedDeal")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "UnnettedDeal") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "UnnettedDeal")
    End If

     If NOT IsArrayDimmed(arrResult) Then
     	WriteToReport micFail, "No Unnetted Deals Found", "Check Data/Query", TRUE
    	ExitTest
    Else
    	dbGetUnnettedDeal = arrResult
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' Get Recently Netted Deal's Next Business Date
''' Amount must be less than zero to obtain the first Business Date associated to the first interest payment of the Deal that was Netted
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>11-Apr-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Function dbGetNettedDealBusinessDate(TREAS_HEADER_ID, BUSINESS_UNIT)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT TOP 1 * FROM PS_TRX_CASHFLOW_VW WHERE TREAS_HEADER_ID = '"&TREAS_HEADER_ID&"' AND BUSINESS_UNIT = '"&BUSINESS_UNIT&"' AND AMOUNT < 0 ORDER BY BUSINESS_DATE"

	WriteToReport micDone, "SQL Query for Netted Deal", "Query used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "DealsNextBusinessDate")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "DealsNextBusinessDate") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "DealsNextBusinessDate")
    End If

     If NOT IsArrayDimmed(arrResult) Then
     	WriteToReport micFail, "No Unnetted Deals Found", "Check Data/Query", TRUE
    	ExitTest
    Else
    	dbGetNettedDealBusinessDate = arrResult
    End If
End Function
'**************************************************************************************************************
''' <summary> 
''' Gets an unused Activity to use in creating a transaction and later an asset for either Unknown Project/Given Project. 
''' Project Must be Active
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>22-Apr-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetOpenProjAndActivity(PROJECT_ID)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT TOP 1 A.* FROM"_
		&" (PS_PROJ_ACTIVITY A LEFT OUTER JOIN PS_PC_AM_EXP1_VW B ON A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.PROJECT_ID = B.PROJECT_ID AND A.ACTIVITY_ID = B.ACTIVITY_ID),"_
		&" (PS_PROJ_ACTIVITY C LEFT OUTER JOIN PS_PROJECT_STATUS D ON C.BUSINESS_UNIT = D.BUSINESS_UNIT AND C.PROJECT_ID = D.PROJECT_ID ),"_
		&" (PS_PROJ_ACTIVITY G LEFT OUTER JOIN PS_PC_AM_RULE_PRJ H ON G.BUSINESS_UNIT = H.BUSINESS_UNIT AND G.PROJECT_ID = H.PROJECT_ID ),"_
		&" (PS_PROJECT_STATUS E INNER JOIN "_
			&" (SELECT PROJECT_ID, MAX(EFFSEQ) AS MED, MAX(EFFDT) AS MDT"_
			&" FROM PS_PROJECT_STATUS"_
			&" GROUP BY PROJECT_ID) F ON E.PROJECT_ID = F.PROJECT_ID AND E.EFFSEQ = MED AND E.EFFDT = MDT AND E.PROJECT_STATUS = 'A')"_
		&" WHERE A.END_DT > '"&SQLDateLeadingZeros&"' AND A.BUSINESS_UNIT = '"&GlobalDictionary("BusinessUnit")&"'"_
			&" AND A.ACTIVITY_ID IN ('BUILD_IMP','COMP_HARDWARE','EXT_LABOR','INT_LABOR', 'FURNITURE','LEASE_IMP','MACH_EQUIP','COMP_SOFTWARE') "_
			&" AND B.ACTIVITY_ID IS NULL"_
			&" AND A.PROJECT_ID = C.PROJECT_ID AND A.BUSINESS_UNIT = C.BUSINESS_UNIT"_
			&" AND A.PROJECT_ID = E.PROJECT_ID AND A.BUSINESS_UNIT = E.BUSINESS_UNIT"_
			&" AND A.PROJECT_ID = G.PROJECT_ID AND A.BUSINESS_UNIT = G.BUSINESS_UNIT"_
			&" AND D.PROJECT_STATUS = 'A'"
	'Values come from inspecting the radio buttons for their value on General Information Page under Project Costing, see function PCCreateProject
	If GlobalDictionary("AssetIntegrationRule") = "Many Assets From Each Activity" Then 
		sSQL = sSQL & " AND H.PC_AM_CAP_RULE = 5"
	Else
		sSQL = sSQL & " AND H.PC_AM_CAP_RULE = 2"
	End If

	If PROJECT_ID <> "" Then
		sSQL = sSQL & " AND A.PROJECT_ID = '"&PROJECT_ID&"'"
	End If
	sSQL = sSQL &" ORDER BY A.PROJECT_ID"

	WriteToReport micDone, "SQL query for Project With Activity", "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ProjectActivity")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ProjectActivity") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ProjectActivity")
    End If
    If NOT IsArrayDimmed(arrResult) Then
    	If PROJECT_ID <> "" Then
    		WriteToReport micFail, "No Open Activity for Project ID: "&PROJECT_ID, "No Data Found", FALSE
    	Else
			WriteToReport micFail, "No Projects with open Activities Found", "No Data Found", FALSE
    	End If
    	ExitTest
    Else
    	WriteToReport micDone, "Found Project With Open Activity", "", FALSE
    End If

    dbGetOpenProjAndActivity = arrResult
End Function
'**************************************************************************************************************
''' <summary> 
''' Obtain Parent ID (Asset) for the same Activity Given
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>22-Apr-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbGetParentAssetID(ACTIVITY_ID)
	Dim sSQL
	Dim arrRecordValues(), arrResult

	sSQL = "SELECT TOP 1 PARENT_ID FROM PS_AM_LOOKUP_VW WHERE ASSET_ID = PARENT_ID AND BUSINESS_UNIT_PC = '"&GlobalDictionary("BusinessUnit")&"' AND ACTIVITY_ID = '"&ACTIVITY_ID&"'"

	WriteToReport micDone, "SQL query for Parent Asset With Activity: "&ACTIVITY_ID, "Query Used is: "&sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "ProjectActivity")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "ProjectActivity") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "ProjectActivity")
    End If

    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Parent Assets for Given Activity: "&ACTIVITY_ID, "Check Activity", FALSE
    	ExitTest
    Else
    	WriteToReport micDone, "Found Parent Asset", "", FALSE
    End If

    dbGetParentAssetID = arrResult(0)
End Function

'**************************************************************************************************************
''' <summary> 
''' Takes the Displayed name and attempts to match it against both tables in order to get the OPRID
''' </summary>
''' <author>Zach Apple</author>
''' <datecreated>07-May-2019</datecreated>
''' <startstate>NA</startstate>
''' <endstate>process</endstate>
'Change Control: 
'Date of Change 	Author 		Description of change
'**************************************************************************************************************
Public Function dbFindOPRIDByDisplayedName(DISPLAYED)
	Dim sSQL, arrResult
	Dim arrRecordValues()

	sSQL = "SELECT OPRID FROM PSOPRDEFN WHERE EMPLID = (SELECT EMPLID FROM PS_PERSONAL_DATA WHERE CONCAT(FIRST_NAME, ' ', LAST_NAME) LIKE '%"&DISPLAYED&"%')"
	WriteToReport micDone, "SQL query for User with Displayed Name ["&DISPLAYED&"]", "Query used is " & sSQL, FALSE

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "OPRID")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "OPRID")    
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "OPRID")
    End If

    If NOT IsArrayDimmed(arrResult) Then
    	arrResult = dbFetchUserId(DISPLAYED)
    	If NOT IsArrayDimmed(arrResult) Then
    		WriteToReport micFail, "No User Found", "Check Data/Query", TRUE
    		ExitTest
    	End If
     	dbFindOPRIDByDisplayedName = arrResult(1) 'dbFetchUserId returns OPRDEFNDESC, OPRID
    Else
    	dbFindOPRIDByDisplayedName = arrResult(0)
    End If
End Function
Public Function dbGetItemWriteOffNegativeAmount
	Dim sSQL
	Dim arrRecordValues(), arrResult, arrReturn(3)

'	sSQL = "SELECT TOP 1 * FROM (PS_ITEM A LEFT OUTER JOIN PS_CUST_PND_MNT_VW B ON A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.ITEM = B.ITEM),"_
'	& " (PS_ITEM E LEFT OUTER JOIN PS_PAYMENT_ID_ITEM F ON E.BUSINESS_UNIT = F.DEPOSIT_BU AND E.ITEM = F.ITEM),"_
'	& " (PS_ITEM G LEFT OUTER JOIN PS_WS_ITEM H ON G.BUSINESS_UNIT = H.BUSINESS_UNIT AND G.ITEM = H.ITEM),"_
'	& " (PS_ITEM I LEFT OUTER JOIN PS_PAYMENT_ITEM J ON I.BUSINESS_UNIT = J.BUSINESS_UNIT AND I.ITEM = J.ITEM)"_
'	& " WHERE A.ITEM_STATUS = 'O' AND A.REF_REASON = '' AND A.ENTRY_TYPE = 'IN' AND A.BUSINESS_UNIT IN ('"&GlobalDictionary("BusinessUnit")&"')"_
'	& " AND A.ITEM <> '' AND A.CUST_ID <> '' AND A.BAL_AMT < 0"_
'	& " AND A.ITEM = E.ITEM AND A.ITEM = G.ITEM AND A.ITEM = I.ITEM"_
'	& " AND B.ITEM IS NULL AND F.ITEM IS NULL AND H.ITEM IS NULL AND J.ITEM IS NULL"

	sSQL = "SELECT TOP 5 * FROM (PS_ITEM A LEFT OUTER JOIN PS_CUST_PND_MNT_VW B ON A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.ITEM = B.ITEM) WHERE A.ITEM_STATUS = 'O' AND A.BAL_AMT < 0 AND A.REF_REASON = '' AND A.ENTRY_TYPE = 'IN' AND A.BUSINESS_UNIT IN ('00000', '00001', '00002', '00010', '00012', '00017') AND A.ITEM <> '' AND A.CUST_ID <> ''"
	WriteToReport micDone, "SQL query for Item in Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "Query Used is: "&sSQL, FALSE
	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNQA, arrRecordValues, "Item")
    ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then 
       	arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNTST, arrRecordValues, "Item") 
    Else
        arrResult = dbGetFirstRecord(sSQL, PSFCONNECTIONSTRFNREG, arrRecordValues, "Item")
    End If

    If NOT IsArrayDimmed(arrResult) Then
    	WriteToReport micFail, "No Customers Found for Business Unit ["&GlobalDictionary("BusinessUnit")&"]", "No Data Found", FALSE
    	ExitTest
    Else
    	WriteToReport micDone, "Retrieved an Item", "", FALSE
    End If

  	arrReturn(0) = arrResult(1) 'Customer
  	arrReturn(1) = Trim(arrResult(2)) 'Item ID
  	arrReturn(2) = arrResult(9) 'Balance Amount
	arrReturn(3) = arrResult(10) 'FromDate

  	dbGetItemWriteOffNegativeAmount = arrReturn
End Function

'**************************************************************************************************************
''' <summary> 
''' Get the WriteOff that we will be performing our testing on
''' </summary>
''' <author>Rama Eric Trout/author>
''' <datecreated>21-May-2019</datecreated>
''' <startstate>LaunchApplication called with username LISAPAP</startstate>
''' <endstate>Completed</endstate>
''' <returns type="NA"> True if found and clicked</returns>
'Change Control: 
'Date of Change 	Author 		Description of change

'*************************************************************************************************************
Public Function dbGetWOItemMulti(BU,GreaterThan,LessThan, Lines)
	Dim arrRecordValues()
	Dim sSQL
	
	'Get the Item to work on
	sSQL = "SELECT TOP " & Lines &" A.BUSINESS_UNIT, A.CUST_ID, A.ITEM, A.BAL_AMT FROM (PS_ITEM A LEFT OUTER JOIN PS_CUST_PND_MNT_VW B ON A.BUSINESS_UNIT = B.BUSINESS_UNIT AND A.ITEM = B.ITEM),"&_ 
			" (PS_ITEM E LEFT OUTER JOIN PS_PAYMENT_ID_ITEM F ON E.BUSINESS_UNIT = F.DEPOSIT_BU AND E.ITEM = F.ITEM),"&_ 
			" (PS_ITEM G LEFT OUTER JOIN PS_WS_ITEM H ON G.BUSINESS_UNIT = H.BUSINESS_UNIT AND G.ITEM = H.ITEM),"&_ 
			" (PS_ITEM I LEFT OUTER JOIN PS_PAYMENT_ITEM J ON I.BUSINESS_UNIT = J.BUSINESS_UNIT AND I.ITEM = J.ITEM)"&_ 
			" WHERE A.ITEM_STATUS = 'O' AND A.REF_REASON = '' AND A.ENTRY_TYPE = 'IN' AND A.BUSINESS_UNIT IN ('"&GlobalDictionary("BusinessUnit")&"')"&_ 
			"AND A.BAL_AMT > "&GreaterThan&" AND A.BAL_AMT < "&LessThan&" " &_
			" AND B.ITEM IS NULL AND F.ITEM IS NULL AND H.ITEM IS NULL AND J.ITEM IS NULL"&_ 
			" AND A.ITEM = E.ITEM AND A.ITEM = G.ITEM AND A.ITEM = I.ITEM ORDER BY A.POST_DT"
	WriteToReport micDone, "SQL query", "Query used for dbgetWOItem is " & sSQL, False
	
	'dbgetWOItemMulti= dbGetFirstRecord(sSQL, "", arrRecordValues, "GetWOItemMulti")

	If StrComp (GlobalDictionary("Environment"), "FNQA") = 0 Then
	    dbgetWOItemMulti= dbGetRecords(sSQL,PSFCONNECTIONSTRFNQA, arrRecordValues,"GetWOItemMulti")
	ElseIf strComp (GlobalDictionary("Environment"), "FNTST") = 0 Then    
	    dbgetWOItemMulti= dbGetRecords(sSQL,PSFCONNECTIONSTRFNTST, arrRecordValues,"GetWOItemMulti" )
	ElseIf strComp (GlobalDictionary("Environment"), "FNRVTST") = 0 Then    
	    dbgetWOItemMulti= dbGetRecords(sSQL, PSFCONNECTIONSTRFNRVTST, arrRecordValues,"GetWOItemMulti" )
	Else
	    dbgetWOItemMulti= dbGetRecords(sSQL,PSFCONNECTIONSTRFNREG, arrRecordValues,"GetWOItemMulti")
	End If

 	On Error GoTo 0
End Function
